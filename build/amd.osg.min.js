define(["osg"], function () {
function getStackTrace(t){var e=[];try{throw 1==arguments.length?t:Error()}catch(t){t.stack&&(e=(t.stack+"\n").replace(/^\S[^\(]+?[\n$]/gm,"").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}()@$1$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}()@$1").split("\n"),e.shift())}for(var r=0;e.length>r;++r)""===e[r]&&(e.splice(r,1),--r);return e}var osg=osg||{},osgUtil=osgUtil||{},osgGA=osgGA||{},osgDB=osgDB||{},osgViewer=osgViewer||{},osgAnimation=osgAnimation||{};osg.version="0.8.0",osg.copyright="Cedric Pinson - cedric.pinson@plopbyte.com",osg.log=function(t){void 0!==window.console&&window.console.log(t,getStackTrace())},osg.info=function(t){void 0!==window.console&&window.console.info(t,getStackTrace())},osg.warn=function(t){void 0!==window.console&&window.console.warn(t,getStackTrace())},osg.error=function(t){void 0!==window.console&&window.console.error(t,getStackTrace())},osg.debug=function(t){void 0!==window.console&&window.console.debug(t,getStackTrace())},osg.DEBUG=0,osg.INFO=1,osg.NOTICE=2,osg.WARN=3,osg.ERROR=4,osg.setNotifyLevel=function(t){var e=function(t){void 0!==window.console&&window.console.log(t,getStackTrace())},r=function(t){void 0!==window.console&&window.console.info(t,getStackTrace())},i=function(t){void 0!==window.console&&window.console.warn(t,getStackTrace())},o=function(t){void 0!==window.console&&window.console.error(t,getStackTrace())},n=function(t){void 0!==window.console&&window.console.debug(t,getStackTrace())},a=function(){};osg.debug=a,osg.info=a,osg.log=a,osg.warn=a,osg.error=a,osg.DEBUG>=t&&(osg.debug=n),osg.INFO>=t&&(osg.info=r),osg.NOTICE>=t&&(osg.log=e),osg.WARN>=t&&(osg.warn=i),osg.ERROR>=t&&(osg.error=o)},osg.setNotifyLevel(osg.NOTICE),osg.memoryPools={},osgUtil.ressourcesCache={},osgUtil.ressourcesCache.pixels=[],osgUtil.ressourcesCache.programs=[],osgUtil.ressourcesCache.textures=[],osgUtil.ressourcesCache.geometries=[],osgUtil.ressourcesCache.vertexshaders=[],osgUtil.ressourcesCache.frameBufferObjectTarget=[],osg.init=function(){osg.memoryPools.stateGraph=new osg.ObjectMemoryPool(osg.StateGraph).grow(50)},osg.isArray=function(t){return"[object Array]"===toString.call(t)},osg.extend=function(){var t,e,r,i,o=Object.prototype.toString,n=Object.prototype.hasOwnProperty,a=function(t){return"[object Function]"===o.call(t)},s=osg.isArray,u=function(t){if(!t||"[object Object]"!==o.call(t)||t.nodeType||t.setInterval)return!1;if(t.constructor&&!n.call(t,"constructor")&&!n.call(t.constructor.prototype,"isPrototypeOf"))return!1;var e;for(e in t);return void 0===e||n.call(t,e)},h=arguments[0]||{},c=1,g=arguments.length,l=!1;for("boolean"==typeof h&&(l=h,h=arguments[1]||{},c=2),"object"==typeof h||a(h)||(h={}),g===c&&(h=this,--c);g>c;c++)if(null!==(t=arguments[c]))for(e in t)if(r=h[e],i=t[e],h!==i)if(l&&i&&(u(i)||s(i))){var d=r&&(u(r)||s(r))?r:s(i)?[]:{};h[e]=osg.extend(l,d,i)}else void 0!==i&&(h[e]=i);return h},osg.objectInehrit=osg.objectInherit=function(t,e){function r(){}r.prototype=t;var i=new r;return e&&osg.objectMix(i,e,!1),i},osg.objectMix=function(t,e,r){for(var i in e)r&&t[i]||(t[i]=e[i]);return t},osg.objectLibraryClass=function(t,e,r){t.className=function(){return r},t.libraryName=function(){return e};var i=e+"::"+r;return t.libraryClassName=function(){return i},t},osg.objectType={},osg.objectType.type=0,osg.objectType.generate=function(t){var e=osg.objectType.type;return osg.objectType[e]=t,osg.objectType[t]=e,osg.objectType.type+=1,e},osg.Float32Array=Float32Array,osg.Int32Array=Int32Array,osg.Uint16Array=Uint16Array,osg.Vec2={copy:function(t,e){return e[0]=t[0],e[1]=t[1],e},valid:function(t){return isNaN(t[0])?!1:isNaN(t[1])?!1:!0},mult:function(t,e,r){return r[0]=t[0]*e,r[1]=t[1]*e,r},length2:function(t){return t[0]*t[0]+t[1]*t[1]},length:function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},distance:function(t,e){var r=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(r*r+i*i)},normalize:function(t,e){var r=this.length2(t);if(r>0){var i=1/Math.sqrt(r);e[0]=t[0]*i,e[1]=t[1]*i}else e[0]=t[0],e[1]=t[1];return e},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},sub:function(t,e,r){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r},add:function(t,e,r){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r},neg:function(t,e){return e[0]=-t[0],e[1]=-t[1],e},lerp:function(t,e,r,i){var o=1-t;return i[0]=e[0]*o+t*r[0],i[1]=e[1]*o+t*r[1],i}},osg.Vec3={init:function(t){return t[0]=0,t[1]=0,t[2]=0,t},copy:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},cross:function(t,e,r){var i=t[1]*e[2]-t[2]*e[1],o=t[2]*e[0]-t[0]*e[2],n=t[0]*e[1]-t[1]*e[0];return r[0]=i,r[1]=o,r[2]=n,r},valid:function(t){return isNaN(t[0])?!1:isNaN(t[1])?!1:isNaN(t[2])?!1:!0},mult:function(t,e,r){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r},length2:function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},length:function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},distance:function(t,e){var r=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return Math.sqrt(r*r+i*i+o*o)},normalize:function(t,e){var r=this.length2(t);if(r>0){var i=1/Math.sqrt(r);e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}else e[0]=t[0],e[1]=t[1],e[2]=t[2];return e},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},sub:function(t,e,r){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r},add:function(t,e,r){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r},neg:function(t,e){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},lerp:function(t,e,r,i){return i[0]=e[0]+(r[0]-e[0])*t,i[1]=e[1]+(r[1]-e[1])*t,i[2]=e[2]+(r[2]-e[2])*t,i}},osg.Vec4={dot:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},copy:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},sub:function(t,e,r){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r[3]=t[3]-e[3],r},mult:function(t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r[3]=t[3]*e,r},add:function(t,e,r){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r[3]=t[3]+e[3],r},neg:function(t,e){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},lerp:function(t,e,r,i){var o=1-t;return i[0]=e[0]*o+t*r[0],i[1]=e[1]*o+t*r[1],i[2]=e[2]*o+t*r[2],i[3]=e[3]*o+t*r[3],i}},osg.Object=function(){this._name=void 0,this._userdata=void 0},osg.Object.prototype=osg.objectLibraryClass({setName:function(t){this._name=t},getName:function(){return this._name},setUserData:function(t){this._userdata=t},getUserData:function(){return this._userdata},toString:function(){return JSON.stringify(this.toObject())},toJSON:function(){return JSON.stringify(this.toObject())},toObject:function(){var t={_name:this._name,_userdata:this._userdata};return t}},"osg","Object"),osg.Matrix={_tmp0:[],_tmp1:[],valid:function(t){for(var e=0;16>e;e++)if(isNaN(t[e]))return!1;return!0},setRow:function(t,e,r,i,o,n){var a=4*e;t[a+0]=r,t[a+1]=i,t[a+2]=o,t[a+3]=n},innerProduct:function(t,e,r,i){var o=4*r;return t[o+0]*e[0+i]+t[o+1]*e[4+i]+t[o+2]*e[8+i]+t[o+3]*e[12+i]},set:function(t,e,r,i){return t[4*e+r]=i,i},get:function(t,e,r){return t[4*e+r]},makeIdentity:function(t){return void 0===t&&(t=[],osg.log("osg.Matrix.makeIdentity without matrix destination is deprecated")),osg.Matrix.setRow(t,0,1,0,0,0),osg.Matrix.setRow(t,1,0,1,0,0),osg.Matrix.setRow(t,2,0,0,1,0),osg.Matrix.setRow(t,3,0,0,0,1),t},makeTranslate:function(t,e,r,i){return void 0===i&&(i=[]),osg.Matrix.setRow(i,0,1,0,0,0),osg.Matrix.setRow(i,1,0,1,0,0),osg.Matrix.setRow(i,2,0,0,1,0),osg.Matrix.setRow(i,3,t,e,r,1),i},setTrans:function(t,e,r,i){return t[12]=e,t[13]=r,t[14]=i,t},getTrans:function(t,e){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},preMult:function(t,e){var r,i,o,n;return r=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],i=e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],o=e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],n=e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],t[0]=r,t[4]=i,t[8]=o,t[12]=n,r=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],i=e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],o=e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],n=e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],t[1]=r,t[5]=i,t[9]=o,t[13]=n,r=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],i=e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],o=e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],n=e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],t[2]=r,t[6]=i,t[10]=o,t[14]=n,r=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],i=e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],o=e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],n=e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15],t[3]=r,t[7]=i,t[11]=o,t[15]=n,t},postMult:function(t,e){return btmp0=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],btmp1=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],btmp2=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],btmp3=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[0]=btmp0,e[1]=btmp1,e[2]=btmp2,e[3]=btmp3,btmp0=e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],btmp1=e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],btmp2=e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],btmp3=e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[4]=btmp0,e[5]=btmp1,e[6]=btmp2,e[7]=btmp3,btmp0=e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],btmp1=e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],btmp2=e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],btmp3=e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[8]=btmp0,e[9]=btmp1,e[10]=btmp2,e[11]=btmp3,btmp0=e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],btmp1=e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],btmp2=e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],btmp3=e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15],e[12]=btmp0,e[13]=btmp1,e[14]=btmp2,e[15]=btmp3,e},multa:function(t,e,r){return r===t?this.preMult(t,e):r===e?this.postMult(t,e):(void 0===r&&(r=[]),r[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],r[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],r[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],r[3]=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],r[4]=e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],r[5]=e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],r[6]=e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],r[7]=e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],r[8]=e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],r[9]=e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],r[10]=e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],r[11]=e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],r[12]=e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],r[13]=e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],r[14]=e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],r[15]=e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15],r)},mult:function(t,e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],u=e[5],h=e[6],c=e[7],g=e[8],l=e[9],d=e[10],f=e[11],p=e[12],m=e[13],v=e[14],_=e[15],S=t[0],y=t[1],b=t[2],T=t[3],M=t[4],x=t[5],C=t[6],A=t[7],w=t[8],E=t[9],F=t[10],V=t[11],R=t[12],U=t[13],P=t[14],N=t[15];return r[0]=i*S+o*M+n*w+a*R,r[1]=i*y+o*x+n*E+a*U,r[2]=i*b+o*C+n*F+a*P,r[3]=i*T+o*A+n*V+a*N,r[4]=s*S+u*M+h*w+c*R,r[5]=s*y+u*x+h*E+c*U,r[6]=s*b+u*C+h*F+c*P,r[7]=s*T+u*A+h*V+c*N,r[8]=g*S+l*M+d*w+f*R,r[9]=g*y+l*x+d*E+f*U,r[10]=g*b+l*C+d*F+f*P,r[11]=g*T+l*A+d*V+f*N,r[12]=p*S+m*M+v*w+_*R,r[13]=p*y+m*x+v*E+_*U,r[14]=p*b+m*C+v*F+_*P,r[15]=p*T+m*A+v*V+_*N,r},multOrig:function(t,e,r){var i;if(r===t){i=[];for(var o=0;4>o;o++)i[0]=osg.Matrix.innerProduct(e,t,0,o),i[1]=osg.Matrix.innerProduct(e,t,1,o),i[2]=osg.Matrix.innerProduct(e,t,2,o),i[3]=osg.Matrix.innerProduct(e,t,3,o),t[0+o]=i[0],t[4+o]=i[1],t[8+o]=i[2],t[12+o]=i[3];return t}if(r===e){i=[];for(var n=0;4>n;n++)i[0]=osg.Matrix.innerProduct(e,t,n,0),i[1]=osg.Matrix.innerProduct(e,t,n,1),i[2]=osg.Matrix.innerProduct(e,t,n,2),i[3]=osg.Matrix.innerProduct(e,t,n,3),this.setRow(e,n,i[0],i[1],i[2],i[3]);return e}void 0===r&&(r=[]);var a=e[0],s=e[1],u=e[2],h=e[3],c=e[4],g=e[5],l=e[6],d=e[7],f=e[8],p=e[9],m=e[10],v=e[11],_=e[12],S=e[13],y=e[14],b=e[15],T=t[0],M=t[1],x=t[2],C=t[3],A=t[4],w=t[5],E=t[6],F=t[7],V=t[8],R=t[9],U=t[10],P=t[11],N=t[12],D=t[13],L=t[14],B=t[15];return r[0]=a*T+s*A+u*V+h*N,r[1]=a*M+s*w+u*R+h*D,r[2]=a*x+s*E+u*U+h*L,r[3]=a*C+s*F+u*P+h*B,r[4]=c*T+g*A+l*V+d*N,r[5]=c*M+g*w+l*R+d*D,r[6]=c*x+g*E+l*U+d*L,r[7]=c*C+g*F+l*P+d*B,r[8]=f*T+p*A+m*V+v*N,r[9]=f*M+p*w+m*R+v*D,r[10]=f*x+p*E+m*U+v*L,r[11]=f*C+p*F+m*P+v*B,r[12]=_*T+S*A+y*V+b*N,r[13]=_*M+S*w+y*R+b*D,r[14]=_*x+S*E+y*U+b*L,r[15]=_*C+S*F+y*P+b*B,r},makeLookAt:function(t,e,r,i){void 0===i&&(i=[]);var o=osg.Vec3.sub(e,t,[]);osg.Vec3.normalize(o,o);var n=osg.Vec3.cross(o,r,[]);osg.Vec3.normalize(n,n);var a=osg.Vec3.cross(n,o,[]);return osg.Vec3.normalize(a,a),i[0]=n[0],i[1]=a[0],i[2]=-o[0],i[3]=0,i[4]=n[1],i[5]=a[1],i[6]=-o[1],i[7]=0,i[8]=n[2],i[9]=a[2],i[10]=-o[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,osg.Matrix.multTranslate(i,osg.Vec3.neg(t,[]),i),i},makeOrtho:function(t,e,r,i,o,n,a){void 0===a&&(a=[]);var s=-(e+t)/(e-t),u=-(i+r)/(i-r),h=-(n+o)/(n-o),c=osg.Matrix.setRow;return c(a,0,2/(e-t),0,0,0),c(a,1,0,2/(i-r),0,0),c(a,2,0,0,-2/(n-o),0),c(a,3,s,u,h,1),a},getLookAt:function(t,e,r,i,o){void 0===o&&(o=1);var n=[],a=osg.Matrix.inverse(t,n);a||osg.Matrix.makeIdentity(n),osg.Matrix.transformVec3(n,[0,0,0],e),osg.Matrix.transform3x3(t,[0,1,0],i),osg.Matrix.transform3x3(t,[0,0,-1],r),osg.Vec3.normalize(r,r),osg.Vec3.add(osg.Vec3.mult(r,o,[]),e,r)},getRotate:function(t,e){void 0===e&&(e=[]);var r,i,o,n=[],a=t[0],s=t[5],u=t[10];for(n[0]=1+a+s+u,n[1]=1+a-s-u,n[2]=1-a+s-u,n[3]=1-a-s+u,o=0,i=1;4>i;i++)o=n[i]>n[o]?i:o;return 0===o?(e[3]=n[0],e[0]=t[6]-t[9],e[1]=t[8]-t[2],e[2]=t[1]-t[4]):1==o?(e[3]=t[6]-t[9],e[0]=n[1],e[1]=t[1]+t[4],e[2]=t[8]+t[2]):2==o?(e[3]=t[8]-t[2],e[0]=t[1]+t[4],e[1]=n[2],e[2]=t[6]+t[9]):(e[3]=t[1]-t[4],e[0]=t[8]+t[2],e[1]=t[6]+t[9],e[2]=n[3]),r=Math.sqrt(.25/n[o]),e[3]*=r,e[0]*=r,e[1]*=r,e[2]*=r,e},preMultTranslate:function(t,e){return 0!==e[0]&&(val=e[0],t[12]+=val*t[0],t[13]+=val*t[1],t[14]+=val*t[2],t[15]+=val*t[3]),0!==e[1]&&(val=e[1],t[12]+=val*t[4],t[13]+=val*t[5],t[14]+=val*t[6],t[15]+=val*t[7]),0!==e[2]&&(val=e[2],t[12]+=val*t[8],t[13]+=val*t[9],t[14]+=val*t[10],t[15]+=val*t[11]),t},multTranslate:function(t,e,r){void 0===r&&(r=[]),r!==t&&osg.Matrix.copy(t,r);var i;return 0!==e[0]&&(i=e[0],r[12]+=i*t[0],r[13]+=i*t[1],r[14]+=i*t[2],r[15]+=i*t[3]),0!==e[1]&&(i=e[1],r[12]+=i*t[4],r[13]+=i*t[5],r[14]+=i*t[6],r[15]+=i*t[7]),0!==e[2]&&(i=e[2],r[12]+=i*t[8],r[13]+=i*t[9],r[14]+=i*t[10],r[15]+=i*t[11]),r},makeRotate:function(t,e,r,i,o){void 0===o&&(osg.log("osg.makeRotate without given matrix destination is deprecated"),o=[]);var n=Math.sqrt(e*e+r*r+i*i),a=Math.sin(t),s=Math.cos(t);if(n>0){var u,h,c,g,l,d,f,p,m,v;return n=1/n,e*=n,r*=n,i*=n,u=e*e,h=r*r,c=i*i,g=e*r,l=r*i,d=i*e,f=e*a,p=r*a,m=i*a,v=1-s,o[0]=v*u+s,o[1]=v*g-m,o[2]=v*d+p,o[3]=0,o[4]=v*g+m,o[5]=v*h+s,o[6]=v*l-f,o[7]=0,o[8]=v*d-p,o[9]=v*l+f,o[10]=v*c+s,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}return osg.Matrix.makeIdentity(o)},transform3x3:function(t,e,r){return void 0===r&&(r=[]),r[0]=t[0]*e[0]+t[1]*e[1]+t[2]*e[2],r[1]=t[4]*e[0]+t[5]*e[1]+t[6]*e[2],r[2]=t[8]*e[0]+t[9]*e[1]+t[10]*e[2],r},transformVec3:function(t,e,r){var i=1/(t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]);void 0===r&&(osg.warn("deprecated, osg.Matrix.transformVec3 needs a third parameter as result"),r=[]);var o;return o=r===e?[]:r,o[0]=(t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12])*i,o[1]=(t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13])*i,o[2]=(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14])*i,r===e&&osg.Vec3.copy(o,r),r},transformVec4:function(t,e,r){void 0===r&&(r=[]);var i;return i=r===e?[]:r,i[0]=t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],i[1]=t[4]*e[0]+t[5]*e[1]+t[6]*e[2]+t[7]*e[3],i[2]=t[8]*e[0]+t[9]*e[1]+t[10]*e[2]+t[11]*e[3],i[3]=t[12]*e[0]+t[13]*e[1]+t[14]*e[2]+t[15]*e[3],r===e&&osg.Vec4.copy(i,r),r},copy:function(t,e){return void 0===e&&(e=[]),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},inverse:function(t,e){return e===t&&(osg.Matrix.copy(t,osg.Matrix._tmp1),t=osg.Matrix._tmp1),0===t[3]&&0===t[7]&&0===t[11]&&1===t[15]?this.inverse4x3(t,e):this.inverse4x4(t,e)},inverse4x4:function(t,e){var r=t[10]*t[15],i=t[14]*t[11],o=t[6]*t[15],n=t[14]*t[7],a=t[6]*t[11],s=t[10]*t[7],u=t[2]*t[15],h=t[14]*t[3],c=t[2]*t[11],g=t[10]*t[3],l=t[2]*t[7],d=t[6]*t[3],f=t[8]*t[13],p=t[12]*t[9],m=t[4]*t[13],v=t[12]*t[5],_=t[4]*t[9],S=t[8]*t[5],y=t[0]*t[13],b=t[12]*t[1],T=t[0]*t[9],M=t[8]*t[1],x=t[0]*t[5],C=t[4]*t[1],A=r*t[5]+n*t[9]+a*t[13]-(i*t[5]+o*t[9]+s*t[13]),w=i*t[1]+u*t[9]+g*t[13]-(r*t[1]+h*t[9]+c*t[13]),E=o*t[1]+h*t[5]+l*t[13]-(n*t[1]+u*t[5]+d*t[13]),F=s*t[1]+c*t[5]+d*t[9]-(a*t[1]+g*t[5]+l*t[9]),V=t[0]*A+t[4]*w+t[8]*E+t[12]*F;if(1e-5>Math.abs(V))return osg.log("Warning can't inverse matrix "+t),!1;var R=1/V,U=R*A,P=R*w,N=R*E,D=R*F,L=R*(i*t[4]+o*t[8]+s*t[12]-(r*t[4]+n*t[8]+a*t[12])),B=R*(r*t[0]+h*t[8]+c*t[12]-(i*t[0]+u*t[8]+g*t[12])),O=R*(n*t[0]+u*t[4]+d*t[12]-(o*t[0]+h*t[4]+l*t[12])),k=R*(a*t[0]+g*t[4]+l*t[8]-(s*t[0]+c*t[4]+d*t[8])),I=R*(f*t[7]+v*t[11]+_*t[15]-(p*t[7]+m*t[11]+S*t[15])),j=R*(p*t[3]+y*t[11]+M*t[15]-(f*t[3]+b*t[11]+T*t[15])),q=R*(m*t[3]+b*t[7]+x*t[15]-(v*t[3]+y*t[7]+C*t[15])),G=R*(S*t[3]+T*t[7]+C*t[11]-(_*t[3]+M*t[7]+x*t[11])),z=R*(m*t[10]+S*t[14]+p*t[6]-(_*t[14]+f*t[6]+v*t[10])),H=R*(T*t[14]+f*t[2]+b*t[10]-(y*t[10]+M*t[14]+p*t[2])),W=R*(y*t[6]+C*t[14]+v*t[2]-(x*t[14]+m*t[2]+b*t[6])),K=R*(x*t[10]+_*t[2]+M*t[6]-(T*t[6]+C*t[10]+S*t[2]));return e[0]=U,e[1]=P,e[2]=N,e[3]=D,e[4]=L,e[5]=B,e[6]=O,e[7]=k,e[8]=I,e[9]=j,e[10]=q,e[11]=G,e[12]=z,e[13]=H,e[14]=W,e[15]=K,!0},inverse4x3:function(t,e){var r=t[0],i=t[1],o=t[2],n=t[4],a=t[5],s=t[6],u=t[8],h=t[9],c=t[10];e[0]=a*c-s*h,e[1]=o*h-i*c,e[2]=i*s-o*a;var g=1/(r*e[0]+n*e[1]+u*e[2]);r*=g,n*=g,u*=g,e[0]*=g,e[1]*=g,e[2]*=g,e[3]=0,e[4]=s*u-n*c,e[5]=r*c-o*u,e[6]=o*n-r*s,e[7]=0,e[8]=n*h-a*u,e[9]=i*u-r*h,e[10]=r*a-i*n,e[11]=0,e[15]=1;var l,d,f,p=t[15],m=p-1;if(m*m>1e-6){var v=osg.Matrix._tmp0;e[12]=e[13]=e[14]=0;var _=t[3],S=t[7],y=t[11],b=e[0]*_+e[1]*S+e[2]*y,T=e[4]*_+e[5]*S+e[6]*y,M=e[8]*_+e[9]*S+e[10]*y;l=t[12],d=t[13],f=t[14];var x=1/(p-(l*b+d*T+f*M));l*=x,d*=x,f*=x,v[0]=l*b+1,v[1]=d*b,v[2]=f*b,v[3]=-b*x,v[4]=l*T,v[5]=d*T+1,v[6]=f*T,v[7]=-T*x,v[8]=l*M,v[9]=d*M,v[10]=f*M+1,v[11]=-M*x,v[12]=-l,v[13]=-d,v[14]=-f,v[15]=x,osg.Matrix.preMult(e,v)}else l=t[12],d=t[13],f=t[14],e[12]=-(l*e[0]+d*e[4]+f*e[8]),e[13]=-(l*e[1]+d*e[5]+f*e[9]),e[14]=-(l*e[2]+d*e[6]+f*e[10]);return!0},transpose:function(t,e){if(t===e){var r=t[1],i=t[2],o=t[3],n=t[6],a=t[7],s=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=r,t[6]=t[9],t[7]=t[13],t[8]=i,t[9]=n,t[11]=t[14],t[12]=o,t[13]=a,t[14]=s,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},makePerspective:function(t,e,r,i,o){void 0===o&&(o=[]);var n=r*Math.tan(t*Math.PI/360),a=-n,s=a*e,u=n*e;return osg.Matrix.makeFrustum(s,u,a,n,r,i,o)},getFrustum:function(t,e){var r=0,i=0,o=0,n=0;if(0!==t[3]||0!==t[7]||-1!==t[11]||0!==t[15])return!1;var a=t[14]/(t[10]-1),s=t[14]/(1+t[10]);return i=a*(t[8]-1)/t[0],r=a*(1+t[8])/t[0],o=a*(1+t[9])/t[5],n=a*(t[9]-1)/t[5],zNear=a,zFar=s,e.left=i,e.right=r,e.top=o,e.bottom=n,e.zNear=zNear,e.zFar=zFar,!0},getPerspective:function(t,e){var r={right:0,left:0,top:0,bottom:0,zNear:0,zFar:0},i=this.getFrustum(t,r);return i&&(e.fovy=180/Math.PI*(Math.atan(r.top/r.zNear)-Math.atan(r.bottom/r.zNear)),e.aspectRatio=(r.right-r.left)/(r.top-r.bottom)),e.zNear=r.zNear,e.zFar=r.zFar,e},makeScale:function(t,e,r,i){return void 0===i&&(i=[]),this.setRow(i,0,t,0,0,0),this.setRow(i,1,0,e,0,0),this.setRow(i,2,0,0,r,0),this.setRow(i,3,0,0,0,1),i},computeFrustrumCornersVectors:function(t,e){t[14]/(t[10]-1),t[14]/(t[10]+1);var r=1/t[0],i=1/t[5];return e[0]=[-r,i,1],e[1]=[-r,-i,1],e[2]=[r,-i,1],e[3]=[r,i,1],e},makeFrustum:function(t,e,r,i,o,n,a){void 0===a&&(a=[]);var s=2*o/(e-t),u=2*o/(i-r),h=(e+t)/(e-t),c=(i+r)/(i-r),g=-(n+o)/(n-o),l=-2*n*o/(n-o);return this.setRow(a,0,s,0,0,0),this.setRow(a,1,0,u,0,0),this.setRow(a,2,h,c,g,-1),this.setRow(a,3,0,0,l,0),a},makeRotateFromQuat:function(t,e){return this.makeIdentity(e),this.setRotateFromQuat(e,t)},setRotateFromQuat:function(t,e){var r=osg.Quat.length2(e);if(Math.abs(r)<=Number.MIN_VALUE)t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[8]=0,t[9]=0,t[10]=0;else{var i;i=1!==r?2/r:2;var o,n,a,s,u,h,c,g,l,d,f,p;d=i*e[0],f=i*e[1],p=i*e[2],s=e[0]*d,c=e[0]*f,g=e[0]*p,u=e[1]*f,h=e[1]*p,l=e[2]*p,o=e[3]*d,n=e[3]*f,a=e[3]*p,t[0]=1-(u+l),t[4]=c-a,t[8]=g+n,t[1]=c+a,t[5]=1-(s+l),t[9]=h-o,t[2]=g-n,t[6]=h+o,t[10]=1-(s+u)}return t}},osg.ShaderGeneratorType={VertexInit:0,VertexFunction:1,VertexMain:2,VertexEnd:3,FragmentInit:5,FragmentFunction:6,FragmentMain:7,FragmentEnd:8},osg.Shader=function(t,e){var r=t;"string"==typeof t&&(r=osg.Shader[t]),this.type=r,this.setText(e)},osg.Shader.VERTEX_SHADER=35633,osg.Shader.FRAGMENT_SHADER=35632,osg.Shader.prototype={setText:function(t){this.text=t},getText:function(){return this.text},compile:function(){if(this.shader=gl.createShader(this.type),gl.shaderSource(this.shader,this.text),gl.compileShader(this.shader),!gl.getShaderParameter(this.shader,gl.COMPILE_STATUS)&&!gl.isContextLost()){osg.log("can't compile shader:\n"+this.text+"\n");for(var t="\n"+this.text,e=t.split("\n"),r="\n",i=0,o=e.length;o>i;++i)r+=i+" "+e[i]+"\n";osg.log(r),osg.log(gl.getShaderInfoLog(this.shader))}}},osg.Shader.create=function(t,e){return osg.log("osg.Shader.create is deprecated, use new osg.Shader with the same arguments instead"),new osg.Shader(t,e)},osg.StateAttribute=function(){osg.Object.call(this),this._dirty=!0},osg.StateAttribute.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.Object.prototype,{isDirty:function(){return this._dirty},dirty:function(){this._dirty=!0},setDirty:function(t){this._dirty=t}}),"osg","StateAttribute"),osg.StateAttribute.OFF=0,osg.StateAttribute.ON=1,osg.StateAttribute.OVERRIDE=2,osg.StateAttribute.PROTECTED=4,osg.StateAttribute.INHERIT=8,osg.Uniform=function(){this.transpose=!1,this._dirty=!0,this.name="",this.type=void 0},osg.Uniform.isUniform=function(t){return t instanceof osg.Uniform?!0:!1},osg.Uniform.prototype={getName:function(){return this.name},getType:function(){return this.type},get:function(){return this.data},set:function(t){this.data=t,this.dirty()},dirty:function(){this._dirty=!0},apply:function(t){this._dirty&&(this.update.call(this.glData,this.data),this._dirty=!1),this.glCall(t,this.glData)},applyMatrix:function(t){this._dirty&&(this.update.call(this.glData,this.data),this._dirty=!1),this.glCall(t,this.transpose,this.glData)},update:function(t){for(var e=0,r=t.length;r>e;++e)this[e]=t[e]},_updateArray:function(t){for(var e=0,r=t.length;r>e;++e)this[e]=t[e]},_updateFloat1:function(t){this[0]=t[0]},_updateFloat2:function(t){this[0]=t[0],this[1]=t[1]},_updateFloat3:function(t){this[0]=t[0],this[1]=t[1],this[2]=t[2]},_updateFloat4:function(t){this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3]},_updateFloat9:function(t){this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8]},_updateFloat16:function(t){this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15]}},osg.Uniform.createFloat1=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[0]);var o=new osg.Uniform;return o.data=[r],o.glCall=function(t,e){gl.uniform1fv(t,e)},o.glData=new osg.Float32Array(o.data),o.update=osg.Uniform.prototype._updateFloat1,o.set=function(t){"number"==typeof t?this.data[0]=t:this.data=t,this.dirty()},o.name=i,o.type="float",o},osg.Uniform.createFloat=osg.Uniform.createFloat1,osg.Uniform.float=osg.Uniform.createFloat1,osg.Uniform.createFloatArray=function(t,e){var r=osg.Uniform.createFloat.call(this,t,e);return r.update=osg.Uniform.prototype._updateArray,r},osg.Uniform.createFloat2=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[0,0]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e){gl.uniform2fv(t,e)},o.glData=new osg.Float32Array(o.data),o.update=osg.Uniform.prototype._updateFloat2,o.name=i,o.type="vec2",o},osg.Uniform.vec2=osg.Uniform.createFloat2,osg.Uniform.createFloat2Array=function(t,e){var r=osg.Uniform.createFloat2.call(this,t,e);return r.update=osg.Uniform.prototype._updateArray,r},osg.Uniform.createFloat3=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[0,0,0]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e){gl.uniform3fv(t,e)},o.glData=new osg.Float32Array(o.data),o.update=osg.Uniform.prototype._updateFloat3,o.name=i,o.type="vec3",o},osg.Uniform.vec3=osg.Uniform.createFloat3,osg.Uniform.createFloat3Array=function(t,e){var r=osg.Uniform.createFloat3.call(this,t,e);return r.update=osg.Uniform.prototype._updateArray,r},osg.Uniform.createFloat4=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[0,0,0,0]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e){gl.uniform4fv(t,e)},o.glData=new osg.Float32Array(o.data),o.update=osg.Uniform.prototype._updateFloat4,o.name=i,o.type="vec4",o},osg.Uniform.vec4=osg.Uniform.createFloat4,osg.Uniform.createFloat4Array=function(t,e){var r=osg.Uniform.createFloat4.call(this,t,e);return r.update=osg.Uniform.prototype._updateArray,r},osg.Uniform.createInt1=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[0]);var o=new osg.Uniform;return o.data=[r],o.glCall=function(t,e){gl.uniform1iv(t,e)},o.set=function(t){"number"==typeof t?this.data[0]=t:this.data=t,this.dirty()},o.glData=new osg.Int32Array(o.data),o.name=i,o.type="int",o},osg.Uniform.int=osg.Uniform.createInt1,osg.Uniform.createInt=osg.Uniform.createInt1,osg.Uniform.createIntArray=function(t,e){var r=osg.Uniform.createInt.call(this,t,e);return r.update=osg.Uniform.prototype._updateArray,r},osg.Uniform.createInt2=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[0,0]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e){gl.uniform2iv(t,e)},o.glData=new osg.Int32Array(o.data),o.name=i,o.type="vec2i",o},osg.Uniform.vec2i=osg.Uniform.createInt2,osg.Uniform.createInt2Array=function(t,e){var r=osg.Uniform.createInt2.call(this,t,e);return r.update=osg.Uniform.prototype._updateArray,r},osg.Uniform.createInt3=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[0,0,0]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e){gl.uniform3iv(t,e)},o.glData=new osg.Int32Array(o.data),o.name=i,o.type="vec3i",o},osg.Uniform.vec3i=osg.Uniform.createInt3,osg.Uniform.createInt3Array=function(t,e){var r=osg.Uniform.createInt3.call(this,t,e);return r.update=osg.Uniform.prototype._updateArray,r},osg.Uniform.createInt4=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[0,0,0,0]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e){gl.uniform4iv(t,e)},o.glData=new osg.Int32Array(o.data),o.name=i,o.type="vec4i",o},osg.Uniform.vec4i=osg.Uniform.createInt4,osg.Uniform.createInt4Array=function(t,e){var r=osg.Uniform.createInt4.call(this,t,e);return r.update=osg.Uniform.prototype._updateArray,r},osg.Uniform.createMatrix2=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[1,0,0,1]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e,r){gl.uniformMatrix2fv(t,e,r)},o.apply=o.applyMatrix,o.transpose=!1,o.glData=new osg.Float32Array(o.data),o.update=osg.Uniform.prototype._updateFloat4,o.name=i,o.type="mat2",o},osg.Uniform.createMat2=osg.Uniform.createMatrix2,osg.Uniform.mat2=osg.Uniform.createMat2,osg.Uniform.createMatrix3=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[1,0,0,0,1,0,0,0,1]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e,r){gl.uniformMatrix3fv(t,e,r)},o.apply=o.applyMatrix,o.transpose=!1,o.glData=new osg.Float32Array(o.data),o.update=osg.Uniform.prototype._updateFloat9,o.name=i,o.type="mat3",o},osg.Uniform.createMat3=osg.Uniform.createMatrix3,osg.Uniform.mat3=osg.Uniform.createMatrix3,osg.Uniform.createMatrix4=function(t,e){var r=t,i=e;void 0===i&&(i=r,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);var o=new osg.Uniform;return o.data=r,o.glCall=function(t,e,r){gl.uniformMatrix4fv(t,e,r)},o.apply=o.applyMatrix,o.transpose=!1,o.glData=new osg.Float32Array(o.data),o.update=osg.Uniform.prototype._updateFloat16,o.name=i,o.type="mat4",o},osg.Uniform.createMat4=osg.Uniform.createMatrix4,osg.Uniform.mat4=osg.Uniform.createMatrix4,osg.Node=function(){osg.Object.call(this),this.children=[],this.parents=[],this.nodeMask=-1,this.boundingSphere=new osg.BoundingSphere,this.boundingSphereComputed=!1,this._updateCallbacks=[],this._cullCallback=void 0},osg.Node.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.Object.prototype,{getOrCreateStateSet:function(){return void 0===this.stateset&&(this.stateset=new osg.StateSet),this.stateset},getStateSet:function(){return this.stateset},accept:function(t){t.validNodeMask(this)&&(t.pushOntoNodePath(this),t.apply(this),t.popFromNodePath())},dirtyBound:function(){if(this.boundingSphereComputed===!0){this.boundingSphereComputed=!1;for(var t=0,e=this.parents.length;e>t;t++)this.parents[t].dirtyBound()}},setNodeMask:function(t){this.nodeMask=t},getNodeMask:function(){return this.nodeMask},setStateSet:function(t){this.stateset=t},setUpdateCallback:function(t){this._updateCallbacks[0]=t},getUpdateCallback:function(){return this._updateCallbacks[0]},addUpdateCallback:function(t){this._updateCallbacks.push(t)},removeUpdateCallback:function(t){var e=this._updateCallbacks.indexOf(t);-1!==e&&this._updateCallbacks.splice(e,1)},getUpdateCallbackList:function(){return this._updateCallbacks},setCullCallback:function(t){this._cullCallback=t},getCullCallback:function(){return this._cullCallback},hasChild:function(t){for(var e=0,r=this.children.length;r>e;e++)if(this.children[e]===t)return!0;return!1},addChild:function(t){var e=this.children.push(t);return t.addParent(this),this.dirtyBound(),e},getChildren:function(){return this.children},getParents:function(){return this.parents},addParent:function(t){this.parents.push(t)},removeParent:function(t){for(var e=0,r=this.parents.length,i=this.parents;r>e;e++)if(i[e]===t)return i.splice(e,1),void 0},removeChildren:function(){var t=this.children;if(0!==t.length){for(var e=0,r=t.length;r>e;e++)t[e].removeParent(this);this.children.splice(0,this.children.length),this.dirtyBound()}},removeChild:function(t){for(var e=0,r=this.children.length;r>e;e++)this.children[e]===t&&(t.removeParent(this),this.children.splice(e,1),this.dirtyBound())},traverse:function(t){for(var e=0,r=this.children.length;r>e;e++){var i=this.children[e];i.accept(t)}},ascend:function(t){for(var e=0,r=this.parents.length;r>e;e++){var i=this.parents[e];i.accept(t)}},getBound:function(){return this.boundingSphereComputed||(this.computeBound(this.boundingSphere),this.boundingSphereComputed=!0),this.boundingSphere},computeBound:function(t){var e=new osg.BoundingBox;e.init(),t.init();for(var r=0,i=this.children.length;i>r;r++){var o=this.children[r];(void 0===o.referenceFrame||o.referenceFrame===osg.Transform.RELATIVE_RF)&&e.expandBySphere(o.getBound())}if(!e.valid())return t;t._center=e.center(),t._radius=0;for(var n=0,a=this.children.length;a>n;n++){var s=this.children[n];(void 0===s.referenceFrame||s.referenceFrame===osg.Transform.RELATIVE_RF)&&t.expandRadiusBySphere(s.getBound())}return t},getWorldMatrices:function(t){var e=function(t){this.nodePaths=[],this.halt=t,osg.NodeVisitor.call(this,osg.NodeVisitor.TRAVERSE_PARENTS)};e.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{apply:function(t){0===t.parents.length||t===this.halt?this.nodePaths.push(this.nodePath.slice(0)):this.traverse(t)}});var r=new e(t);this.accept(r);for(var i=[],o=0,n=r.nodePaths.length;n>o;o++){var a=r.nodePaths[o];0===a.length?i.push(osg.Matrix.makeIdentity([])):i.push(osg.computeLocalToWorld(a))}return i}}),"osg","Node"),osg.Node.prototype.objectType=osg.objectType.generate("Node"),osg.NodeVisitor=function(t){this.traversalMask=-1,this.nodeMaskOverride=0,this.traversalMode=t,void 0===t&&(this.traversalMode=osg.NodeVisitor.TRAVERSE_ALL_CHILDREN),this.nodePath=[]},osg.NodeVisitor.TRAVERSE_PARENTS=1,osg.NodeVisitor.TRAVERSE_ALL_CHILDREN=2,osg.NodeVisitor._traversalFunctions={},osg.NodeVisitor._traversalFunctions[osg.NodeVisitor.TRAVERSE_PARENTS]=function(t){t.ascend(this)},osg.NodeVisitor._traversalFunctions[osg.NodeVisitor.TRAVERSE_ALL_CHILDREN]=function(t){t.traverse(this)},osg.NodeVisitor._pushOntoNodePath={},osg.NodeVisitor._pushOntoNodePath[osg.NodeVisitor.TRAVERSE_PARENTS]=function(t){this.nodePath.unshift(t)
},osg.NodeVisitor._pushOntoNodePath[osg.NodeVisitor.TRAVERSE_ALL_CHILDREN]=function(t){this.nodePath.push(t)},osg.NodeVisitor._popFromNodePath={},osg.NodeVisitor._popFromNodePath[osg.NodeVisitor.TRAVERSE_PARENTS]=function(){return this.nodePath.shift()},osg.NodeVisitor._popFromNodePath[osg.NodeVisitor.TRAVERSE_ALL_CHILDREN]=function(){this.nodePath.pop()},osg.NodeVisitor.prototype={setNodeMaskOverride:function(t){this.nodeMaskOverride=t},getNodeMaskOverride:function(){return this.nodeMaskOverride},setTraversalMask:function(t){this.traversalMask=t},getTraversalMask:function(){return this.traversalMask},pushOntoNodePath:function(t){osg.NodeVisitor._pushOntoNodePath[this.traversalMode].call(this,t)},popFromNodePath:function(){osg.NodeVisitor._popFromNodePath[this.traversalMode].call(this)},validNodeMask:function(t){var e=t.getNodeMask();return 0!==(this.traversalMask&(this.nodeMaskOverride|e))},apply:function(t){this.traverse(t)},traverse:function(t){osg.NodeVisitor._traversalFunctions[this.traversalMode].call(this,t)}},osg.Transform=function(){osg.Node.call(this),this.referenceFrame=osg.Transform.RELATIVE_RF},osg.Transform.RELATIVE_RF=0,osg.Transform.ABSOLUTE_RF=1,osg.Transform.prototype=osg.objectInehrit(osg.Node.prototype,{setReferenceFrame:function(t){this.referenceFrame=t},getReferenceFrame:function(){return this.referenceFrame},computeBound:function(t){if(osg.Node.prototype.computeBound.call(this,t),!t.valid())return t;var e=osg.Matrix.makeIdentity([]);this.computeLocalToWorldMatrix(e);var r=osg.Vec3.copy(t._center,[]);r[0]+=t._radius,osg.Matrix.transformVec3(e,r,r);var i=osg.Vec3.copy(t._center,[]);i[1]+=t._radius,osg.Matrix.transformVec3(e,i,i);var o=osg.Vec3.copy(t._center,[]);o[2]+=t._radius,osg.Matrix.transformVec3(e,o,o),osg.Matrix.transformVec3(e,t._center,t._center),osg.Vec3.sub(r,t._center,r);var n=osg.Vec3.length(r);osg.Vec3.sub(i,t._center,i);var a=osg.Vec3.length(i);osg.Vec3.sub(o,t._center,o);var s=osg.Vec3.length(o);return t._radius=n,a>t._radius&&(t._radius=a),s>t._radius&&(t._radius=s),t}}),osg.computeLocalToWorld=function(t,e){var r=e;void 0===r&&(r=!0);var i=osg.Matrix.makeIdentity([]),o=0;if(r)for(o=t.length-1;o>0;o--){var n=t[o];if(n.objectType===osg.Camera.prototype.objectType&&(n.getReferenceFrame!==osg.Transform.RELATIVE_RF||0===n.getParents().length))break}for(var a=o,s=t.length;s>a;a++){var u=t[a];u.computeLocalToWorldMatrix&&u.computeLocalToWorldMatrix(i)}return i},osg.MatrixTransform=function(){osg.Transform.call(this),this.matrix=osg.Matrix.makeIdentity([])},osg.MatrixTransform.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.Transform.prototype,{getMatrix:function(){return this.matrix},setMatrix:function(t){this.matrix=t},computeLocalToWorldMatrix:function(t){return this.referenceFrame===osg.Transform.RELATIVE_RF?osg.Matrix.preMult(t,this.matrix):t=this.matrix,!0},computeWorldToLocalMatrix:function(t){var e=[];return osg.Matrix.inverse(this.matrix,e),this.referenceFrame===osg.Transform.RELATIVE_RF?osg.Matrix.postMult(e,t):t=inverse,!0}}),"osg","MatrixTransform"),osg.MatrixTransform.prototype.objectType=osg.objectType.generate("MatrixTransform"),osg.BlendFunc=function(t,e,r,i){osg.StateAttribute.call(this),this._sourceFactor=osg.BlendFunc.ONE,this._destinationFactor=osg.BlendFunc.ZERO,this._sourceFactorAlpha=this._sourceFactor,this._destinationFactorAlpha=this._destinationFactor,this._separate=!1,void 0!==t&&this.setSource(t),void 0!==e&&this.setDestination(e),void 0!==r&&this.setSourceAlpha(r),void 0!==i&&this.setDestinationAlpha(i)},osg.BlendFunc.ZERO=0,osg.BlendFunc.ONE=1,osg.BlendFunc.SRC_COLOR=768,osg.BlendFunc.ONE_MINUS_SRC_COLOR=769,osg.BlendFunc.SRC_ALPHA=770,osg.BlendFunc.ONE_MINUS_SRC_ALPHA=771,osg.BlendFunc.DST_ALPHA=772,osg.BlendFunc.ONE_MINUS_DST_ALPHA=773,osg.BlendFunc.DST_COLOR=774,osg.BlendFunc.ONE_MINUS_DST_COLOR=775,osg.BlendFunc.SRC_ALPHA_SATURATE=776,osg.BlendFunc.BLEND_DST_RGB=32968,osg.BlendFunc.BLEND_SRC_RGB=32969,osg.BlendFunc.BLEND_DST_ALPHA=32970,osg.BlendFunc.BLEND_SRC_ALPHA=32971,osg.BlendFunc.CONSTANT_COLOR=32769,osg.BlendFunc.ONE_MINUS_CONSTANT_COLOR=32770,osg.BlendFunc.CONSTANT_ALPHA=32771,osg.BlendFunc.ONE_MINUS_CONSTANT_ALPHA=32772,osg.BlendFunc.BLEND_COLOR=32773,osg.BlendFunc.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"BlendFunc",cloneType:function(){return new osg.BlendFunc},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setSource:function(t){this.setSourceRGB(t),this.setSourceAlpha(t)},setDestination:function(t){this.setDestinationRGB(t),this.setDestinationAlpha(t)},checkSeparate:function(){return this._sourceFactor!==this._sourceFactorAlpha||this._destinationFactor!==this._destinationFactorAlpha},setSourceRGB:function(t){this._sourceFactor="string"==typeof t?osg.BlendFunc[t]:t,this._separate=this.checkSeparate()},setSourceAlpha:function(t){this._sourceFactorAlpha="string"==typeof t?osg.BlendFunc[t]:t,this._separate=this.checkSeparate()},setDestinationRGB:function(t){this._destinationFactor="string"==typeof t?osg.BlendFunc[t]:t,this._separate=this.checkSeparate()},setDestinationAlpha:function(t){this._destinationFactorAlpha="string"==typeof t?osg.BlendFunc[t]:t,this._separate=this.checkSeparate()},apply:function(t){var e=t.getGraphicContext();e.enable(e.BLEND),this._separate?e.blendFuncSeparate(this._sourceFactor,this._destinationFactor,this._sourceFactorAlpha,this._destinationFactorAlpha):e.blendFunc(this._sourceFactor,this._destinationFactor)}}),"osg","BlendFunc"),osg.BlendColor=function(t){osg.StateAttribute.call(this),this._constantColor=Array(4),this._constantColor[0]=this._constantColor[1]=this._constantColor[2]=this._constantColor[3]=1,void 0!==t&&this.setConstantColor(t)},osg.BlendColor.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"BlendColor",cloneType:function(){return new osg.BlendColor},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setConstantColor:function(t){osg.Vec4.copy(t,this._constantColor)},getConstantColor:function(){return this._constantColor},apply:function(t){var e=t.getGraphicContext();e.blendColor(this._constantColor[0],this._constantColor[1],this._constantColor[2],this._constantColor[3]),this._dirty=!1}}),"osg","BlendColor"),osg.BoundingBox=function(){this.init()},osg.BoundingBox.prototype=osg.objectLibraryClass({_cache_radius2_tmp:[0,0,0],init:function(){this._min=[1/0,1/0,1/0],this._max=[-1/0,-1/0,-1/0]},valid:function(){return this._max[0]>=this._min[0]&&this._max[1]>=this._min[1]&&this._max[2]>=this._min[2]},expandBySphere:function(t){if(t.valid()){var e=this._max,r=this._min;r[0]=Math.min(r[0],t._center[0]-t._radius),r[1]=Math.min(r[1],t._center[1]-t._radius),r[2]=Math.min(r[2],t._center[2]-t._radius),e[0]=Math.max(e[0],t._center[0]+t._radius),e[1]=Math.max(e[1],t._center[1]+t._radius),e[2]=Math.max(e[2],t._center[2]+t._radius)}},expandByVec3:function(t){var e=this._min,r=this._max;e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),r[0]=Math.max(r[0],t[0]),r[1]=Math.max(r[1],t[1]),r[2]=Math.max(r[2],t[2])},center:function(){var t=this._min,e=this._max;return[.5*(t[0]+e[0]),.5*(t[1]+e[1]),.5*(t[2]+e[2])]},radius:function(){return Math.sqrt(this.radius2())},radius2:function(){var t=this._min,e=this._max,r=this._cache_radius2_tmp;return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],.25*(r[0]*r[0]+r[1]*r[1]+r[2]*r[2])},corner:function(t){return ret=[0,0,0],ret[0]=1&t?this._max[0]:this._min[0],ret[1]=2&t?this._max[1]:this._min[1],ret[2]=4&t?this._max[2]:this._min[2],ret}},"osg","BoundingBox"),osg.BoundingSphere=function(){this._center=[0,0,0],this._radius=-1},osg.BoundingSphere.prototype={init:function(){this._center=[0,0,0],this._radius=-1},valid:function(){return this._radius>=0},set:function(t,e){this._center=t,this._radius=e},center:function(){return this._center},radius:function(){return this._radius},radius2:function(){return this._radius*this._radius},expandByBox:function(t){if(t.valid()){var e;if(this.valid()){var r=new osg.BoundingBox;r._min[0]=t._min[0],r._min[1]=t._min[1],r._min[2]=t._min[2],r._max[0]=t._max[0],r._max[1]=t._max[1],r._max[2]=t._max[2];for(var i=0;8>i;i++){var o=osg.Vec3.sub(t.corner(e),this._center,[]);osg.Vec3.normalize(o,o),nv[0]*=-this._radius,nv[1]*=-this._radius,nv[2]*=-this._radius,nv[0]+=this._center[0],nv[1]+=this._center[1],nv[2]+=this._center[2],r.expandBy(nv)}e=r.center(),this._center[0]=e[0],this._center[1]=e[1],this._center[2]=e[2],this._radius=r.radius()}else e=t.center(),this._center[0]=e[0],this._center[1]=e[1],this._center[2]=e[2],this._radius=t.radius()}},expandByVec3:function(t){if(this.valid()){var e=osg.Vec3.sub(t,this.center(),[]);r=osg.Vec3.length(e),r>this.radius()&&(dr=.5*(r-this.radius()),this._center[0]+=e[0]*(dr/r),this._center[1]+=e[1]*(dr/r),this._center[2]+=e[2]*(dr/r),this._radius+=dr)}else this._center[0]=t[0],this._center[1]=t[1],this._center[2]=t[2],this._radius=0},expandRadiusBySphere:function(t){if(t.valid())if(this.valid()){var e=osg.Vec3.sub,r=osg.Vec3.length,i=r(e(t._center,this._center,[]))+t._radius;i>this._radius&&(this._radius=i)}else this._center=osg.Vec3.copy(t._center,[]),this._radius=t._radius},expandBy:function(t){if(t.valid()){if(!this.valid())return this._center[0]=t._center[0],this._center[1]=t._center[1],this._center[2]=t._center[2],this._radius=t.radius(),void 0;var e=osg.Vec3.sub(this.center(),t.center(),[]);if(d=osg.Vec3.length(e),!(d+t.radius()<=this.radius())){if(d+this.radius()<=t.radius())return this._center[0]=t._center[0],this._center[1]=t._center[1],this._center[2]=t._center[2],this._radius=t._radius,void 0;new_radius=.5*(this.radius()+d+t.radius()),ratio=(new_radius-this.radius())/d,this._center[0]+=(t._center[0]-this._center[0])*ratio,this._center[1]+=(t._center[1]-this._center[1])*ratio,this._center[2]+=(t._center[2]-this._center[2])*ratio,this._radius=new_radius}}},contains:function(t){var e=osg.Vec3.sub(t,this.center(),[]);return valid()&&osg.Vec3.length2(e)<=radius2()},intersects:function(t){var e=osg.Vec3.length2(osg.Vec3.sub(this.center(),t.center(),[]));return valid()&&t.valid()&&(this.radius()+t.radius())*(this.radius()+t.radius())>=e}},osg.BufferArray=function(t,e,r){void 0===osg.BufferArray.instanceID&&(osg.BufferArray.instanceID=0),this.instanceID=osg.BufferArray.instanceID,osg.BufferArray.instanceID+=1,this.dirty(),this._itemSize=r,"string"==typeof t&&(t=osg.BufferArray[t]),this._type=t,void 0!==e&&(this._elements=this._type===osg.BufferArray.ELEMENT_ARRAY_BUFFER?new osg.Uint16Array(e):new osg.Float32Array(e))},osg.BufferArray.ELEMENT_ARRAY_BUFFER=34963,osg.BufferArray.ARRAY_BUFFER=34962,osg.BufferArray.prototype={setItemSize:function(t){this._itemSize=t},isValid:function(){return void 0!==this._buffer||void 0!==this._elements?!0:!1},releaseGLObjects:function(t){void 0!==this._buffer&&null!==this._buffer&&t.deleteBuffer(this._buffer),this._buffer=void 0},bind:function(t){var e=this._type,r=this._buffer;return r?(t.bindBuffer(e,r),void 0):(!r&&this._elements.length>0&&(this._buffer=t.createBuffer(),this._numItems=this._elements.length/this._itemSize,t.bindBuffer(e,this._buffer)),void 0)},getItemSize:function(){return this._itemSize},dirty:function(){this._dirty=!0},isDirty:function(){return this._dirty},compile:function(t){this._dirty&&(t.bufferData(this._type,this._elements,t.STATIC_DRAW),this._dirty=!1)},getElements:function(){return this._elements},setElements:function(t){this._elements=t,this._dirty=!0}},osg.BufferArray.create=function(t,e,r){return osg.log("osg.BufferArray.create is deprecated, use new osg.BufferArray with same arguments instead"),new osg.BufferArray(t,e,r)},osg.CullFace=function(t){osg.StateAttribute.call(this),void 0===t&&(t=osg.CullFace.BACK),this.setMode(t)},osg.CullFace.DISABLE=0,osg.CullFace.FRONT=1028,osg.CullFace.BACK=1029,osg.CullFace.FRONT_AND_BACK=1032,osg.CullFace.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"CullFace",cloneType:function(){return new osg.CullFace},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setMode:function(t){"string"==typeof t&&(t=osg.CullFace[t]),this._mode=t},getMode:function(){return this._mode},apply:function(t){var e=t.getGraphicContext();this._mode===osg.CullFace.DISABLE?e.disable(e.CULL_FACE):(e.enable(e.CULL_FACE),e.cullFace(this._mode)),this._dirty=!1}}),"osg","CullFace"),osg.CullSettings=function(){this._computeNearFar=!0,this._nearFarRatio=.005;var t=[0,0,-1];this.bbCornerFar=(t[0]>=0?1:0)|(t[1]>=0?2:0)|(t[2]>=0?4:0),this.bbCornerNear=7&~this.bbCornerFar},osg.CullSettings.prototype={setCullSettings:function(t){this._computeNearFar=t._computeNearFar,this._nearFarRatio=t._nearFarRatio},setNearFarRatio:function(t){this._nearFarRatio=t},getNearFarRatio:function(){return this._nearFarRatio},setComputeNearFar:function(t){this._computeNearFar=t},getComputeNearFar:function(){return this._computeNearFar}},osg.Camera=function(){osg.Transform.call(this),osg.CullSettings.call(this),this.viewport=void 0,this.setClearColor([0,0,0,1]),this.setClearDepth(1),this.setClearMask(osg.Camera.COLOR_BUFFER_BIT|osg.Camera.DEPTH_BUFFER_BIT),this.setViewMatrix(osg.Matrix.makeIdentity([])),this.setPureViewMatrix(osg.Matrix.makeIdentity([])),this.setProjectionMatrix(osg.Matrix.makeIdentity([])),this.renderOrder=osg.Camera.NESTED_RENDER,this.renderOrderNum=0},osg.Camera.PRE_RENDER=0,osg.Camera.NESTED_RENDER=1,osg.Camera.POST_RENDER=2,osg.Camera.COLOR_BUFFER_BIT=16384,osg.Camera.DEPTH_BUFFER_BIT=256,osg.Camera.STENCIL_BUFFER_BIT=1024,osg.Camera.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.CullSettings.prototype,osg.objectInehrit(osg.Transform.prototype,{setClearDepth:function(t){this.clearDepth=t},getClearDepth:function(){return this.clearDepth},setClearMask:function(t){this.clearMask=t},getClearMask:function(){return this.clearMask},setClearColor:function(t){this.clearColor=t},getClearColor:function(){return this.clearColor},setTraversalMask:function(t){this.traversalMask=t},getTraversalMask:function(){return this.traversalMask},setViewport:function(t){this.viewport=t,this.getOrCreateStateSet().setAttributeAndMode(t)},getViewport:function(){return this.viewport},setPureViewMatrix:function(t){this.pureViewMatrix=t},setViewMatrix:function(t){this.modelviewMatrix=t},setProjectionMatrix:function(t){this.projectionMatrix=t},setProjectionMatrixAsOrtho:function(t,e,r,i,o,n){osg.Matrix.makeOrtho(t,e,r,i,o,n,this.getProjectionMatrix())},getViewMatrix:function(){return this.modelviewMatrix},getPureViewMatrix:function(){return this.pureViewMatrix},getProjectionMatrix:function(){return this.projectionMatrix},getRenderOrder:function(){return this.renderOrder},setRenderOrder:function(t,e){this.renderOrder=t,this.renderOrderNum=e},attachTexture:function(t,e,r){this.frameBufferObject&&this.frameBufferObject.dirty(),void 0===r&&(r=0),void 0===this.attachments&&(this.attachments={}),t==osg.FrameBufferObject.COLOR_ATTACHMENT0&&osgUtil.ressourcesCache.frameBufferObjectTarget.push(e),this.attachments[t]={texture:e,level:r}},attachRenderBuffer:function(t,e){this.frameBufferObject&&this.frameBufferObject.dirty(),void 0===this.attachments&&(this.attachments={}),this.attachments[t]={format:e}},computeLocalToWorldMatrix:function(t){return this.referenceFrame===osg.Transform.RELATIVE_RF?osg.Matrix.preMult(t,this.modelviewMatrix):t=this.modelviewMatrix,!0},computeWorldToLocalMatrix:function(t){var e=[];return osg.Matrix.inverse(this.modelviewMatrix,e),this.referenceFrame===osg.Transform.RELATIVE_RF?osg.Matrix.postMult(e,t):t=e,!0}})),"osg","Camera"),osg.Camera.prototype.objectType=osg.objectType.generate("Camera"),osg.Depth=function(t,e,r,i){osg.StateAttribute.call(this),this._func=osg.Depth.LESS,this._near=0,this._far=1,this._writeMask=!0,void 0!==t&&(this._func="string"==typeof t?osg.Depth[t]:t),void 0!==e&&(this._near=e),void 0!==r&&(this._far=r),void 0!==i&&(this._writeMask=i)},osg.Depth.DISABLE=0,osg.Depth.NEVER=512,osg.Depth.LESS=513,osg.Depth.EQUAL=514,osg.Depth.LEQUAL=515,osg.Depth.GREATE=516,osg.Depth.NOTEQU=517,osg.Depth.GEQUAL=518,osg.Depth.ALWAYS=519,osg.Depth.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Depth",cloneType:function(){return new osg.Depth},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setRange:function(t,e){this._near=t,this._far=e},setWriteMask:function(t){this._writeMask=t},apply:function(t){var e=t.getGraphicContext();0===this._func?e.disable(e.DEPTH_TEST):(e.enable(e.DEPTH_TEST),e.depthFunc(this._func),e.depthMask(this._writeMask),e.depthRange(this._near,this._far))}}),"osg","Depth"),osg.ColorMask=function(t){osg.StateAttribute.call(this),this._colorMask=t?t:[!0,!0,!0,!0]},osg.ColorMask.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"ColorMask",cloneType:function(){return new osg.ColorMask},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setColorMask:function(t){this._colorMask=t},apply:function(t){var e=t.getGraphicContext();e.colorMask(this._colorMask[0],this._colorMask[1],this._colorMask[2],this._colorMask[3])}}),"osg","ColorMask"),osg.WGS_84_RADIUS_EQUATOR=6378137,osg.WGS_84_RADIUS_POLAR=6356752.3142,osg.EllipsoidModel=function(){this._radiusEquator=osg.WGS_84_RADIUS_EQUATOR,this._radiusPolar=osg.WGS_84_RADIUS_POLAR,this.computeCoefficients()},osg.EllipsoidModel.prototype={setRadiusEquator:function(){this._radiusEquator=radius,this.computeCoefficients()},getRadiusEquator:function(){return this._radiusEquator},setRadiusPolar:function(t){this._radiusPolar=t,this.computeCoefficients()},getRadiusPolar:function(){return this._radiusPolar},convertLatLongHeightToXYZ:function(t,e,r,i){void 0===i&&(osg.warn("deprecated, use this signature convertLatLongHeightToXYZ( latitude, longitude, height, result )"),i=[]);var o=Math.sin(t),n=Math.cos(t),a=this._radiusEquator/Math.sqrt(1-this._eccentricitySquared*o*o),s=(a+r)*n*Math.cos(e),u=(a+r)*n*Math.sin(e),h=(a*(1-this._eccentricitySquared)+r)*o;return i[0]=s,i[1]=u,i[2]=h,i},convertXYZToLatLongHeight:function(t,e,r,i){void 0===i&&(osg.warn("deprecated, use this signature convertXYZToLatLongHeight( X,  Y,  Z , result)"),i=[]);var o=Math.sqrt(t*t+e*e),n=Math.atan2(r*this._radiusEquator,o*this._radiusPolar),a=(this._radiusEquator*this._radiusEquator-this._radiusPolar*this._radiusPolar)/(this._radiusPolar*this._radiusPolar),s=Math.sin(n),u=Math.cos(n);latitude=Math.atan((r+a*this._radiusPolar*s*s*s)/(o-this._eccentricitySquared*this._radiusEquator*u*u*u)),longitude=Math.atan2(e,t);var h=Math.sin(latitude),c=this._radiusEquator/Math.sqrt(1-this._eccentricitySquared*h*h);return height=o/Math.cos(latitude)-c,i[0]=latitude,i[1]=longitude,i[2]=height,i},computeLocalUpVector:function(t,e,r){var i,o,n,a=this.convertXYZToLatLongHeight(t,e,r,i,o,n);return i=a[0],o=a[1],n=a[2],[Math.cos(o)*Math.cos(i),Math.sin(o)*Math.cos(i),Math.sin(i)]},isWGS84:function(){return this._radiusEquator==osg.WGS_84_RADIUS_EQUATOR&&this._radiusPolar==osg.WGS_84_RADIUS_POLAR},computeCoefficients:function(){var t=(this._radiusEquator-this._radiusPolar)/this._radiusEquator;this._eccentricitySquared=2*t-t*t},computeLocalToWorldTransformFromLatLongHeight:function(t,e,r,i){void 0===i&&(osg.warn("deprecated, use this signature computeLocalToWorldTransformFromLatLongHeight(latitude, longitude, height, result)"),i=Array(16));var o=this.convertLatLongHeightToXYZ(t,e,r,i);return osg.Matrix.makeTranslate(o[0],o[1],o[2],i),this.computeCoordinateFrame(t,e,i),i},computeLocalToWorldTransformFromXYZ:function(t,e,r){var i=this.convertXYZToLatLongHeight(t,e,r),o=osg.Matrix.makeTranslate(t,e,r);return this.computeCoordinateFrame(i[0],i[1],o),o},computeCoordinateFrame:function(t,e,r){var i=[Math.cos(e)*Math.cos(t),Math.sin(e)*Math.cos(t),Math.sin(t)],o=[-Math.sin(e),Math.cos(e),0],n=osg.Vec3.cross(i,o,[]);osg.Matrix.set(r,0,0,o[0]),osg.Matrix.set(r,0,1,o[1]),osg.Matrix.set(r,0,2,o[2]),osg.Matrix.set(r,1,0,n[0]),osg.Matrix.set(r,1,1,n[1]),osg.Matrix.set(r,1,2,n[2]),osg.Matrix.set(r,2,0,i[0]),osg.Matrix.set(r,2,1,i[1]),osg.Matrix.set(r,2,2,i[2])}},osg.FrameBufferObject=function(){osg.StateAttribute.call(this),this.fbo=void 0,this.attachments=[],this.dirty()},osg.FrameBufferObject.COLOR_ATTACHMENT0=36064,osg.FrameBufferObject.DEPTH_ATTACHMENT=36096,osg.FrameBufferObject.DEPTH_COMPONENT16=33189,osg.FrameBufferObject.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"FrameBufferObject",cloneType:function(){return new osg.FrameBufferObject},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setAttachment:function(t){this.attachments.push(t)},_reportFrameBufferError:function(t){switch(t){case 36054:osg.debug("FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case 36055:osg.debug("FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case 36057:osg.debug("FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case 36061:osg.debug("FRAMEBUFFER_UNSUPPORTED");break;default:osg.debug("FRAMEBUFFER unknown error "+t.toString(16))}},apply:function(t){var e,r=t.getGraphicContext();if(this.attachments.length>0)if(this.isDirty()){this.fbo||(this.fbo=r.createFramebuffer()),osg.framebufferList||(osg.framebufferList=[]),-1==osg.framebufferList.indexOf(this)&&osg.framebufferList.push(this),r.bindFramebuffer(r.FRAMEBUFFER,this.fbo);for(var i=!1,o=0,n=this.attachments.length;n>o;++o)if(void 0===this.attachments[o].texture){var a=r.createRenderbuffer();r.bindRenderbuffer(r.RENDERBUFFER,a),r.renderbufferStorage(r.RENDERBUFFER,this.attachments[o].format,this.attachments[o].width,this.attachments[o].height),r.framebufferRenderbuffer(r.FRAMEBUFFER,this.attachments[o].attachment,r.RENDERBUFFER,a),i=!0}else{var s=this.attachments[o].texture;t.applyTextureAttribute(0,s),r.framebufferTexture2D(r.FRAMEBUFFER,this.attachments[o].attachment,s.getTextureTarget(),s.getTextureObject(),this.attachments[o].level)}e=r.checkFramebufferStatus(r.FRAMEBUFFER),36053!==e&&this._reportFrameBufferError(e),i&&r.bindRenderbuffer(r.RENDERBUFFER,null),this.setDirty(!1)}else r.bindFramebuffer(r.FRAMEBUFFER,this.fbo),osg.reportWebGLError===!0&&(e=r.checkFramebufferStatus(r.FRAMEBUFFER),36053!==e&&this._reportFrameBufferError(e));else r.bindFramebuffer(r.FRAMEBUFFER,null)}}),osg.FrameStamp=function(){var t=0,e=0,r=0;this.setReferenceTime=function(t){e=t},this.setSimulationTime=function(t){r=t},this.getReferenceTime=function(){return e},this.getSimulationTime=function(){return r},this.setFrameNumber=function(e){t=e},this.getFrameNumber=function(){return t}},osg.Geometry=function(){osg.Node.call(this),this.primitives=[],this.attributes={},this.boundingBox=new osg.BoundingBox,this.boundingBoxComputed=!1,this.cacheAttributeList={}},osg.Geometry.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.Node.prototype,{releaseGLObjects:function(t){var e;for(e in this.attributes)this.attributes[e].releaseGLObjects(t);for(var r=0,i=this.primitives.length;i>r;r++){var o=this.primitives[r];void 0!==o.getIndices&&void 0!==o.getIndices()&&null!==o.getIndices()&&o.indices.releaseGLObjects(t)}},dirtyBound:function(){this.boundingBoxComputed===!0&&(this.boundingBoxComputed=!1),osg.Node.prototype.dirtyBound.call(this)},dirty:function(){this.cacheAttributeList={}},getPrimitives:function(){return this.primitives},getAttributes:function(){return this.attributes},getVertexAttributeList:function(){return this.attributes},getPrimitiveSetList:function(){return this.primitives},drawImplementation:function(t){var e=t.getLastProgramApplied(),r=e.instanceID;if(void 0===this.cacheAttributeList[r]){var i,o=e.attributesCache,n=[],a="//generated by Geometry::implementation\n";a+="state.lazyDisablingOfVertexAttributes();\n",a+="var attr;\n";for(var s=0,u=o.attributeKeys.length;u>s;s++){var h=o.attributeKeys[s];i=o[h];var c=this.attributes[h];void 0!==c&&(n.push(i),a+='attr = this.attributes["'+h+'"];\n',a+="if (!attr.isValid()) { return; }\n",a+="state.setVertexAttribArray("+i+", attr, false);\n")}a+="state.applyDisablingOfVertexAttributes();\n";var g=this.primitives;a+="var primitives = this.primitives;\n";for(var l=0,d=g.length;d>l;++l)a+="primitives["+l+"].draw(state);\n";this.cacheAttributeList[r]=Function("state",a)}this.cacheAttributeList[r].call(this,t)},drawImplementationDummy:function(t){var e=t.getLastProgramApplied();e.attributesCache;for(var r=this.primitives,i=0,o=r.length;o>i;++i);},getBoundingBox:function(){return this.boundingBoxComputed||(this.computeBoundingBox(this.boundingBox),this.boundingBoxComputed=!0),this.boundingBox},computeBoundingBox:function(t){var e=this.getAttributes().Vertex;if(void 0!==e&&void 0!==e.getElements()&&e.getItemSize()>2){var r=[0,0,0];vertexes=e.getElements();for(var i=0,o=vertexes.length;o>i;i+=3)r[0]=vertexes[i],r[1]=vertexes[i+1],r[2]=vertexes[i+2],t.expandByVec3(r)}return t},computeBound:function(t){t.init();var e=this.getBoundingBox();return t.expandByBox(e),t}}),"osg","Geometry"),osg.Geometry.prototype.objectType=osg.objectType.generate("Geometry"),osg.Light=function(t){osg.StateAttribute.call(this),void 0===t&&(t=0),this._ambient=[.2,.2,.2,1],this._diffuse=[.8,.8,.8,1],this._specular=[.2,.2,.2,1],this._position=[0,0,1,0],this._direction=[0,0,-1],this._spotCutoff=180,this._spotBlend=.01,this._constantAttenuation=1,this._linearAttenuation=0,this._quadraticAttenuation=0,this._lightUnit=t,this._enabled=1,this.dirty()},osg.Light.uniforms={},osg.Light.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Light",cloneType:function(){return new osg.Light(this._lightUnit)},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType+this._lightUnit},getOrCreateUniforms:function(){var t=osg.Light.uniforms,e=this.getTypeMember();if(void 0===t[e]){var r=osg.Uniform;t[e]={ambient:r.createFloat4([.2,.2,.2,1],this.getUniformName("ambient")),diffuse:r.createFloat4([.8,.8,.8,1],this.getUniformName("diffuse")),specular:r.createFloat4([.2,.2,.2,1],this.getUniformName("specular")),position:r.createFloat4([0,0,1,0],this.getUniformName("position")),direction:r.createFloat3([0,0,1],this.getUniformName("direction")),spotCutoff:r.createFloat1(180,this.getUniformName("spotCutoff")),spotBlend:r.createFloat1(.01,this.getUniformName("spotBlend")),constantAttenuation:r.createFloat1(0,this.getUniformName("constantAttenuation")),linearAttenuation:r.createFloat1(0,this.getUniformName("linearAttenuation")),quadraticAttenuation:r.createFloat1(0,this.getUniformName("quadraticAttenuation")),enable:r.createInt1(0,this.getUniformName("enable")),matrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("matrix")),invMatrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("invMatrix"))},t[e].uniformKeys=Object.keys(t[e])}return t[e]},setPosition:function(t){osg.Vec4.copy(t,this._position)},getPosition:function(){return this._position},setAmbient:function(t){this._ambient=t,this.dirty()},setSpecular:function(t){this._specular=t,this.dirty()},setDiffuse:function(t){this._diffuse=t,this.dirty()},setSpotCutoff:function(t){this._spotCutoff=t,this.dirty()},getSpotCutoff:function(){return this._spotCutoff},setSpotBlend:function(t){this._spotBlend=t,this.dirty()},getSpotBlend:function(){return this._spotBlend},setConstantAttenuation:function(t){this._constantAttenuation=t,this.dirty()},setLinearAttenuation:function(t){this._linearAttenuation=t,this.dirty()},setQuadraticAttenuation:function(t){this._quadraticAttenuation=t,this.dirty()},setDirection:function(t){this._direction=t,this.dirty()},getDirection:function(){return this._direction},setLightNumber:function(t){this._lightUnit=t,this.dirty()},getLightNumber:function(){return this._lightUnit},getPrefix:function(){return this.getType()+this._lightUnit},getParameterName:function(t){return this.getPrefix()+"_"+t},getUniformName:function(t){return this.getPrefix()+"_uniform_"+t},applyPositionedUniform:function(t){var e=this.getOrCreateUniforms();osg.Matrix.copy(t,e.matrix.get()),e.matrix.dirty(),osg.Matrix.copy(t,e.invMatrix.get()),e.invMatrix.get()[12]=0,e.invMatrix.get()[13]=0,e.invMatrix.get()[14]=0,osg.Matrix.inverse(e.invMatrix.get(),e.invMatrix.get()),osg.Matrix.transpose(e.invMatrix.get(),e.invMatrix.get()),e.invMatrix.dirty()},apply:function(){var t=this.getOrCreateUniforms();t.ambient.set(this._ambient),t.diffuse.set(this._diffuse),t.specular.set(this._specular),t.position.set(this._position),t.direction.set(this._direction);var e=Math.cos(this._spotCutoff*Math.PI/180);t.spotCutoff.get()[0]=e,t.spotCutoff.dirty(),t.spotBlend.get()[0]=(1-e)*this._spotBlend,t.spotBlend.dirty(),t.constantAttenuation.get()[0]=this._constantAttenuation,t.constantAttenuation.dirty(),t.linearAttenuation.get()[0]=this._linearAttenuation,t.linearAttenuation.dirty(),t.quadraticAttenuation.get()[0]=this._quadraticAttenuation,t.quadraticAttenuation.dirty(),t.enable.set([this._enabled]),this.setDirty(!1)},_replace:function(t,e,r,i){for(var o=0,n=e.length;n>o;o++){var a=RegExp(t+e[o],"g");r=r.replace(a,i.call(this,e[o]))}return r},_shader:{},_shaderCommon:{},generateShader:function(t){return this._shader[t]?this._shader[t].call(this):""},generateShaderCommon:function(t){return this._shaderCommon[t]?this._shaderCommon[t].call(this):""}}),"osg","Light"),osg.Light.prototype._shaderCommon[osg.ShaderGeneratorType.VertexInit]=function(){return["","varying vec3 FragNormal;","varying vec3 FragEyeVector;","",""].join("\n")},osg.Light.prototype._shaderCommon[osg.ShaderGeneratorType.VertexFunction]=function(){return["","vec3 computeNormal() {","   return vec3(NormalMatrix * vec4(Normal, 0.0));","}","","vec3 computeEyeVertex() {","   return vec3(ModelViewMatrix * vec4(Vertex,1.0));","}","",""].join("\n")},osg.Light.prototype._shaderCommon[osg.ShaderGeneratorType.VertexMain]=function(){return["","  FragEyeVector = computeEyeVertex();","  FragNormal = computeNormal();",""].join("\n")},osg.Light.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentInit]=function(){return["varying vec3 FragNormal;","varying vec3 FragEyeVector;",""].join("\n")},osg.Light.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentFunction]=function(){return["","float getLightAttenuation(vec3 lightDir, float constant, float linear, float quadratic) {","    ","    float d = length(lightDir);","    float att = 1.0 / ( constant + linear*d + quadratic*d*d);","    return att;","}","vec4 computeLightContribution(vec4 materialAmbient,","                              vec4 materialDiffuse,","                              vec4 materialSpecular,","                              float materialShininess,","                              vec4 lightAmbient,","                              vec4 lightDiffuse,","                              vec4 lightSpecular,","                              vec3 normal,","                              vec3 eye,","                              vec3 lightDirection,","                              vec3 lightSpotDirection,","                              float lightCosSpotCutoff,","                              float lightSpotBlend,","                              float lightAttenuation)","{","    vec3 L = lightDirection;","    vec3 N = normal;","    float NdotL = max(dot(L, N), 0.0);","    float halfTerm = NdotL;","    vec4 ambient = lightAmbient;","    vec4 diffuse = vec4(0.0);","    vec4 specular = vec4(0.0);","    float spot = 0.0;","","    if (NdotL > 0.0) {","        vec3 E = eye;","        vec3 R = reflect(-L, N);","        float RdotE = max(dot(R, E), 0.0);","        if ( RdotE > 0.0) {","           RdotE = pow( RdotE, materialShininess );","        }","        vec3 D = lightSpotDirection;","        spot = 1.0;","        if (lightCosSpotCutoff > 0.0) {","          float cosCurAngle = dot(-L, D);","          if (cosCurAngle < lightCosSpotCutoff) {","             spot = 0.0;","          } else {","             if (lightSpotBlend > 0.0)","               spot = cosCurAngle * smoothstep(0.0, 1.0, (cosCurAngle-lightCosSpotCutoff)/(lightSpotBlend));","          }","        }","        diffuse = lightDiffuse * ((halfTerm));","        specular = lightSpecular * RdotE;","    }","","    return (materialAmbient*ambient + (materialDiffuse*diffuse + materialSpecular*specular) * spot) * lightAttenuation;","}","float linearrgb_to_srgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.0031308) {","    if ( c > 0.0)","      v = c * 12.92;","  } else {","    v = 1.055 * pow(c, 1.0/2.4) - 0.055;","  }","  return v;","}","vec4 linearrgb_to_srgb(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = linearrgb_to_srgb1(col_from.r);","  col_to.g = linearrgb_to_srgb1(col_from.g);","  col_to.b = linearrgb_to_srgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}","float srgb_to_linearrgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.04045) {","    if (c >= 0.0)","      v = c * (1.0/12.92);","  } else {","    v = pow((c + 0.055)*(1.0/1.055), 2.4);","  }"," return v;","}","vec4 srgb2linear(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = srgb_to_linearrgb1(col_from.r);","  col_to.g = srgb_to_linearrgb1(col_from.g);","  col_to.b = srgb_to_linearrgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}",""].join("\n")
},osg.Light.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentMain]=function(){return["","  vec3 normal = normalize(FragNormal);","  vec3 eyeVector = normalize(-FragEyeVector);","  vec4 lightColor = MaterialEmission;",""].join("\n")},osg.Light.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentEnd]=function(){return["","  fragColor *= lightColor;",""].join("\n")},osg.Light.prototype._shader[osg.ShaderGeneratorType.FragmentInit]=function(){var t=["","uniform vec4 Light_position;","uniform vec3 Light_direction;","uniform mat4 Light_matrix;","uniform mat4 Light_invMatrix;","uniform float Light_constantAttenuation;","uniform float Light_linearAttenuation;","uniform float Light_quadraticAttenuation;","uniform vec4 Light_ambient;","uniform vec4 Light_diffuse;","uniform vec4 Light_specular;","uniform float Light_spotCutoff;","uniform float Light_spotBlend;",""].join("\n");return uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("Light_",uniforms,t,this.getUniformName)},osg.Light.prototype._shader[osg.ShaderGeneratorType.FragmentMain]=function(){var t=["","  vec3 lightEye = vec3(Light_matrix * Light_position);","  vec3 lightDir;","  if (Light_position[3] == 1.0) {","    lightDir = lightEye - FragEyeVector;","  } else {","    lightDir = lightEye;","  }","  vec3 spotDirection = normalize(mat3(vec3(Light_invMatrix[0]), vec3(Light_invMatrix[1]), vec3(Light_invMatrix[2]))*Light_direction);","  float attenuation = getLightAttenuation(lightDir, Light_constantAttenuation, Light_linearAttenuation, Light_quadraticAttenuation);","  lightDir = normalize(lightDir);","  lightColor += computeLightContribution(MaterialAmbient,","                                         MaterialDiffuse, ","                                         MaterialSpecular,","                                         MaterialShininess,","                                         Light_ambient,","                                         Light_diffuse,","                                         Light_specular,","                                         normal,","                                         eyeVector,","                                         lightDir,","                                         spotDirection,","                                         Light_spotCutoff,","                                         Light_spotBlend,","                                         attenuation);",""].join("\n"),e=["lightEye","lightDir","spotDirection","attenuation"];return t=this._replace("",e,t,this.getParameterName),uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("Light_",uniforms,t,this.getUniformName)},osg.LightSource=function(){osg.MatrixTransform.call(this),this._light=void 0},osg.LightSource.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.MatrixTransform.prototype,{getLight:function(){return this._light},setLight:function(t){this._light=t}}),"osg","LightSource"),osg.LightSource.prototype.objectType=osg.objectType.generate("LightSource"),osg.LineWidth=function(t){osg.StateAttribute.call(this),this.lineWidth=1,void 0!==t&&(this.lineWidth=t)},osg.LineWidth.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"LineWidth",cloneType:function(){return new osg.LineWidth},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},apply:function(t){t.getGraphicContext().lineWidth(this.lineWidth)}}),"osg","LineWidth"),osg.Material=function(){osg.StateAttribute.call(this),this.ambient=[.2,.2,.2,1],this.diffuse=[.8,.8,.8,1],this.specular=[0,0,0,1],this.emission=[0,0,0,1],this.shininess=12.5},osg.Material.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{setEmission:function(t){osg.Vec4.copy(t,this.emission),this._dirty=!0},setAmbient:function(t){osg.Vec4.copy(t,this.ambient),this._dirty=!0},setSpecular:function(t){osg.Vec4.copy(t,this.specular),this._dirty=!0},setDiffuse:function(t){osg.Vec4.copy(t,this.diffuse),this._dirty=!0},setShininess:function(t){this.shininess=t,this._dirty=!0},getEmission:function(){return this.emission},getAmbient:function(){return this.ambient},getSpecular:function(){return this.specular},getDiffuse:function(){return this.diffuse},getShininess:function(){return this.shininess},attributeType:"Material",cloneType:function(){return new osg.Material},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},getOrCreateUniforms:function(){if(void 0===osg.Material.uniforms){osg.Material.uniforms={ambient:osg.Uniform.createFloat4([0,0,0,0],"MaterialAmbient"),diffuse:osg.Uniform.createFloat4([0,0,0,0],"MaterialDiffuse"),specular:osg.Uniform.createFloat4([0,0,0,0],"MaterialSpecular"),emission:osg.Uniform.createFloat4([0,0,0,0],"MaterialEmission"),shininess:osg.Uniform.createFloat1([0],"MaterialShininess")};var t=[];for(var e in osg.Material.uniforms)t.push(e);osg.Material.uniforms.uniformKeys=t}return osg.Material.uniforms},apply:function(){var t=this.getOrCreateUniforms();t.ambient.set(this.ambient),t.diffuse.set(this.diffuse),t.specular.set(this.specular),t.emission.set(this.emission),t.shininess.set([this.shininess]),this._dirty=!1},_shader:{},_shaderCommon:{},generateShader:function(t){return this._shader[t]?this._shader[t].call(this):""}}),"osg","Material"),osg.Material.prototype._shader[osg.ShaderGeneratorType.VertexInit]=function(){var t=["uniform vec4 MaterialAmbient;","uniform vec4 MaterialDiffuse;","uniform vec4 MaterialSpecular;","uniform vec4 MaterialEmission;","uniform float MaterialShininess;",""].join("\n");return t},osg.Material.prototype._shader[osg.ShaderGeneratorType.FragmentInit]=function(){var t=["uniform vec4 MaterialAmbient;","uniform vec4 MaterialDiffuse;","uniform vec4 MaterialSpecular;","uniform vec4 MaterialEmission;","uniform float MaterialShininess;",""].join("\n");return t},osg.PrimitiveSet=function(){},osg.PrimitiveSet.POINTS=0,osg.PrimitiveSet.LINES=1,osg.PrimitiveSet.LINE_LOOP=2,osg.PrimitiveSet.LINE_STRIP=3,osg.PrimitiveSet.TRIANGLES=4,osg.PrimitiveSet.TRIANGLE_STRIP=5,osg.PrimitiveSet.TRIANGLE_FAN=6,osg.DrawArrays=function(t,e,r){this.mode=t,this.first=e,this.count=r},osg.DrawArrays.prototype={draw:function(t){var e=t.getGraphicContext();e.drawArrays(this.mode,this.first,this.count)},getMode:function(){return this.mode},getCount:function(){return this.count},getFirst:function(){return this.first}},osg.DrawArrays.create=function(t,e,r){osg.log("osg.DrawArrays.create is deprecated, use new osg.DrawArrays with same arguments");var i=new osg.DrawArrays(t,e,r);return i},osg.DrawArrayLengths=function(t,e,r){this._mode=t,this._first=e,this._arrayLengths=r.slice(0)},osg.DrawArrayLengths.prototype={draw:function(t){for(var e=t.getGraphicContext(),r=this._mode,i=this._first,o=this._arrayLengths,n=0,a=o.length;a>n;n++){var s=o[n];e.drawArrays(r,i,s),i+=s}},getMode:function(){return this._mode},getNumIndices:function(){for(var t=0,e=this._arrayLengths,r=0,i=e.length;i>r;r++)t+=e[r];return t},getArrayLengths:function(){return this._arrayLengths},getFirst:function(){return this._first},setFirst:function(t){this._first=t}},osg.DrawElements=function(t,e){this.mode=osg.PrimitiveSet.POINTS,void 0!==t&&(this.mode=t),this.count=0,this.offset=0,this.indices=e,void 0!==e&&this.setIndices(e)},osg.DrawElements.prototype={getMode:function(){return this.mode},draw:function(t){t.setIndexArray(this.indices);var e=t.getGraphicContext();e.drawElements(this.mode,this.count,e.UNSIGNED_SHORT,this.offset)},setIndices:function(t){this.indices=t,this.count=t.getElements().length},getIndices:function(){return this.indices},setFirst:function(t){this.offset=t},getFirst:function(){return this.offset},setCount:function(t){this.count=t},getCount:function(){return this.count}},osg.DrawElements.create=function(t,e){return osg.log("osg.DrawElements.create is deprecated, use new osg.DrawElements with same arguments"),new osg.DrawElements(t,e)},osg.Program=function(t,e){osg.StateAttribute.call(this),void 0===osg.Program.instanceID&&(osg.Program.instanceID=0),this.instanceID=osg.Program.instanceID,osg.Program.instanceID+=1,this.program=null,this.setVertexShader(t),this.setFragmentShader(e),this.dirty=!0},osg.Program.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Program",cloneType:function(){var t=new osg.Program;return t.default_program=!0,t},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setVertexShader:function(t){this.vertex=t},setFragmentShader:function(t){this.fragment=t},getVertexShader:function(){return this.vertex},getFragmentShader:function(){return this.fragment},apply:function(){if(!this.program||this.isDirty()){if(this.default_program===!0)return;if(this.vertex.shader||this.vertex.compile(),this.fragment.shader||this.fragment.compile(),this.program=gl.createProgram(),gl.attachShader(this.program,this.vertex.shader),gl.attachShader(this.program,this.fragment.shader),gl.linkProgram(this.program),gl.validateProgram(this.program),this.uniformsCache={},this.uniformsCache.uniformKeys=[],this.attributesCache={},this.attributesCache.attributeKeys=[],!gl.getProgramParameter(this.program,gl.LINK_STATUS)&&!gl.isContextLost())return osg.error("can't link program\nvertex shader:\n"+this.vertex.text+"\n fragment shader:\n"+this.fragment.text),osg.error(gl.getProgramInfoLog(this.program)),this.setDirty(!1),null;this.cacheUniformAndAttributeList(),this.setDirty(!1)}gl.useProgram(this.program)},cacheUniformAndAttributeList:function(){var t,e,r,i;for(t=gl.getProgramParameter(this.program,gl.ACTIVE_UNIFORMS);t--;)e=gl.getActiveUniform(this.program,t).name,i=gl.getUniformLocation(this.program,e),void 0!==e&&null!==i&&void 0===this.uniformsCache[e]&&(this.uniformsCache[e]=i,this.uniformsCache.uniformKeys.push(e));for(t=gl.getProgramParameter(this.program,gl.ACTIVE_ATTRIBUTES);t--;)r=gl.getActiveAttrib(this.program,t).name,i=gl.getAttribLocation(this.program,r),void 0!==e&&null!==i&&void 0===this.attributesCache[r]&&(this.attributesCache[r]=i,this.attributesCache.attributeKeys.push(r))}}),"osg","Program"),osg.Program.create=function(t,e){var r=new osg.Program(t,e);return r},osg.Projection=function(){osg.Node.call(this),this.projection=osg.Matrix.makeIdentity([])},osg.Projection.prototype=osg.objectInehrit(osg.Node.prototype,{getProjectionMatrix:function(){return this.projection},setProjectionMatrix:function(t){this.projection=t}}),osg.Projection.prototype.objectType=osg.objectType.generate("Projection"),osg.Quat={copy:function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},makeIdentity:function(t){return osg.Quat.init(t)},zeroRotation:function(t){return osg.Quat.init(t)},init:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},sub:function(t,e,r){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r[3]=t[3]-e[3],r},add:function(t,e,r){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r[3]=t[3]+e[3],r},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},length2:function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]},neg:function(t,e){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},makeRotate:function(t,e,r,i,o){var n=1e-7,a=Math.sqrt(e*e+r*r+i*i);if(n>a)return this.init();var s=1/a,u=Math.cos(.5*t),h=Math.sin(.5*t);return void 0===o&&(o=[]),o[0]=e*h*s,o[1]=r*h*s,o[2]=i*h*s,o[3]=u,o},lerp:function(t,e,r,i){return i[0]=e[0]+(r[0]-e[0])*t,i[1]=e[1]+(r[1]-e[1])*t,i[2]=e[2]+(r[2]-e[2])*t,i[3]=e[3]+(r[3]-e[3])*t,i},slerp:function(t,e,r,i){var o=1e-5,n=r,a=this.dot(e,n);0>a&&(a=-a,this.neg(r,n));var s,u,h,c;return 1-a>o?(s=Math.acos(a),u=Math.sin(s),h=Math.sin((1-t)*s)/u,c=Math.sin(t*s)/u):(h=1-t,c=t),i[0]=e[0]*h+n[0]*c,i[1]=e[1]*h+n[1]*c,i[2]=e[2]*h+n[2]*c,i[3]=e[3]*h+n[3]*c,i},normalize:function(t,e){var r=1/this.length2(t);return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},conj:function(t,e){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},inverse:function(t,e){var r=1/this.length2(t);return this.conj(t,e),e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e},mult:function(t,e,r){return r[0]=t[0]*e[3]+t[1]*e[2]-t[2]*e[1]+t[3]*e[0],r[1]=-t[0]*e[2]+t[1]*e[3]+t[2]*e[0]+t[3]*e[1],r[2]=t[0]*e[1]-t[1]*e[0]+t[2]*e[3]+t[3]*e[2],r[3]=-t[0]*e[0]-t[1]*e[1]-t[2]*e[2]+t[3]*e[3],r},div:function(t,e,r){var i=1/e;return r[0]=t[0]*i,r[1]=t[1]*i,r[2]=t[2]*i,r[3]=t[3]*i,r},exp:function(t,e){var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=Math.exp(t[3]),o=0;return r>1e-5&&(o=i*Math.sin(r)/r),void 0===e&&(e=[]),e[0]=o*t[0],e[1]=o*t[1],e[2]=o*t[2],e[3]=i*Math.cos(r),e},ln:function(t,e){var r=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=Math.sqrt(r),o=0;return i>1e-5&&(o=Math.atan2(i,t[3])/i),void 0===e&&(e=[]),r+=t[3]*t[3],e[0]=o*t[0],e[1]=o*t[1],e[2]=o*t[2],e[3]=.5*Math.log(r),e},squad:function(t,e,r,i,o,n){var a=this.slerp(t,e,o),s=this.slerp(t,r,i);return this.slerp(2*t*(1-t),a,s,n)},computeTangent:function(t,e,r,i){var o,n,a=this.inv(e);return this.mult(r,a,o),this.ln(o,o),this.mult(t,a,n),this.ln(n,n),this.add(o,n,o),this.div(o,-4,o),this.exp(o,n),this.mult(n,q1,i)}},osg.RenderBin=function(){this._leafs=[],this.positionedAttribute=[],this._renderStage=void 0,this._bins={},this.stateGraphList=[],this._parent=void 0,this._binNum=0,this._sorted=!1,this._sortMode=osg.RenderBin.SORT_BY_STATE},osg.RenderBin.SORT_BY_STATE=0,osg.RenderBin.SORT_BACK_TO_FRONT=1,osg.RenderBin.BinPrototypes={RenderBin:function(){return new osg.RenderBin},DepthSortedBin:function(){var t=new osg.RenderBin;return t._sortMode=osg.RenderBin.SORT_BACK_TO_FRONT,t}},osg.RenderBin.prototype={_createRenderBin:function(t){return void 0===t||void 0===osg.RenderBin.BinPrototypes[t]?osg.RenderBin.BinPrototypes.RenderBin():osg.RenderBin.BinPrototypes[t]()},getStateGraphList:function(){return this.stateGraphList},copyLeavesFromStateGraphListToRenderLeafList:function(){this._leafs.splice(0,this._leafs.length);for(var t=!1,e=0,r=this.stateGraphList.length;r>e;e++)for(var i=this.stateGraphList[e].leafs,o=0,n=i.length;n>o;o++){var a=i[o];isNaN(a.depth)?t=!0:this._leafs.push(a)}t&&osg.debug("warning: RenderBin::copyLeavesFromStateGraphListToRenderLeafList() detected NaN depth values, database may be corrupted."),this.stateGraphList.splice(0,this.stateGraphList.length)},sortBackToFront:function(){this.copyLeavesFromStateGraphListToRenderLeafList();var t=function(t,e){return e.depth-t.depth};this._leafs.sort(t)},sortImplementation:function(){var t=osg.RenderBin;switch(this._sortMode){case t.SORT_BACK_TO_FRONT:this.sortBackToFront();break;case t.SORT_BY_STATE:}},sort:function(){if(!this._sorted){for(var t=this._bins,e=Object.keys(t),r=0,i=e.length;i>r;r++)t[e[r]].sort();this.sortImplementation(),_sorted=!0}},setParent:function(t){this._parent=t},getParent:function(){return this._parent},getBinNumber:function(){return this._binNum},findOrInsert:function(t,e){var r=this._bins[t];return void 0===r&&(r=this._createRenderBin(e),r._parent=this,r._binNum=t,r._renderStage=this._renderStage,this._bins[t]=r),r},getStage:function(){return this._renderStage},addStateGraph:function(t){this.stateGraphList.push(t)},reset:function(){this.stateGraphList.length=0,this._bins={},this.positionedAttribute.length=0,this._leafs.length=0,this._sorted=!1},applyPositionedAttribute:function(t,e){for(var r=0,i=e.length;i>r;r++){var o=e[r],n=o[1],a=o[0];t.setGlobalDefaultValue(n),n.apply(t),n.applyPositionedUniform(a,t),t.haveAppliedAttribute(n)}},drawImplementation:function(t,e){for(var r=e,i=Object.keys(this._bins),o=this._bins,n=[],a=0,s=i.length;s>a;a++){var u=i[a];n.push(o[u])}var h=function(t,e){return t._binNum-e._binNum};n.sort(h);for(var c,g=0,l=n.length;l>g&&(c=n[g],!(c.getBinNumber()>0));g++)r=c.drawImplementation(t,r);for(r=this.drawLeafs(t,r);l>g;g++)c=n[g],r=c.drawImplementation(t,r);return r},drawLeafs:function(t,e){var r,i,o,n,a=this.stateGraphList,s=this._leafs,u=e,h=[],c=osg.Matrix;u&&osg.StateGraph.prototype.moveToRootStateGraph(t,e.parent);for(var g,l,d,f,p,m=0,v=s.length;v>m;m++)g=s[m],l=!1,void 0!==u?(d=u.parent,f=d.parent,p=g.parent,f!==p.parent?(p.moveStateGraph(t,f,p.parent),t.pushStateSet(p.stateset),l=!0):p!==d&&(t.pushStateSet(p.stateset),l=!0)):(g.parent.moveStateGraph(t,void 0,g.parent.parent),t.pushStateSet(g.parent.stateset),l=!0),l===!0&&(t.apply(),n=t.getLastProgramApplied(),i=n.uniformsCache[t.modelViewMatrix.name],o=n.uniformsCache[t.projectionMatrix.name],r=n.uniformsCache[t.normalMatrix.name]),void 0!==i&&(t.modelViewMatrix.set(g.modelview),t.modelViewMatrix.apply(i)),void 0!==o&&(t.projectionMatrix.set(g.projection),t.projectionMatrix.apply(o)),void 0!==r&&(c.copy(g.modelview,h),h[12]=0,h[13]=0,h[14]=0,c.inverse(h,h),c.transpose(h,h),t.normalMatrix.set(h),t.normalMatrix.apply(r)),g.geometry.drawImplementation(t),l===!0&&(t.popGeneratedProgram(),t.popStateSet()),u=g;for(var _=0,S=a.length;S>_;_++)for(var y=a[_],b=0,T=y.leafs.length;T>b;b++)g=y.leafs[b],l=!1,void 0!==u?(d=u.parent,f=d.parent,p=g.parent,f!==p.parent?(p.moveStateGraph(t,f,p.parent),t.pushStateSet(p.stateset),l=!0):p!==d&&(t.pushStateSet(p.stateset),l=!0)):(g.parent.moveStateGraph(t,void 0,g.parent.parent),t.pushStateSet(g.parent.stateset),l=!0),l===!0&&(t.apply(),n=t.getLastProgramApplied(),i=n.uniformsCache[t.modelViewMatrix.name],o=n.uniformsCache[t.projectionMatrix.name],r=n.uniformsCache[t.normalMatrix.name]),void 0!==i&&(t.modelViewMatrix.set(g.modelview),t.modelViewMatrix.apply(i)),void 0!==o&&(t.projectionMatrix.set(g.projection),t.projectionMatrix.apply(o)),void 0!==r&&(c.copy(g.modelview,h),h[12]=0,h[13]=0,h[14]=0,c.inverse(h,h),c.transpose(h,h),t.normalMatrix.set(h),t.normalMatrix.apply(r)),g.geometry.drawImplementation(t),l===!0&&(t.popGeneratedProgram(),t.popStateSet()),u=g;return u}},osg.RenderStage=function(){osg.RenderBin.call(this),this.positionedAttribute=[],this.clearDepth=1,this.clearColor=[0,0,0,1],this.clearMask=osg.Camera.COLOR_BUFFER_BIT|osg.Camera.DEPTH_BUFFER_BIT,this.camera=void 0,this.viewport=void 0,this.preRenderList=[],this.postRenderList=[],this._renderStage=this},osg.RenderStage.prototype=osg.objectInehrit(osg.RenderBin.prototype,{reset:function(){osg.RenderBin.prototype.reset.call(this),this.preRenderList.length=0,this.postRenderList.length=0},setClearDepth:function(t){this.clearDepth=t},getClearDepth:function(){return this.clearDepth},setClearColor:function(t){this.clearColor=t},getClearColor:function(){return this.clearColor},setClearMask:function(t){this.clearMask=t},getClearMask:function(){return this.clearMask},setViewport:function(t){this.viewport=t},getViewport:function(){return this.viewport},setCamera:function(t){this.camera=t},addPreRenderStage:function(t,e){for(var r=0,i=this.preRenderList.length;i>r;r++){var o=this.preRenderList[r];if(o.order>e)break}this.preRenderList.length>r?this.preRenderList=this.preRenderList.splice(r,0,{order:e,renderStage:t}):this.preRenderList.push({order:e,renderStage:t})},addPostRenderStage:function(t,e){for(var r=0,i=this.postRenderList.length;i>r;r++){var o=this.postRenderList[r];if(o.order>e)break}this.postRenderList.length>r?this.postRenderList=this.postRenderList.splice(r,0,{order:e,renderStage:t}):this.postRenderList.push({order:e,renderStage:t})},drawPreRenderStages:function(t,e){for(var r=e,i=0,o=this.preRenderList.length;o>i;++i){var n=this.preRenderList[i].renderStage;r=n.draw(t,r)}return r},draw:function(t,e){var r=this.drawPreRenderStages(t,e);return r=this.drawImplementation(t,r),r=this.drawPostRenderStages(t,r)},sort:function(){for(var t=0,e=this.preRenderList.length;e>t;++t)this.preRenderList[t].renderStage.sort();for(osg.RenderBin.prototype.sort.call(this),this.postRenderList.length;e>t;++t)this.postRenderList[t].renderStage.sort()},drawPostRenderStages:function(t,e){for(var r=e,i=0,o=this.postRenderList.length;o>i;++i){var n=this.postRenderList[i].renderStage;r=n.draw(t,r)}return r},applyCamera:function(t){var e=t.getGraphicContext();if(void 0===this.camera)return e.bindFramebuffer(e.FRAMEBUFFER,null),void 0;var r=this.camera.getViewport(),i=this.camera.frameBufferObject;if(i||(i=new osg.FrameBufferObject,this.camera.frameBufferObject=i),i.isDirty()&&void 0!==this.camera.attachments)for(var o in this.camera.attachments){var n,a=this.camera.attachments[o];void 0===a.texture?n={attachment:o,format:a.format,width:r.width(),height:r.height()}:void 0!==a.texture&&(n={attachment:o,texture:a.texture,level:a.level},a.format&&(n.format=a.format)),i.setAttachment(n)}i.apply(t)},drawImplementation:function(t,e){var r=t.getGraphicContext();this.applyCamera(t),void 0===this.viewport&&osg.log("RenderStage does not have a valid viewport"),t.applyAttribute(this.viewport),this.clearMask&r.COLOR_BUFFER_BIT&&r.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),this.clearMask&r.DEPTH_BUFFER_BIT&&(r.depthMask(!0),r.clearDepth(this.clearDepth)),r.clear(this.clearMask),this.positionedAttribute&&this.applyPositionedAttribute(t,this.positionedAttribute);var i=osg.RenderBin.prototype.drawImplementation.call(this,t,e);return i}}),osg.ShaderGenerator=function(){this.cache=[]},osg.ShaderGenerator.prototype={getActiveTypeMember:function(t){for(var e=[],r=0,i=t.attributeMap.attributeKeys.length;i>r;r++){var o=t.attributeMap.attributeKeys[r],n=t.attributeMap[o];(0!==n.length||void 0!==n.globalDefault.applyPositionedUniform)&&(void 0!==n.globalDefault.getOrCreateUniforms||void 0!==n.globalDefault.writeToShader)&&e.push(o)}for(var a=0,s=t.textureAttributeMapList.length;s>a;a++){var u=t.textureAttributeMapList[a];if(void 0!==u)for(var h=0,c=u.attributeKeys.length;c>h;h++){var g=u.attributeKeys[h],l=u[g];0!==l.length&&(void 0!==l.globalDefault.getOrCreateUniforms||void 0!==l.globalDefault.writeToShader)&&e.push(g+a)}}return e},getActiveAttributeMapKeys:function(t){for(var e=[],r=0,i=t.attributeMap.attributeKeys.length;i>r;r++){var o=t.attributeMap.attributeKeys[r],n=t.attributeMap[o];(0!==n.length||void 0!==n.globalDefault.applyPositionedUniform)&&(void 0!==n.globalDefault.getOrCreateUniforms||void 0!==n.globalDefault.writeToShader)&&e.push(o)}return e},getActiveTextureAttributeMapKeys:function(t){for(var e=[],r=0,i=t.textureAttributeMapList.length;i>r;r++){var o=t.textureAttributeMapList[r];if(void 0!==o){e[r]=[];for(var n=0,a=o.attributeKeys.length;a>n;n++){var s=o.attributeKeys[n],u=o[s];0!==u.length&&(void 0!==u.globalDefault.getOrCreateUniforms||void 0!==u.globalDefault.writeToShader)&&e[r].push(s)}}}return e},getActiveUniforms:function(t,e,r){for(var i={},o=0,n=e.length;n>o;o++){var a=e[o];if(void 0!==t.attributeMap[a].globalDefault.getOrCreateUniforms)for(var s=t.attributeMap[a].globalDefault.getOrCreateUniforms(),u=0,h=s.uniformKeys.length;h>u;u++){var c=s.uniformKeys[u],g=s[c];i[g.name]=g}}for(var l=0,d=r.length;d>l;l++){var f=r[l];if(void 0!==f)for(var p=0,m=f.length;m>p;p++){var v=f[p],_=t.textureAttributeMapList[l][v].globalDefault;if(void 0!==_.getOrCreateUniforms)for(var S=_.getOrCreateUniforms(l),y=0,b=S.uniformKeys.length;b>y;y++){var T=S.uniformKeys[y],M=S[T];i[M.name]=M}}}var x=[];for(var C in i)x.push(C);return i.uniformKeys=x,i},getOrCreateProgram:function(t){for(var e=this.getActiveTypeMember(t),r=0,i=this.cache.length;i>r;++r)if(0===this.compareAttributeMap(e,this.cache[r].flattenKeys))return this.cache[r];var o=this.getActiveAttributeMapKeys(t),n=this.getActiveTextureAttributeMapKeys(t),a=this.getOrCreateVertexShader(t,o,n),s=this.getOrCreateFragmentShader(t,o,n),u=new osg.Program(new osg.Shader(gl.VERTEX_SHADER,a),new osg.Shader(gl.FRAGMENT_SHADER,s));return u.flattenKeys=e,u.activeAttributeKeys=o,u.activeTextureAttributeKeys=n,u.activeUniforms=this.getActiveUniforms(t,o,n),u.generated=!0,this.cache.push(u),u},compareAttributeMap:function(t,e){for(var r,i=0,o=t.length;o>i;i++)if(r=t[i],-1===e.indexOf(r))return 1;return e.length!==t.length?-1:0},fillTextureShader:function(t,e,r){for(var i="",o={},n=0,a=e.length;a>n;n++){var s=e[n];if(void 0!==s)for(var u=t[n],h=0,c=s.length;c>h;h++){var g=s[h],l=u[g].globalDefault;void 0!==l.generateShaderCommon&&void 0===o[g]&&(i+=l.generateShaderCommon(n,r),o[g]=!0),l.generateShader&&(i+=l.generateShader(n,r))}}return i},fillShader:function(t,e,r){for(var i="",o={},n=0,a=e.length;a>n;n++){var s=e[n],u=t[s].globalDefault,h=u.getType();void 0!==u.generateShaderCommon&&void 0===o[h]&&(i+=u.generateShaderCommon(r),o[h]=!0),u.generateShader&&(i+=u.generateShader(r))}return i},getOrCreateVertexShader:function(t,e,r){var i=osg.ShaderGeneratorType,o=["","#ifdef GL_ES","precision highp float;","#endif","attribute vec3 Vertex;","attribute vec4 Color;","attribute vec3 Normal;","uniform float ArrayColorEnabled;","uniform mat4 ModelViewMatrix;","uniform mat4 ProjectionMatrix;","uniform mat4 NormalMatrix;","varying vec4 VertexColor;",""].join("\n");o+=this._writeShaderFromMode(t,e,r,i.VertexInit);var n=["","vec4 ftransform() {","  return ProjectionMatrix * ModelViewMatrix * vec4(Vertex, 1.0);","}"].join("\n");o+=n,o+=this._writeShaderFromMode(t,e,r,i.VertexFunction);var a=["","void main(void) {","  gl_Position = ftransform();","  if (ArrayColorEnabled == 1.0)","    VertexColor = Color;","  else","    VertexColor = vec4(1.0,1.0,1.0,1.0);","  gl_PointSize = 1.0;",""].join("\n");return o+=a,o+=this._writeShaderFromMode(t,e,r,i.VertexMain),o+=["}",""].join("\n")},_writeShaderFromMode:function(t,e,r,i){var o="";return o+=this.fillTextureShader(t.textureAttributeMapList,r,i),o+=this.fillShader(t.attributeMap,e,i)},getOrCreateFragmentShader:function(t,e,r){var i=["","#ifdef GL_ES","precision highp float;","#endif","varying vec4 VertexColor;","uniform float ArrayColorEnabled;","vec4 fragColor;",""].join("\n"),o=osg.ShaderGeneratorType;return i+=this._writeShaderFromMode(t,e,r,o.FragmentInit),i+=this._writeShaderFromMode(t,e,r,o.FragmentFunction),i+=["void main(void) {","  fragColor = VertexColor;",""].join("\n"),i+=this._writeShaderFromMode(t,e,r,o.FragmentMain),i+=this._writeShaderFromMode(t,e,r,o.FragmentEnd),i+=["","  gl_FragColor = fragColor;","}"].join("\n")}},osg.createTexturedBoxGeometry=function(t,e,r,i,o,n){var a,s,u,h=new osg.Geometry;a=i/2,s=o/2,u=n/2;var c=[],g=[],l=[];c[0]=t-a,c[1]=e-s,c[2]=r+u,l[0]=0,l[1]=-1,l[2]=0,g[0]=0,g[1]=1,c[3]=t-a,c[4]=e-s,c[5]=r-u,l[3]=0,l[4]=-1,l[5]=0,g[2]=0,g[3]=0,c[6]=t+a,c[7]=e-s,c[8]=r-u,l[6]=0,l[7]=-1,l[8]=0,g[4]=1,g[5]=0,c[9]=t+a,c[10]=e-s,c[11]=r+u,l[9]=0,l[10]=-1,l[11]=0,g[6]=1,g[7]=1,c[12]=t+a,c[13]=e+s,c[14]=r+u,l[12]=0,l[13]=1,l[14]=0,g[8]=0,g[9]=1,c[15]=t+a,c[16]=e+s,c[17]=r-u,l[15]=0,l[16]=1,l[17]=0,g[10]=0,g[11]=0,c[18]=t-a,c[19]=e+s,c[20]=r-u,l[18]=0,l[19]=1,l[20]=0,g[12]=1,g[13]=0,c[21]=t-a,c[22]=e+s,c[23]=r+u,l[21]=0,l[22]=1,l[23]=0,g[14]=1,g[15]=1,c[24]=t+a,c[25]=e-s,c[26]=r+u,l[24]=1,l[25]=0,l[26]=0,g[16]=0,g[17]=1,c[27]=t+a,c[28]=e-s,c[29]=r-u,l[27]=1,l[28]=0,l[29]=0,g[18]=0,g[19]=0,c[30]=t+a,c[31]=e+s,c[32]=r-u,l[30]=1,l[31]=0,l[32]=0,g[20]=1,g[21]=0,c[33]=t+a,c[34]=e+s,c[35]=r+u,l[33]=1,l[34]=0,l[35]=0,g[22]=1,g[23]=1,c[36]=t-a,c[37]=e+s,c[38]=r+u,l[36]=-1,l[37]=0,l[38]=0,g[24]=0,g[25]=1,c[39]=t-a,c[40]=e+s,c[41]=r-u,l[39]=-1,l[40]=0,l[41]=0,g[26]=0,g[27]=0,c[42]=t-a,c[43]=e-s,c[44]=r-u,l[42]=-1,l[43]=0,l[44]=0,g[28]=1,g[29]=0,c[45]=t-a,c[46]=e-s,c[47]=r+u,l[45]=-1,l[46]=0,l[47]=0,g[30]=1,g[31]=1,c[48]=t-a,c[49]=e+s,c[50]=r+u,l[48]=0,l[49]=0,l[50]=1,g[32]=0,g[33]=1,c[51]=t-a,c[52]=e-s,c[53]=r+u,l[51]=0,l[52]=0,l[53]=1,g[34]=0,g[35]=0,c[54]=t+a,c[55]=e-s,c[56]=r+u,l[54]=0,l[55]=0,l[56]=1,g[36]=1,g[37]=0,c[57]=t+a,c[58]=e+s,c[59]=r+u,l[57]=0,l[58]=0,l[59]=1,g[38]=1,g[39]=1,c[60]=t+a,c[61]=e+s,c[62]=r-u,l[60]=0,l[61]=0,l[62]=-1,g[40]=0,g[41]=1,c[63]=t+a,c[64]=e-s,c[65]=r-u,l[63]=0,l[64]=0,l[65]=-1,g[42]=0,g[43]=0,c[66]=t-a,c[67]=e-s,c[68]=r-u,l[66]=0,l[67]=0,l[68]=-1,g[44]=1,g[45]=0,c[69]=t-a,c[70]=e+s,c[71]=r-u,l[69]=0,l[70]=0,l[71]=-1,g[46]=1,g[47]=1;var d=[];d[0]=0,d[1]=1,d[2]=2,d[3]=0,d[4]=2,d[5]=3,d[6]=4,d[7]=5,d[8]=6,d[9]=4,d[10]=6,d[11]=7,d[12]=8,d[13]=9,d[14]=10,d[15]=8,d[16]=10,d[17]=11,d[18]=12,d[19]=13,d[20]=14,d[21]=12,d[22]=14,d[23]=15,d[24]=16,d[25]=17,d[26]=18,d[27]=16,d[28]=18,d[29]=19,d[30]=20,d[31]=21,d[32]=22,d[33]=20,d[34]=22,d[35]=23,h.getAttributes().Vertex=new osg.BufferArray(osg.BufferArray.ARRAY_BUFFER,c,3),h.getAttributes().Normal=new osg.BufferArray(osg.BufferArray.ARRAY_BUFFER,l,3),h.getAttributes().TexCoord0=new osg.BufferArray(osg.BufferArray.ARRAY_BUFFER,g,2);var f=new osg.DrawElements(osg.PrimitiveSet.TRIANGLES,new osg.BufferArray(osg.BufferArray.ELEMENT_ARRAY_BUFFER,d,1));return h.getPrimitives().push(f),h},osg.createTexturedQuadGeometry=function(t,e,r,i,o,n,a,s,u,h,c,g,l){void 0===g&&void 0===l&&(g=h,l=c,h=0,c=0);var d=new osg.Geometry,f=[];f[0]=t+a,f[1]=e+s,f[2]=r+u,f[3]=t,f[4]=e,f[5]=r,f[6]=t+i,f[7]=e+o,f[8]=r+n,f[9]=t+i+a,f[10]=e+o+s,f[11]=r+n+u,void 0===g&&(g=1),void 0===l&&(l=1);var p=[];p[0]=h,p[1]=l,p[2]=h,p[3]=c,p[4]=g,p[5]=c,p[6]=g,p[7]=l;var m=osg.Vec3.cross([i,o,n],[a,s,u],[]),v=[];v[0]=m[0],v[1]=m[1],v[2]=m[2],v[3]=m[0],v[4]=m[1],v[5]=m[2],v[6]=m[0],v[7]=m[1],v[8]=m[2],v[9]=m[0],v[10]=m[1],v[11]=m[2];var _=[];_[0]=0,_[1]=1,_[2]=2,_[3]=0,_[4]=2,_[5]=3,d.getAttributes().Vertex=new osg.BufferArray(osg.BufferArray.ARRAY_BUFFER,f,3),d.getAttributes().Normal=new osg.BufferArray(osg.BufferArray.ARRAY_BUFFER,v,3),d.getAttributes().TexCoord0=new osg.BufferArray(osg.BufferArray.ARRAY_BUFFER,p,2);var S=new osg.DrawElements(osg.PrimitiveSet.TRIANGLES,new osg.BufferArray(osg.BufferArray.ELEMENT_ARRAY_BUFFER,_,1));return d.getPrimitives().push(S),d},osg.createTexturedBox=function(t,e,r,i,o,n){return osg.log("osg.createTexturedBox is deprecated use instead osg.createTexturedBoxGeometry"),osg.createTexturedBoxGeometry(t,e,r,i,o,n)},osg.createTexturedQuad=function(t,e,r,i,o,n,a,s,u,h,c,g,l){return osg.log("osg.createTexturedQuad is deprecated use instead osg.createTexturedQuadGeometry"),osg.createTexturedQuadGeometry(t,e,r,i,o,n,a,s,u,h,c,g,l)},osg.createAxisGeometry=function(t){void 0===t&&(t=5),void 0===osg.createAxisGeometry.getShader&&(osg.createAxisGeometry.getShader=function(){if(void 0===osg.createAxisGeometry.getShader.program){var t=["#ifdef GL_ES","precision highp float;","#endif","attribute vec3 Vertex;","attribute vec4 Color;","uniform mat4 ModelViewMatrix;","uniform mat4 ProjectionMatrix;","","varying vec4 FragColor;","","vec4 ftransform() {","return ProjectionMatrix * ModelViewMatrix * vec4(Vertex, 1.0);","}","","void main(void) {","gl_Position = ftransform();","FragColor = Color;","}"].join("\n"),e=["#ifdef GL_ES","precision highp float;","#endif","varying vec4 FragColor;","void main(void) {","gl_FragColor = FragColor;","}"].join("\n"),r=new osg.Program(new osg.Shader(gl.VERTEX_SHADER,t),new osg.Shader(gl.FRAGMENT_SHADER,e));osg.createAxisGeometry.getShader.program=r}return osg.createAxisGeometry.getShader.program});var e=new osg.Geometry,r=[];r.push(0,0,0),r.push(t,0,0),r.push(0,0,0),r.push(0,t,0),r.push(0,0,0),r.push(0,0,t);var i=[];i.push(1,0,0,1),i.push(1,0,0,1),i.push(0,1,0,1),i.push(0,1,0,1),i.push(0,0,1,1),i.push(0,0,1,1),e.getAttributes().Vertex=new osg.BufferArray(osg.BufferArray.ARRAY_BUFFER,r,3),e.getAttributes().Color=new osg.BufferArray(osg.BufferArray.ARRAY_BUFFER,i,4);var o=new osg.DrawArrays(osg.PrimitiveSet.LINES,0,6);return e.getPrimitives().push(o),e.getOrCreateStateSet().setAttributeAndMode(osg.createAxisGeometry.getShader()),e},osg.createTexturedSphere=function(t,e,r,i,o,n,a){t=t||50,i=void 0!==i?i:0,o=void 0!==o?o:2*Math.PI,n=void 0!==n?n:0,a=void 0!==a?a:Math.PI;var s,u,h=Math.max(3,Math.floor(e)||8),c=Math.max(2,Math.floor(r)||6),g=[],l=[],d=[],f=[];for(u=0;c>=u;u++){var p=[],m=[];for(s=0;h>=s;s++){var v=s/h,_=u/c,S={};S.x=-t*Math.cos(i+v*o)*Math.sin(n+_*a),S.y=t*Math.cos(n+_*a),S.z=t*Math.sin(i+v*o)*Math.sin(n+_*a),d.push(S),p.push(d.length-1),m.push({u:v,v:1-_})}g.push(p),l.push(m)}var y=[],b=[],T=[],M=0;for(u=0;c>u;u++)for(s=0;h>s;s++){var x={},C={},A={},w={},x=g[u][s+1],C=g[u][s],A=g[u+1][s],w=g[u+1][s+1],E=d[x],F=d[C],V=d[A],R=d[w];y.push(E.x),y.push(E.y),y.push(E.z),y.push(F.x),y.push(F.y),y.push(F.z),y.push(V.x),y.push(V.y),y.push(V.z),y.push(R.x),y.push(R.y),y.push(R.z),M+=4;var U=M-4;
f.push(U),f.push(U+1),f.push(U+2),f.push(U),f.push(U+2),f.push(U+3);var P=osg.Vec3.normalize([E.x,E.y,E.z],[]),N=osg.Vec3.normalize([F.x,F.y,F.z],[]),D=osg.Vec3.normalize([V.x,V.y,V.z],[]),L=osg.Vec3.normalize([R.x,R.y,R.z],[]);b.push(P[0]),b.push(P[1]),b.push(P[2]),b.push(N[0]),b.push(N[1]),b.push(N[2]),b.push(D[0]),b.push(D[1]),b.push(D[2]),b.push(L[0]),b.push(L[1]),b.push(L[2]);var B=l[u][s+1],O=l[u][s],k=l[u+1][s],I=l[u+1][s+1];T.push(B.u),T.push(B.v),T.push(O.u),T.push(O.v),T.push(k.u),T.push(k.v),T.push(I.u),T.push(I.v)}var j=new osg.Geometry;j.getAttributes().Vertex=new osg.BufferArray(gl.ARRAY_BUFFER,y,3),j.getAttributes().Normal=new osg.BufferArray(gl.ARRAY_BUFFER,b,3),j.getAttributes().TexCoord0=new osg.BufferArray(gl.ARRAY_BUFFER,T,2);var q=new osg.DrawElements(gl.TRIANGLES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,f,1));return j.getPrimitives().push(q),j},osg.Stack=function(){},osg.Stack.create=function(){var t=[];return t.globalDefault=void 0,t.lastApplied=void 0,t.back=function(){return this[this.length-1]},t},osg.StateGraph=function(){this.depth=0,this.children={},this.children.keys=[],this.leafs=[],this.stateset=void 0,this.parent=void 0},osg.StateGraph.prototype={clean:function(){this.leafs.splice(0,this.leafs.length),this.stateset=void 0,this.parent=void 0,this.depth=0;for(var t,e=this.children.keys,r=0,i=e.length;i>r;r++)t=e[r],this.children[t].clean(),osg.memoryPools.stateGraph.put(this.children[t]);this.children={},e.splice(0,e.length),this.children.keys=e},getStateSet:function(){return this.stateset},findOrInsert:function(t){var e;return this.children[t.id]?e=this.children[t.id]:(e=osg.memoryPools.stateGraph.get(),e.parent=this,e.depth=this.depth+1,e.stateset=t,this.children[t.id]=e,this.children.keys.push(t.id)),e},moveToRootStateGraph:function(t,e){for(;e;)e.stateSet&&t.popStateSet(),e=e._parent},moveStateGraph:function(t,e,r){var i,o;if(r!==e&&void 0!==r)if(void 0!==e){if(e.parent===r.parent)return void 0!==e.stateset&&t.popStateSet(),void 0!==r.stateset&&t.pushStateSet(r.stateset),void 0;for(;e.depth>r.depth;)void 0!==e.stateset&&t.popStateSet(),e=e.parent;for(i=[];r.depth>e.depth;)void 0!==r.stateset&&i.push(r.stateset),r=r.parent;for(;e!==r;)void 0!==e.stateset&&t.popStateSet(),e=e.parent,void 0!==r.stateset&&i.push(r.stateset),r=r.parent;for(i.reverse(),stackLength=i.length,o=0;stackLength>o;++o)t.pushStateSet(i[o])}else{i=[];do void 0!==r.stateset&&i.push(r.stateset),r=r.parent;while(r);for(i.reverse(),o=0,l=i.length;l>o;++o)t.pushStateSet(i[o])}}},osg.State=function(){this._graphicContext=void 0,this.currentVBO=null,this.currentVAO=null,this.vertexAttribList=[],this.programs=osg.Stack.create(),this.stateSets=osg.Stack.create(),this.uniforms={},this.uniforms.uniformKeys=[],this.textureAttributeMapList=[],this.attributeMap={},this.attributeMap.attributeKeys=[],this.modeMap={},this.shaderGenerator=new osg.ShaderGenerator,this.modelViewMatrix=osg.Uniform.createMatrix4(osg.Matrix.makeIdentity([]),"ModelViewMatrix"),this.projectionMatrix=osg.Uniform.createMatrix4(osg.Matrix.makeIdentity([]),"ProjectionMatrix"),this.normalMatrix=osg.Uniform.createMatrix4(osg.Matrix.makeIdentity([]),"NormalMatrix"),this.uniforms.ArrayColorEnabled=osg.Stack.create(),this.uniforms.ArrayColorEnabled.globalDefault=osg.Uniform.createFloat1(0,"ArrayColorEnabled"),this.uniforms.ArrayColorEnabled.uniformKeys=[],this.uniforms.ArrayColorEnabled.uniformKeys.push("ArrayColorEnabled"),this.vertexAttribMap={},this.vertexAttribMap._disable=[],this.vertexAttribMap._keys=[]},osg.State.prototype={setGraphicContext:function(t){this._graphicContext=t},getGraphicContext:function(){return this._graphicContext},pushStateSet:function(t){if(this.stateSets.push(t),t.attributeMap&&this.pushAttributeMap(this.attributeMap,t.attributeMap),t.textureAttributeMapList)for(var e=t.textureAttributeMapList,r=0,i=e.length;i>r;r++)void 0!==e[r]&&(this.textureAttributeMapList[r]||(this.textureAttributeMapList[r]={},this.textureAttributeMapList[r].attributeKeys=[]),this.pushAttributeMap(this.textureAttributeMapList[r],e[r]));t.uniforms&&this.pushUniformsList(this.uniforms,t.uniforms)},applyStateSet:function(t){this.pushStateSet(t),this.apply(),this.popStateSet()},popAllStateSets:function(){for(;this.stateSets.length;)this.popStateSet()},popStateSet:function(){var t=this.stateSets.pop();if(t.program&&this.programs.pop(),t.attributeMap&&this.popAttributeMap(this.attributeMap,t.attributeMap),t.textureAttributeMapList)for(var e=t.textureAttributeMapList,r=0,i=e.length;i>r;r++)void 0!==e[r]&&this.popAttributeMap(this.textureAttributeMapList[r],e[r]);t.uniforms&&this.popUniformsList(this.uniforms,t.uniforms)},haveAppliedAttribute:function(t){var e=t.getTypeMember(),r=this.attributeMap[e];r.lastApplied=t,r.asChanged=!0},applyAttribute:function(t){var e=t.getTypeMember(),r=this.attributeMap[e];void 0===r&&(r=osg.Stack.create(),this.attributeMap[e]=r,this.attributeMap[e].globalDefault=t.cloneType(),this.attributeMap.attributeKeys.push(e)),r.lastApplied!==t&&(t.apply&&t.apply(this),r.lastApplied=t,r.asChanged=!0)},applyTextureAttribute:function(t,e){var r=this.getGraphicContext();r.activeTexture(r.TEXTURE0+t);var i=e.getTypeMember();this.textureAttributeMapList[t]||(this.textureAttributeMapList[t]={},this.textureAttributeMapList[t].attributeKeys=[]);var o=this.textureAttributeMapList[t][i];void 0===o&&(o=osg.Stack.create(),this.textureAttributeMapList[t][i]=o,o.globalDefault=e.cloneType(),this.textureAttributeMapList[t].attributeKeys.push(i)),o.lastApplied!==e&&(e.apply&&e.apply(this),o.lastApplied=e,o.asChanged=!0)},getLastProgramApplied:function(){return this.programs.lastApplied},pushGeneratedProgram:function(){var t;if(void 0!==this.attributeMap.Program&&0!==this.attributeMap.Program.length&&(t=this.attributeMap.Program.back().object,value=this.attributeMap.Program.back().value,void 0!==t&&value!==osg.StateAttribute.OFF))return this.programs.push(this.getObjectPair(t,value)),t;var e={textureAttributeMapList:this.textureAttributeMapList,attributeMap:this.attributeMap},r=this.stateSets.back().getShaderGenerator();return void 0===r&&(r=this.shaderGenerator),t=r.getOrCreateProgram(e),this.programs.push(this.getObjectPair(t,osg.StateAttribute.ON)),t},popGeneratedProgram:function(){this.programs.pop()},applyWithoutProgram:function(){this.applyAttributeMap(this.attributeMap),this.applyTextureAttributeMapList(this.textureAttributeMapList)},apply:function(){var t=this._graphicContext;this.applyAttributeMap(this.attributeMap),this.applyTextureAttributeMapList(this.textureAttributeMapList),this.pushGeneratedProgram();var e=this.programs.back().object;this.programs.lastApplied!==e&&(e.apply(this),this.programs.lastApplied=e);var r,i,o,n,a,s=this;if(e.generated===!0){r=e.uniformsCache,i=e.activeUniforms;a=this.uniforms,function(){var t=e.uniformsCache,r=e.activeUniforms,i=e.foreignUniforms;i||(function(){i=[];for(var o=0,n=t.uniformKeys.length;n>o;o++){var a=t.uniformKeys[o],u=t[a];void 0!==u&&void 0===r[a]&&a!==s.modelViewMatrix.name&&a!==s.projectionMatrix.name&&a!==s.normalMatrix.name&&"ArrayColorEnabled"!==a&&i.push(a)}e.foreignUniforms=i}(),function(){for(var e=0,i=r.uniformKeys.length;i>e;e++){var o=r.uniformKeys[e],n=t[o];(void 0===n||null===n)&&delete r[o]}for(var a=Object.keys(r),s=0,u=a.length;u>s;s++)if("uniformKeys"===a[s]){a.splice(s,1);break}r.uniformKeys=a}()),function(){for(var e=0,i=r.uniformKeys.length;i>e;e++){var o=r.uniformKeys[e],n=t[o];r[o].apply(n)}}(),function(){for(var e=0,r=i.length;r>e;e++){var o,n=i[e],s=a[n],u=t[n];void 0!==s&&(o=0===s.length?s.globalDefault:s.back().object,o.apply(u))}}()}()}else{var u,h,c,g=e.program;r=e.uniformsCache,a=this.uniforms,i=[];var d,f,p,m=e.trackAttributes,v=e.trackUniforms;if(void 0!==m&&void 0===v){var _=e.trackAttributes.attributeKeys;if(void 0!==_)for(o=0,l=_.length;l>o;o++)if(n=_[o],attributeStack=this.attributeMap[n],void 0!==attributeStack&&(d=attributeStack.globalDefault,void 0!==d.getOrCreateUniforms))for(f=d.getOrCreateUniforms(),p=0,b=f.uniformKeys.length;b>p;p++)i.push(f[f.uniformKeys[p]]);var S=e.trackAttributes.textureAttributeKeys;if(void 0!==S)for(o=0,l=S.length;l>o;o++){var y=S[o];if(void 0!==y)for(var T=0,M=y.length;M>T;T++){n=y[T];var x=this.textureAttributeMapList[o];if(void 0!==x&&(attributeStack=x[n],void 0!==attributeStack&&(d=attributeStack.globalDefault,void 0!==d.getOrCreateUniforms)))for(f=d.getOrCreateUniforms(o),p=0,b=f.uniformKeys.length;b>p;p++)i.push(f[f.uniformKeys[p]])}}var C={};for(o=0,l=i.length;l>o;o++){var A=i[o],w=t.getUniformLocation(g,A.name);void 0!==w&&null!==w&&(C[A.name]=i[o])}e.trackUniforms=C}for(o=0,l=r.uniformKeys.length;l>o;o++){var E=r.uniformKeys[o];u=r[E],h=a[E],void 0===h?void 0!==e.trackUniforms&&(c=e.trackUniforms[E],void 0!==c&&c.apply(u)):(c=0===h.length?h.globalDefault:h.back().object,c.apply(u))}}},applyUniformList:function(t,e){var r=this.getLastProgramApplied();r.program;for(var i,o,n,a=r.uniformsCache,s=0,u=a.uniformKeys.length;u>s;s++){var h=a.uniformKeys[s];if(i=a[h],n=e[h],void 0===n){if(o=t[h],void 0===o)continue;n=0===o.length?o.globalDefault:o.back().object}n.apply(i)}},applyAttributeMap:function(t){for(var e,r=0,i=t.attributeKeys.length;i>r;r++){var o=t.attributeKeys[r];if(e=t[o],void 0!==e){var n;n=0===e.length?e.globalDefault:e.back().object,e.asChanged&&(e.lastApplied!==n&&(n.apply&&n.apply(this),e.lastApplied=n),e.asChanged=!1)}}},getObjectPair:function(t,e){return{object:t,value:e}},pushUniformsList:function(t,e){for(var r,i,o=0,n=e.uniformKeys.length;n>o;o++){var a=e.uniformKeys[o];uniformPair=e[a],i=uniformPair.getUniform(),r=i.name,void 0===t[r]&&(t[r]=osg.Stack.create(),t[r].globalDefault=i,t.uniformKeys.push(r));var s=uniformPair.getValue(),u=t[r];0===u.length?u.push(this.getObjectPair(i,s)):u[u.length-1].value&osg.StateAttribute.OVERRIDE&&!(s&osg.StateAttribute.PROTECTED)?u.push(u[u.length-1]):u.push(this.getObjectPair(i,s))}},popUniformsList:function(t,e){for(var r=0,i=e.uniformKeys.length;i>r;r++){var o=e.uniformKeys[r];t[o].pop()}},applyTextureAttributeMapList:function(t){for(var e,r=this._graphicContext,i=0,o=t.length;o>i;i++)if(e=t[i],void 0!==e)for(var n=0,a=e.attributeKeys.length;a>n;n++){var s=e.attributeKeys[n],u=e[s];if(void 0!==u){var h;h=0===u.length?u.globalDefault:u.back().object,u.asChanged&&(r.activeTexture(r.TEXTURE0+i),h.apply(this,i),u.lastApplied=h,u.asChanged=!1)}}},setGlobalDefaultValue:function(t){var e=t.getTypeMember();this.attributeMap[e]?this.attributeMap[e].globalDefault=t:(this.attributeMap[e]=osg.Stack.create(),this.attributeMap[e].globalDefault=t,this.attributeMap.attributeKeys.push(e))},pushAttributeMap:function(t,e){for(var r,i=0,o=e.attributeKeys.length;o>i;i++){var n=e.attributeKeys[i],a=e[n],s=a.getAttribute();void 0===t[n]&&(t[n]=osg.Stack.create(),t[n].globalDefault=s.cloneType(),t.attributeKeys.push(n));var u=a.getValue();r=t[n],0===r.length?r.push(this.getObjectPair(s,u)):r[r.length-1].value&osg.StateAttribute.OVERRIDE&&!(u&osg.StateAttribute.PROTECTED)?r.push(r[r.length-1]):r.push(this.getObjectPair(s,u)),r.asChanged=!0}},popAttributeMap:function(t,e){for(var r,i=0,o=e.attributeKeys.length;o>i;i++)type=e.attributeKeys[i],r=t[type],r.pop(),r.asChanged=!0},setIndexArray:function(t){var e=this._graphicContext;this.currentIndexVBO!==t&&(t.bind(e),this.currentIndexVBO=t),t.isDirty()&&t.compile(e)},lazyDisablingOfVertexAttributes:function(){for(var t=this.vertexAttribMap._keys,e=0,r=t.length;r>e;e++){var i=t[e];this.vertexAttribMap[i]&&(this.vertexAttribMap._disable[i]=!0)}},applyDisablingOfVertexAttributes:function(){for(var t=this.vertexAttribMap._keys,e=0,r=t.length;r>e;e++)if(this.vertexAttribMap._disable[t[e]]===!0){var i=t[e];this._graphicContext.disableVertexAttribArray(i),this.vertexAttribMap._disable[i]=!1,this.vertexAttribMap[i]=!1}var o=this.programs.lastApplied;if(void 0!==o){var n=!1,a=!1;void 0!==o.attributesCache.Color&&(a=this.vertexAttribMap[o.attributesCache.Color]);var s=this.uniforms.ArrayColorEnabled.globalDefault;this.previousHasColorAttrib!==a&&(n=!0),this.previousHasColorAttrib=a,n&&(s.get()[0]=a?1:0,s.dirty()),s.apply(o.uniformsCache.ArrayColorEnabled)}},setVertexAttribArray:function(t,e,r){var i=this.vertexAttribMap;i._disable[t]=!1;var o=this._graphicContext,n=!1;e.isDirty()&&(e.bind(o),e.compile(o),n=!0),i[t]!==e&&(n||e.bind(o),i[t]||(o.enableVertexAttribArray(t),void 0===i[t]&&i._keys.push(t)),i[t]=e,o.vertexAttribPointer(t,e._itemSize,o.FLOAT,r,0,0))}},osg.StateSet=function(){osg.Object.call(this),this.id=osg.StateSet.instance++,this.attributeMap={},this.attributeMap.attributeKeys=[],this.textureAttributeMapList=[],this._binName=void 0,this._binNumber=0,this._shaderGenerator=void 0},osg.StateSet.instance=0,osg.StateSet.AttributePair=function(t,e){this._object=t,this._value=e},osg.StateSet.AttributePair.prototype={getAttribute:function(){return this._object},getUniform:function(){return this._object},getValue:function(){return this._value}},osg.StateSet.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.Object.prototype,{getAttributePair:function(t,e){return new osg.StateSet.AttributePair(t,e)},addUniform:function(t,e){void 0===e&&(e=osg.StateAttribute.ON),this.uniforms||(this.uniforms={},this.uniforms.uniformKeys=[]);var r=t.name;this.uniforms[r]=this.getAttributePair(t,e),-1===this.uniforms.uniformKeys.indexOf(r)&&this.uniforms.uniformKeys.push(r)},getUniform:function(t){return this.uniforms&&this.uniforms[t]?this.uniforms[t].getAttribute():void 0},getUniformList:function(){return this.uniforms},setTextureAttributeAndMode:function(t,e,r){void 0===r&&(r=osg.StateAttribute.ON),this._setTextureAttribute(t,this.getAttributePair(e,r))},getNumTextureAttributeLists:function(){return this.textureAttributeMapList.length},getTextureAttribute:function(t,e){return void 0===this.textureAttributeMapList[t]||void 0===this.textureAttributeMapList[t][e]?void 0:this.textureAttributeMapList[t][e].getAttribute()},removeTextureAttribute:function(t,e){if(void 0!==this.textureAttributeMapList[t]&&void 0!==this.textureAttributeMapList[t][e]){delete this.textureAttributeMapList[t][e];var r=this.textureAttributeMapList[t].attributeKeys.indexOf(e);this.textureAttributeMapList[t].attributeKeys.splice(r,1)}},getAttribute:function(t){return void 0===this.attributeMap[t]?void 0:this.attributeMap[t].getAttribute()},setAttributeAndMode:function(t,e){void 0===e&&(e=osg.StateAttribute.ON),this._setAttribute(this.getAttributePair(t,e))},setAttribute:function(t,e){void 0===e&&(e=osg.StateAttribute.ON),this._setAttribute(this.getAttributePair(t,e))},removeAttribute:function(t){if(void 0!==this.attributeMap[t]){delete this.attributeMap[t];var e=this.attributeMap.attributeKeys.indexOf(t);this.attributeMap.attributeKeys.splice(e,1)}},setRenderingHint:function(t){"OPAQUE_BIN"===t?this.setRenderBinDetails(0,"RenderBin"):"TRANSPARENT_BIN"===t?this.setRenderBinDetails(10,"DepthSortedBin"):this.setRenderBinDetails(0,"")},setRenderBinDetails:function(t,e){this._binNumber=t,this._binName=e},getAttributeMap:function(){return this.attributeMap},getBinNumber:function(){return this._binNumber},getBinName:function(){return this._binName},setBinNumber:function(t){this._binNumber=t},setBinName:function(t){this._binName=t},getAttributeList:function(){for(var t=this.attributeMap,e=t.attributeKeys,r=e.length,i=Array(r),o=0;r>o;o++)i[o]=t[e[o]];return i},setShaderGenerator:function(t){this._shaderGenerator=t},getShaderGenerator:function(){return this._shaderGenerator},_getUniformMap:function(){return this.uniforms},_setTextureAttribute:function(t,e){void 0===this.textureAttributeMapList[t]&&(this.textureAttributeMapList[t]={},this.textureAttributeMapList[t].attributeKeys=[]);var r=e.getAttribute().getTypeMember();this.textureAttributeMapList[t][r]=e,-1===this.textureAttributeMapList[t].attributeKeys.indexOf(r)&&this.textureAttributeMapList[t].attributeKeys.push(r)},_setAttribute:function(t){var e=t.getAttribute().getTypeMember();this.attributeMap[e]=t,-1===this.attributeMap.attributeKeys.indexOf(e)&&this.attributeMap.attributeKeys.push(e)}}),"osg","StateSet"),osg.StateSet.prototype.setTextureAttributeAndModes=osg.StateSet.prototype.setTextureAttributeAndMode,osg.StateSet.prototype.setAttributeAndModes=osg.StateSet.prototype.setAttributeAndMode,osg.Texture=function(){osg.StateAttribute.call(this),this.setDefaultParameters()},osg.Texture.DEPTH_COMPONENT=6402,osg.Texture.ALPHA=6406,osg.Texture.RGB=6407,osg.Texture.RGBA=6408,osg.Texture.LUMINANCE=6409,osg.Texture.LUMINANCE_ALPHA=6410,osg.Texture.LINEAR=9729,osg.Texture.NEAREST=9728,osg.Texture.NEAREST_MIPMAP_NEAREST=9984,osg.Texture.LINEAR_MIPMAP_NEAREST=9985,osg.Texture.NEAREST_MIPMAP_LINEAR=9986,osg.Texture.LINEAR_MIPMAP_LINEAR=9987,osg.Texture.ANISOTROPIC=34046,osg.Texture.CLAMP_TO_EDGE=33071,osg.Texture.REPEAT=10497,osg.Texture.MIRRORED_REPEAT=33648,osg.Texture.TEXTURE_2D=3553,osg.Texture.TEXTURE_CUBE_MAP=34067,osg.Texture.TEXTURE_BINDING_CUBE_MAP=34068,osg.Texture.TEXTURE_CUBE_MAP_POSITIVE_X=34069,osg.Texture.TEXTURE_CUBE_MAP_NEGATIVE_X=34070,osg.Texture.TEXTURE_CUBE_MAP_POSITIVE_Y=34071,osg.Texture.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072,osg.Texture.TEXTURE_CUBE_MAP_POSITIVE_Z=34073,osg.Texture.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074,osg.Texture.MAX_CUBE_MAP_TEXTURE_SIZE=34076,osg.Texture.UNSIGNED_BYTE=5121,osg.Texture.FLOAT=5126,osg.Texture.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Texture",cloneType:function(){var t=new osg.Texture;return t.default_type=!0,t},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},getOrCreateUniforms:function(t){if(void 0===osg.Texture.uniforms&&(osg.Texture.uniforms=[]),void 0===osg.Texture.uniforms[t]){var e=this.getType()+t,r={};r.texture=osg.Uniform.createInt1(t,e),r.uniformKeys=Object.keys(r),osg.Texture.uniforms[t]=r}return osg.Texture.uniforms[t]},setDefaultParameters:function(){this._magFilter=osg.Texture.LINEAR,this._minFilter=osg.Texture.LINEAR,this._minFilterMult=1,this._magFFilterMult=1,this._hasMipMap=!1,this._wrapS=osg.Texture.CLAMP_TO_EDGE,this._wrapT=osg.Texture.CLAMP_TO_EDGE,this._textureWidth=0,this._textureHeight=0,this._unrefImageDataAfterApply=!1,this.setInternalFormat(osg.Texture.RGBA),this._textureTarget=osg.Texture.TEXTURE_2D,this._type=osg.Texture.UNSIGNED_BYTE},getTextureTarget:function(){return this._textureTarget},getTextureObject:function(){return this._textureObject},setTextureSize:function(t,e){this._textureWidth=t,this._textureHeight=e},init:function(t){this._textureObject||(this._textureObject=t.createTexture(),this.dirty())},getWidth:function(){return this._textureWidth},getHeight:function(){return this._textureHeight},releaseGLObjects:function(t){void 0!==this._textureObject&&null!==this._textureObject&&(t.deleteTexture(this._textureObject),this._textureObject=null,this._image=void 0)},setWrapS:function(t){this._wrapS="string"==typeof t?osg.Texture[t]:t},setWrapT:function(t){this._wrapT="string"==typeof t?osg.Texture[t]:t},getWrapT:function(){return this._wrapT},getWrapS:function(){return this._wrapS},getMinFilter:function(){return this._minFilter},getMagFilter:function(){return this._magFilter},isMipMapped:function(t){return t==osg.Texture.NEAREST_MIPMAP_NEAREST||t==osg.Texture.LINEAR_MIPMAP_NEAREST||t==osg.Texture.NEAREST_MIPMAP_LINEAR||t==osg.Texture.LINEAR_MIPMAP_LINEAR},setMinFilter:function(t,e){this._minFilter="string"==typeof t?osg.Texture[t]:t,this._hasMipMap=this.isMipMapped(this._minFilter);var r=osg.profile.extensions.EXT_texture_filter_anisotropic;if(r){var i=r.MAX_TEXTURE_MAX_ANISOTROPY_EXT;this._minFilterMult=e>i?i:e}},setMagFilter:function(t,e){this._magFilter="string"==typeof t?osg.Texture[t]:t,this._hasMipMap=this.isMipMapped(this._magFilter);var r=osg.profile.extensions.EXT_texture_filter_anisotropic;if(r){var i=r.MAX_TEXTURE_MAX_ANISOTROPY_EXT;this._magFilterMult=e>i?i:e}},setImage:function(t,e){this._image=t,this.setImageFormat(e),this.dirty()},getImage:function(){return this._image},setImageFormat:function(t){t?("string"==typeof t&&(t=osg.Texture[t]),this._imageFormat=t):this._imageFormat=osg.Texture.RGBA,this.setInternalFormat(this._imageFormat)},setType:function(t){this._type="string"==typeof t?osg.Texture[t]:t},setUnrefImageDataAfterApply:function(t){this._unrefImageDataAfterApply=t},setInternalFormat:function(t){this._internalFormat=t},getInternalFormat:function(){return this._internalFormat},setFromCanvas:function(t,e){this.setImage(t,e)},setFromTypedArray:function(t,e){this.setImage(t,e)},isImageReady:function(t){if(t)if(t instanceof Image){if(t.complete)return void 0!==t.naturalWidth&&0===t.naturalWidth?!1:!0}else{if(t instanceof HTMLCanvasElement)return!0;if(t instanceof Uint8Array)return!0}return!1},applyFilterParameter:function(t,e){var r=function(t){return 0!==t&&(t&~t+1)===t},i=r(this._textureWidth)&&r(this._textureHeight);i||(this.setWrapT(osg.Texture.CLAMP_TO_EDGE),this.setWrapS(osg.Texture.CLAMP_TO_EDGE),this._hasMipMap&&(this.setMinFilter(osg.Texture.LINEAR),this._hasMipMap=!1)),this._magFilterMult>1&&t.texParameterf(t.TEXTURE_2D,osg.profile.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._magFilterMult),this._minFilterMult>1&&t.texParameterf(t.TEXTURE_2D,osg.profile.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._minFilterMult),t.texParameteri(e,t.TEXTURE_MIN_FILTER,this._minFilter),t.texParameteri(e,t.TEXTURE_WRAP_S,this._wrapS),t.texParameteri(e,t.TEXTURE_WRAP_T,this._wrapT)},generateMipmap:function(t,e){(this._minFilter===t.NEAREST_MIPMAP_NEAREST||this._minFilter===t.LINEAR_MIPMAP_NEAREST||this._minFilter===t.NEAREST_MIPMAP_LINEAR||this._minFilter===t.LINEAR_MIPMAP_LINEAR)&&t.generateMipmap(e)},apply:function(t){var e=t.getGraphicContext();if(void 0===this._textureObject||this.isDirty())if(this.default_type)e.bindTexture(this._textureTarget,null);else{var r=this._image;void 0!==r?this.isImageReady(r)?(this._textureObject||this.init(e),this.setDirty(!1),e.bindTexture(this._textureTarget,this._textureObject),r instanceof Image?(this.setTextureSize(r.naturalWidth,r.naturalHeight),e.texImage2D(this._textureTarget,0,this._internalFormat,this._imageFormat,this._type,this._image)):r instanceof HTMLCanvasElement?(this.setTextureSize(r.width,r.height),e.texImage2D(this._textureTarget,0,this._internalFormat,this._imageFormat,this._type,this._image)):r instanceof Uint8Array&&e.texImage2D(this._textureTarget,0,this._internalFormat,this._textureWidth,this._textureHeight,0,this._internalFormat,this._type,this._image),this.applyFilterParameter(e,this._textureTarget),this.generateMipmap(e,this._textureTarget),this._unrefImageDataAfterApply&&(this._image=void 0)):e.bindTexture(this._textureTarget,null):0!==this._textureHeight&&0!==this._textureWidth&&(this._textureObject||this.init(e),e.bindTexture(this._textureTarget,this._textureObject),e.texImage2D(this._textureTarget,0,this._internalFormat,this._textureWidth,this._textureHeight,0,this._internalFormat,this._type,null),this.applyFilterParameter(e,this._textureTarget),this.generateMipmap(e,this._textureTarget),this.setDirty(!1))}else e.bindTexture(this._textureTarget,this._textureObject)},setShaderGeneratorFunction:function(t,e){this[e]=t},generateShader:function(t,e){return this[e]?this[e].call(this,t):""}}),"osg","Texture"),osg.Texture.prototype[osg.ShaderGeneratorType.VertexInit]=function(t){var e="attribute vec2 TexCoord"+t+";\n";return e+="varying vec2 FragTexCoord"+t+";\n"},osg.Texture.prototype[osg.ShaderGeneratorType.VertexMain]=function(t){return"FragTexCoord"+t+" = TexCoord"+t+";\n"},osg.Texture.prototype[osg.ShaderGeneratorType.FragmentInit]=function(t){var e="varying vec2 FragTexCoord"+t+";\n";return e+="uniform sampler2D Texture"+t+";\n",e+="vec4 texColor"+t+";\n"},osg.Texture.prototype[osg.ShaderGeneratorType.FragmentMain]=function(t){var e="texColor"+t+" = texture2D( Texture"+t+", FragTexCoord"+t+".xy );\n";return e+="fragColor = fragColor * texColor"+t+";\n"},osg.Texture.createFromURL=function(t,e){var r=new osg.Texture;return osgDB.Promise.when(osgDB.readImage(t)).then(function(t){r.setImage(t,e)}),r},osg.Texture.createFromImg=function(t,e){var r=new osg.Texture;return r.setImage(t,e),r},osg.Texture.createFromImage=osg.Texture.createFromImg,osg.Texture.createFromCanvas=function(t,e){var r=new osg.Texture;return r.setFromCanvas(t,e),r},osg.Texture.create=function(t){return osg.log("osg.Texture.create is deprecated, use osg.Texture.createFromURL instead"),osg.Texture.createFromURL(t)},osg.TextureCubeMap=function(){osg.Texture.call(this),this._images={}},osg.TextureCubeMap.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.Texture.prototype,{setDefaultParameters:function(){osg.Texture.prototype.setDefaultParameters.call(this),this._textureTarget=osg.Texture.TEXTURE_CUBE_MAP},cloneType:function(){var t=new osg.TextureCubeMap;return t.default_type=!0,t},setImage:function(t,e,r){"string"==typeof t&&(t=osg.Texture[t]),void 0===this._images[t]&&(this._images[t]={}),"string"==typeof r&&(r=osg.Texture[r]),void 0===r&&(r=osg.Texture.RGBA),this._images[t].image=e,this._images[t].format=r,this._images[t].dirty=!0,this.dirty()},getImage:function(t){return this._images[t].image},applyTexImage2D_load:function(t,e,r,i,o,n,a){return a?osg.Texture.prototype.isImageReady(a)?(a instanceof Image?this.setTextureSize(a.naturalWidth,a.naturalHeight):a instanceof HTMLCanvasElement&&this.setTextureSize(a.width,a.height),t.texImage2D(e,0,i,o,n,a),!0):!1:!1},_applyImageTarget:function(t,e,r){var i=this._images[r];return i?i.dirty?this.applyTexImage2D_load(t,r,0,e,i.format,t.UNSIGNED_BYTE,i.image)?(i.dirty=!1,this._unrefImageDataAfterApply&&delete this._images[r],1):0:1:0},apply:function(t){var e=t.getGraphicContext();if(void 0===this._textureObject||this.isDirty())if(this.default_type)e.bindTexture(this._textureTarget,null);else{this._images,this._textureObject||this.init(e),e.bindTexture(this._textureTarget,this._textureObject);var r=this._internalFormat,i=0;i+=this._applyImageTarget(e,r,e.TEXTURE_CUBE_MAP_POSITIVE_X),i+=this._applyImageTarget(e,r,e.TEXTURE_CUBE_MAP_NEGATIVE_X),i+=this._applyImageTarget(e,r,e.TEXTURE_CUBE_MAP_POSITIVE_Y),i+=this._applyImageTarget(e,r,e.TEXTURE_CUBE_MAP_NEGATIVE_Y),i+=this._applyImageTarget(e,r,e.TEXTURE_CUBE_MAP_POSITIVE_Z),i+=this._applyImageTarget(e,r,e.TEXTURE_CUBE_MAP_NEGATIVE_Z),6===i&&(this.setDirty(!1),this.applyFilterParameter(e,this._textureTarget),this.generateMipmap(e,this._textureTarget))}else e.bindTexture(this._textureTarget,this._textureObject)}}),"osg","TextureCubeMap"),osg.UpdateVisitor=function(){osg.NodeVisitor.call(this);var t=new osg.FrameStamp;this.getFrameStamp=function(){return t},this.setFrameStamp=function(e){t=e}},osg.UpdateVisitor.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{apply:function(t){for(var e=t.getUpdateCallbackList(),r=0;e.length>r;r++)if(!e[r].update(t,this))return;this.traverse(t)}}),osg.Viewport=function(t,e,r,i){osg.StateAttribute.call(this),void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=800),void 0===i&&(i=600),this._x=t,this._y=e,this._width=r,this._height=i,this._dirty=!0},osg.Viewport.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Viewport",cloneType:function(){return new osg.Viewport},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},apply:function(t){var e=t.getGraphicContext();e.viewport(this._x,this._y,this._width,this._height),this._dirty=!1},setViewport:function(t,e,r,i){this._x=t,this._y=e,this._width=r,this._height=i,this.dirty()},x:function(){return this._x},y:function(){return this._y},width:function(){return this._width},height:function(){return this._height},computeWindowMatrix:function(){var t=osg.Matrix.makeTranslate(1,1,1),e=osg.Matrix.makeScale(.5*this._width,.5*this._height,.5),r=osg.Matrix.makeTranslate(this._x,this._y,0);return osg.Matrix.preMult(r,osg.Matrix.preMult(e,t))}}),"osg","Viewport"),osg.CullStack=function(){this._modelviewMatrixStack=[],this._projectionMatrixStack=[],this._viewportStack=[],this._bbCornerFar=0,this._bbCornerNear=0},osg.CullStack.prototype={getCurrentProjectionMatrix:function(){return this._projectionMatrixStack[this._projectionMatrixStack.length-1]},getCurrentModelviewMatrix:function(){return this._modelviewMatrixStack[this._modelviewMatrixStack.length-1]},getViewport:function(){return 0===this._viewportStack.length?void 0:this._viewportStack[this._viewportStack.length-1]},getLookVectorLocal:function(){var t=this._modelviewMatrixStack[this._modelviewMatrixStack.length-1];return[-t[2],-t[6],-t[10]]},pushViewport:function(t){this._viewportStack.push(t)},popViewport:function(){this._viewportStack.pop()},pushModelviewMatrix:function(t){this._modelviewMatrixStack.push(t);var e=this.getLookVectorLocal();this._bbCornerFar=(e[0]>=0?1:0)|(e[1]>=0?2:0)|(e[2]>=0?4:0),this._bbCornerNear=7&~this._bbCornerFar},popModelviewMatrix:function(){this._modelviewMatrixStack.pop();var t;t=0!==this._modelviewMatrixStack.length?this.getLookVectorLocal():[0,0,-1],this._bbCornerFar=(t[0]>=0?1:0)|(t[1]>=0?2:0)|(t[2]>=0?4:0),this._bbCornerNear=7&~this._bbCornerFar},pushProjectionMatrix:function(t){this._projectionMatrixStack.push(t)},popProjectionMatrix:function(){this._projectionMatrixStack.pop()}},osg.CullVisitor=function(){osg.NodeVisitor.call(this),osg.CullSettings.call(this),osg.CullStack.call(this),this._rootStateGraph=void 0,this._currentStateGraph=void 0,this._currentRenderBin=void 0,this._currentRenderStage=void 0,this._rootRenderStage=void 0,this._computedNear=Number.POSITIVE_INFINITY,this._computedFar=Number.NEGATIVE_INFINITY;var t=[0,0,-1];this._bbCornerFar=(t[0]>=0?1:0)|(t[1]>=0?2:0)|(t[2]>=0?4:0),this._bbCornerNear=7&~this._bbCornerFar,this._reserveMatrixStack=[[]],this._reserveMatrixStack.current=0,this._reserveLeafStack=[{}],this._reserveLeafStack.current=0,this._renderBinStack=[]},osg.CullVisitor.prototype=osg.objectInehrit(osg.CullStack.prototype,osg.objectInehrit(osg.CullSettings.prototype,osg.objectInehrit(osg.NodeVisitor.prototype,{distance:function(t,e){return-(t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+e[14])},handleCullCallbacksAndTraverse:function(t){var e=t.getCullCallback();(!e||e.cull(t,this))&&this.traverse(t)},updateCalculatedNearFar:function(t,e){var r,i,o=e.getBoundingBox();if(r=this.distance(o.corner(this._bbCornerNear),t),i=this.distance(o.corner(this._bbCornerFar),t),r>i){var n=r;r=i,i=n}return 0>i?!1:(this._computedNear>r&&(this._computedNear=r),i>this._computedFar&&(this._computedFar=i),!0)},clampProjectionMatrix:function(t,e,r,i,o){var n=1e-6;if(e-n>r)return osg.log("clampProjectionMatrix not applied, invalid depth range, znear = "+e+"  zfar = "+r),!1;var a,s;if(e+n>r){var u=.5*(e+r);e=u-n,r=u+n}if(n>Math.abs(osg.Matrix.get(t,0,3))&&n>Math.abs(osg.Matrix.get(t,1,3))&&n>Math.abs(osg.Matrix.get(t,2,3))){var h=.02*(r-e);1>h&&(h=1),a=e-h,s=r+h,e=a,r=s,osg.Matrix.set(t,2,2,-2/(s-a)),osg.Matrix.set(t,3,2,-(s+a)/(s-a))}else{var c=1.02,g=.98;a=e*g,s=r*c;var l=r*i;l>a&&(a=l),e=a,r=s;var d=osg.Matrix.get(t,2,2),f=osg.Matrix.get(t,3,2),p=osg.Matrix.get(t,2,3),m=osg.Matrix.get(t,3,3),v=(-a*d+f)/(-a*p+m),_=(-s*d+f)/(-s*p+m),S=Math.abs(2/(v-_)),y=-(v+_)/2,b=[1,0,0,0,0,1,0,0,0,0,S,0,0,0,y*S,1];osg.Matrix.postMult(b,t)}return void 0!==o&&(o[0]=e,o[1]=r),!0},setStateGraph:function(t){this._rootStateGraph=t,this._currentStateGraph=t},setRenderStage:function(t){this._rootRenderStage=t,this._currentRenderBin=t},reset:function(){this._modelviewMatrixStack.splice(0,this._modelviewMatrixStack.length),this._projectionMatrixStack.splice(0,this._projectionMatrixStack.length),this._reserveMatrixStack.current=0,this._reserveLeafStack.current=0,this._computedNear=Number.POSITIVE_INFINITY,this._computedFar=Number.NEGATIVE_INFINITY},getCurrentRenderBin:function(){return this._currentRenderBin},setCurrentRenderBin:function(t){this._currentRenderBin=t},addPositionedAttribute:function(t){var e=this._modelviewMatrixStack[this._modelviewMatrixStack.length-1];this._currentRenderBin.getStage().positionedAttribute.push([e,t])
},pushStateSet:function(t){if(this._currentStateGraph=this._currentStateGraph.findOrInsert(t),void 0!==t.getBinName()){var e=this._renderBinStack,r=this._currentRenderBin;e.push(r),this._currentRenderBin=r.getStage().findOrInsert(t.getBinNumber(),t.getBinName())}},popStateSet:function(){var t=this._currentStateGraph,e=t.getStateSet();if(this._currentStateGraph=t.parent,void 0!==e.getBinName()){var r=this._renderBinStack;this._currentRenderBin=0===r.length?this._currentRenderBin.getStage():r.pop()}},popProjectionMatrix:function(){if(this._computeNearFar===!0&&this._computedFar>=this._computedNear){var t=this._projectionMatrixStack[this._projectionMatrixStack.length-1];this.clampProjectionMatrix(t,this._computedNear,this._computedFar,this._nearFarRatio)}osg.CullStack.prototype.popProjectionMatrix.call(this)},apply:function(t){this[t.objectType].call(this,t)},_getReservedMatrix:function(){var t=this._reserveMatrixStack[this._reserveMatrixStack.current++];return this._reserveMatrixStack.current===this._reserveMatrixStack.length&&this._reserveMatrixStack.push(osg.Matrix.makeIdentity([])),t},_getReservedLeaf:function(){var t=this._reserveLeafStack[this._reserveLeafStack.current++];return this._reserveLeafStack.current===this._reserveLeafStack.length&&this._reserveLeafStack.push({}),t}}))),osg.CullVisitor.prototype[osg.Camera.prototype.objectType]=function(t){var e=t.getStateSet();e&&this.pushStateSet(e),t.light&&this.addPositionedAttribute(t.light);var r=this.traversalMask;t.traversalMask&&(this.traversalMask=t.traversalMask|this.traversalMask),this._modelviewMatrixStack[this._modelviewMatrixStack.length-1];var i=this._getReservedMatrix(),o=this._getReservedMatrix();if(t.getReferenceFrame()===osg.Transform.RELATIVE_RF){var n=this._projectionMatrixStack[this._projectionMatrixStack.length-1];osg.Matrix.mult(n,t.getProjectionMatrix(),o);var a=this._modelviewMatrixStack[this._modelviewMatrixStack.length-1];osg.Matrix.mult(a,t.getViewMatrix(),i)}else osg.Matrix.copy(t.getViewMatrix(),i),osg.Matrix.copy(t.getProjectionMatrix(),o);osg.Matrix.copy(i,t.getPureViewMatrix()),this.pushProjectionMatrix(o),this.pushModelviewMatrix(i),t.getViewport()&&this.pushViewport(t.getViewport());var s=this._computedNear,u=this._computedFar,h=new osg.CullSettings;if(h.setCullSettings(this),this._computedNear=Number.POSITIVE_INFINITY,this._computedFar=Number.NEGATIVE_INFINITY,this.setCullSettings(t),t.getRenderOrder()===osg.Camera.NESTED_RENDER)this.handleCullCallbacksAndTraverse(t);else{var c=this.getCurrentRenderBin().getStage(),g=new osg.RenderStage;g.setCamera(t),g.setClearDepth(t.getClearDepth()),g.setClearColor(t.getClearColor()),g.setClearMask(t.getClearMask());var l;l=void 0===t.getViewport()?c.getViewport():t.getViewport(),g.setViewport(l);var d=this.getCurrentRenderBin();this.setCurrentRenderBin(g),this.handleCullCallbacksAndTraverse(t),this.setCurrentRenderBin(d),t.getRenderOrder()===osg.Camera.PRE_RENDER?this.getCurrentRenderBin().getStage().addPreRenderStage(g,t.renderOrderNum):this.getCurrentRenderBin().getStage().addPostRenderStage(g,t.renderOrderNum)}this.popModelviewMatrix(),this.popProjectionMatrix(),t.near=this._computedNear,t.far=this._computedFar,t.getViewport()&&this.popViewport(),this.traversalMask=r,this.setCullSettings(h),this._computedNear=s,this._computedFar=u,e&&this.popStateSet()},osg.CullVisitor.prototype[osg.MatrixTransform.prototype.objectType]=function(t){var e=this._getReservedMatrix();if(t.getReferenceFrame()===osg.Transform.RELATIVE_RF){var r=this._modelviewMatrixStack[this._modelviewMatrixStack.length-1];osg.Matrix.mult(r,t.getMatrix(),e)}else osg.Matrix.copy(t.getMatrix(),e);this.pushModelviewMatrix(e);var i=t.getStateSet();i&&this.pushStateSet(i),t.light&&this.addPositionedAttribute(t.light),this.handleCullCallbacksAndTraverse(t),i&&this.popStateSet(),this.popModelviewMatrix()},osg.CullVisitor.prototype[osg.Projection.prototype.objectType]=function(t){lastMatrixStack=this._projectionMatrixStack[this._projectionMatrixStack.length-1];var e=this._getReservedMatrix();osg.Matrix.mult(lastMatrixStack,t.getProjectionMatrix(),e),this.pushProjectionMatrix(e);var r=t.getStateSet();r&&this.pushStateSet(r),this.handleCullCallbacksAndTraverse(t),r&&this.popStateSet(),this.popProjectionMatrix()},osg.CullVisitor.prototype[osg.Node.prototype.objectType]=function(t){var e=t.getStateSet();e&&this.pushStateSet(e),t.light&&this.addPositionedAttribute(t.light),this.handleCullCallbacksAndTraverse(t),e&&this.popStateSet()},osg.CullVisitor.prototype[osg.LightSource.prototype.objectType]=function(t){var e=this._getReservedMatrix();if(t.getReferenceFrame()===osg.Transform.RELATIVE_RF){var r=this._modelviewMatrixStack[this._modelviewMatrixStack.length-1];osg.Matrix.mult(r,t.getMatrix(),e)}else osg.Matrix.copy(t.getMatrix(),e);this.pushModelviewMatrix(e);var i=t.getStateSet();i&&this.pushStateSet(i);var o=t.getLight();o&&this.addPositionedAttribute(o),this.handleCullCallbacksAndTraverse(t),i&&this.popStateSet(),this.popModelviewMatrix()},osg.CullVisitor.prototype[osg.Geometry.prototype.objectType]=function(t){var e=this._modelviewMatrixStack[this._modelviewMatrixStack.length-1],r=t.getBoundingBox();if(!this._computeNearFar||!r.valid()||this.updateCalculatedNearFar(e,t)){var i=t.getStateSet();i&&this.pushStateSet(i),this.handleCullCallbacksAndTraverse(t);var o=this._currentStateGraph.leafs;0===o.length&&this._currentRenderBin.addStateGraph(this._currentStateGraph);var n=this._getReservedLeaf(),a=0;r.valid()&&(a=this.distance(r.center(),e)),isNaN(a)?osg.warn("warning geometry has a NaN depth, "+e+" center "+r.center()):(n.parent=this._currentStateGraph,n.projection=this._projectionMatrixStack[this._projectionMatrixStack.length-1],n.geometry=t,n.modelview=e,n.depth=a,o.push(n)),i&&this.popStateSet()}};var osgAnimation=osgAnimation||{};osgAnimation.EaseOutQuad=function(t){return-(t*(t-2))},osgAnimation.EaseInQuad=function(t){return t*t},osgAnimation.EaseOutCubic=function(t){return t-=1,t*t*t+1},osgAnimation.EaseInCubic=function(t){return t*t*t},osgAnimation.EaseOutQuart=function(t){return t-=1,-(t*t*t*t-1)},osgAnimation.EaseInQuart=function(t){return t*t*t*t},osgAnimation.EaseOutElastic=function(t){return Math.pow(2,-10*t)*Math.sin((t-.075)*2*Math.PI/.3)+1},osgAnimation.easeOutBounce=function(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},osgAnimation.easeOutQuad=osgAnimation.EaseOutQuad,osgAnimation.easeInQuad=osgAnimation.EaseInQuad,osgAnimation.easeOutCubic=osgAnimation.EaseOutCubic,osgAnimation.easeInCubic=osgAnimation.EaseInCubic,osgAnimation.easeOutQuart=osgAnimation.EaseOutQuart,osgAnimation.easeInQuart=osgAnimation.EaseInQuart,osgAnimation.easeOutElastic=osgAnimation.EaseOutElastic,osgAnimation.Animation=function(){osg.Object.call(this),this._channels=[]},osgAnimation.Animation.prototype=osg.objectInehrit(osg.Object.prototype,{getChannels:function(){return this._channels},getDuration:function(){for(var t=1e5,e=-1e5,r=0,i=this._channels.length;i>r;r++){var o=this._channels[r];t=Math.min(t,o.getStartTime()),e=Math.max(e,o.getEndTime())}return e-t}}),osgAnimation.BasicAnimationManager=function(){osg.Object.call(this),this._animations={},this._actives={},this._actives._keys=[],this._lastUpdate=void 0,this._targets=[]},osgAnimation.BasicAnimationManager.prototype=osg.objectInehrit(osg.Object.prototype,{_updateAnimation:function(t,e,r){var i=t.duration,o=t.weight,n=t.anim,a=t.start,s=t.loop;if(s>0){var u=e-a;if(u>=s*i)return!0}e=(e-a)%i;var h=t.callback;h&&h(e);for(var c=n.getChannels(),g=0,l=c.length;l>g;g++){var d=c[g];d.update(e,o,r)}return!1},update:function(t,e){var r=e.getFrameStamp().getSimulationTime();return this.updateManager(r),!0},updateManager:function(t){for(var e=this._targets,r=0,i=e.length;i>r;r++)e[r].reset();if(this._actives._keys.length>0)for(var o=this._actives._keys.length-1;o>=0;){for(var n=this._actives[o],a=this._actives[o]._keys,s=[],u=0,h=a.length;h>u;u++){var c=a[u],g=n[c];void 0===g.start&&(g.start=t);var l=this._updateAnimation(g,t,o);l&&s.push(u)}for(var d=s.length-1;d>=0;d--){var f=a[d];a.splice(d,1),delete n[f]}o--}},stopAll:function(){},isPlaying:function(t){if(this._actives._keys.length>0)for(var e=this._actives._keys.length-1;e>=0;){if(this._actives[e][t])return!0;e--}return!1},stopAnimation:function(t){if(this._actives._keys.length>0)for(var e=this._actives._keys.length-1,r=function(t){return"_keys"!==t};e>=0;){if(this._actives[e][t])return delete this._actives[e][t],this._actives[e]._keys=Object.keys(this._actives[e]).filter(r),void 0;e--}},playAnimationObject:function(t){if(void 0!==t.name){var e=this._animations[t.name];return void 0===e?(osg.log("no animation "+t.name+" found"),void 0):(this.isPlaying(t.name)||(void 0===t.priority&&(t.priority=0),void 0===t.weight&&(t.weight=1),void 0===t.timeFactor&&(t.timeFactor=1),void 0===t.loop&&(t.loop=0),void 0===this._actives[t.priority]&&(this._actives[t.priority]={},this._actives[t.priority]._keys=[],this._actives._keys.push(t.priority)),t.start=void 0,t.duration=e.getDuration(),t.anim=e,this._actives[t.priority][t.name]=t,this._actives[t.priority]._keys.push(t.name)),void 0)}},playAnimation:function(t,e,r){var i=t;if("object"==typeof t){if(void 0===t.getName)return this.playAnimationObject(t);i=t.getName()}var o={name:i,priority:e,weight:r};return this.playAnimationObject(o)},registerAnimation:function(t){this._animations[t.getName()]=t,this.buildTargetList()},getAnimationMap:function(){return this._animations},buildTargetList:function(){this._targets.length=0;for(var t=Object.keys(this._animations),e=0,r=t.length;r>e;e++)for(var i=this._animations[t[e]],o=i.getChannels(),n=0,a=o.length;a>n;n++){var s=o[n];this._targets.push(s.getTarget())}}}),osgAnimation.Channel=function(t,e){osg.Object.call(this),this._sampler=t,this._target=e,this._targetName=void 0,this._data={value:void 0,key:0}},osgAnimation.Channel.prototype=osg.objectInehrit(osg.Object.prototype,{getKeyframes:function(){return this._sampler.getKeyframes()},setKeyframes:function(t){this._sampler.setKeyframes(t)},getStartTime:function(){return this._sampler.getStartTime()},getEndTime:function(){return this._sampler.getEndTime()},getSampler:function(){return this._sampler},setSampler:function(t){this._sampler=t},getTarget:function(){return this._target},setTarget:function(t){this._target=t},setTargetName:function(t){this._targetName=t},getTargetName:function(){return this._targetName},update:function(t,e,r){if(e=e||1,r=r||0,!(1e-4>e)){var i=this._data;this._sampler.getValueAt(t,i),this._target.update.call(this._target,e,i.value,r)}},reset:function(){this._target.reset()}}),osgAnimation.Vec3LerpChannel=function(t,e){var r=new osgAnimation.Sampler;t||(t=[]),e||(e=new osgAnimation.Vec3Target),osgAnimation.Channel.call(this,r,e),r.setInterpolator(osgAnimation.Vec3LerpInterpolator),this.setKeyframes(t),this._data.value=osg.Vec3.copy(e.getValue(),[])},osgAnimation.Vec3LerpChannel.prototype=osgAnimation.Channel.prototype,osgAnimation.FloatLerpChannel=function(t,e){var r=new osgAnimation.Sampler;t||(t=[]),e||(e=new osgAnimation.FloatTarget),osgAnimation.Channel.call(this,r,e),r.setInterpolator(osgAnimation.FloatLerpInterpolator),this.setKeyframes(t),this._data.value=e.getValue()},osgAnimation.FloatLerpChannel.prototype=osgAnimation.Channel.prototype,osgAnimation.QuatLerpChannel=function(t,e){var r=new osgAnimation.Sampler;t||(t=[]),e||(e=new osgAnimation.QuatTarget),osgAnimation.Channel.call(this,r,e),r.setInterpolator(osgAnimation.QuatLerpInterpolator),this.setKeyframes(t),this._data.value=osg.Quat.copy(e.getValue(),[])},osgAnimation.QuatLerpChannel.prototype=osgAnimation.Channel.prototype,osgAnimation.QuatSlerpChannel=function(t,e){osgAnimation.QuatLerpChannel.call(this,t,e),this.getSampler().setInterpolator(osgAnimation.QuatSlerpInterpolator)},osgAnimation.QuatSlerpChannel.prototype=osgAnimation.Channel.prototype,osgAnimation.Vec3LerpInterpolator=function(t,e,r){var i,o,n=t[t.length-1],a=n.t;if(e>=a)return r.key=0,r.value[0]=n[0],r.value[1]=n[1],r.value[2]=n[2],void 0;if(i=t[0],o=i.t,o>=e)return r.key=0,r.value[0]=i[0],r.value[1]=i[1],r.value[2]=i[2],void 0;for(var s=r.key;e>t[s+1].t;)s++;var u=s+1,h=t[s].t,c=t[s][0],g=t[s][1],l=t[s][2],d=t[u].t,f=t[u][0],p=t[u][1],m=t[u][2],v=(e-h)/(d-h);r.value[0]=c+(f-c)*v,r.value[1]=g+(p-g)*v,r.value[2]=l+(m-l)*v,r.key=s},osgAnimation.QuatLerpInterpolator=function(t,e,r){var i,o,n=t[t.length-1],a=n.t;if(e>=a)return r.key=0,r.value[0]=n[0],r.value[1]=n[1],r.value[2]=n[2],r.value[3]=n[3],void 0;if(i=t[0],o=i.t,o>=e)return r.key=0,r.value[0]=i[0],r.value[1]=i[1],r.value[2]=i[2],r.value[3]=i[3],void 0;for(var s=r.key;e>t[s+1].t;)s++;var u=s+1,h=t[s].t,c=t[s][0],g=t[s][1],l=t[s][2],d=t[s][3],f=t[u].t,p=t[u][0],m=t[u][1],v=t[u][2],_=t[u][3],S=(e-h)/(f-h);r.value[0]=c+(p-c)*S,r.value[1]=g+(m-g)*S,r.value[2]=l+(v-l)*S,r.value[3]=d+(_-d)*S,r.key=s},osgAnimation.QuatSlerpInterpolator=function(t,e,r){var i,o,n=t[t.length-1],a=n.t;if(e>=a)return r.key=0,r.value[0]=n[0],r.value[1]=n[1],r.value[2]=n[2],r.value[3]=n[3],void 0;if(i=t[0],o=i.t,o>=e)return r.key=0,r.value[0]=i[0],r.value[1]=i[1],r.value[2]=i[2],r.value[3]=i[3],void 0;for(var s=r.key;e>t[s+1].t;)s++;var u=s+1,h=t[s].t,c=t[u].t,g=(e-h)/(c-h);osg.Quat.slerp(g,t[s],t[u],r.value),r.key=s},osgAnimation.FloatLerpInterpolator=function(t,e,r){var i,o,n=t[t.length-1],a=n.t;if(e>=a)return r.key=0,r.value=n[0],void 0;if(i=t[0],o=i.t,o>=e)return r.key=0,r.value=i[0],void 0;for(var s=r.key;e>t[s+1].t;)s++;var u=s+1,h=t[s].t,c=t[s][0],g=t[u].t,l=t[u][0],d=(e-h)/(g-h);r.value=c+(l-c)*d,r.key=s},osgAnimation.FloatStepInterpolator=function(t,e,r){var i,o,n=t[t.length-1],a=n.t;if(e>=a)return r.key=0,r.value=n[0],void 0;if(i=t[0],o=i.t,o>=e)return r.key=0,r.value=i[0],void 0;for(var s=r.key;e>t[s+1].t;)s++;t[s].t;var u=t[s][0];r.value=u,r.key=s},osgAnimation.createVec3Keyframe=function(t,e){var r=e.slice(0);return r.t=t,r},osgAnimation.createQuatKeyframe=function(t,e){var r=e.slice(0);return r.t=t,r},osgAnimation.createFloatKeyframe=function(t,e){var r=[e];return r.t=t,r},osgAnimation.LinkVisitor=function(){osg.NodeVisitor.call(this),this._animations=void 0,this._nbLinkTarget=0},osgAnimation.LinkVisitor.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{setAnimationMap:function(t){this._animations=t,this._animationKeys=Object.keys(t)},apply:function(t){for(var e=t.getUpdateCallbackList(),r=0,i=e.length;i>r;r++){var o=e[r];o instanceof osgAnimation.AnimationUpdateCallback&&this.link(o)}this.traverse(t)},link:function(t){for(var e=0,r=this._animations,i=this._animationKeys,o=0,n=i.length;n>o;o++){var a=i[o],s=r[a];e+=t.linkAnimation(s)}this._nbLinkedTarget+=e,osg.log("linked "+e+' for "'+t.getName()+'"')}}),osgAnimation.Sampler=function(t,e){t||(t=[]),this._keys=t,this._interpolator=e},osgAnimation.Sampler.prototype={getKeyframes:function(){return this._keys},setKeyframes:function(t){this._keys=t},setInterpolator:function(t){this._interpolator=t},getInterpolator:function(){return this._interpolator},getStartTime:function(){return 0===this._keys.length?void 0:this._keys[0].t},getEndTime:function(){return 0===this._keys.length?void 0:this._keys[this._keys.length-1].t},getValueAt:function(t,e){this._keys[e.key].t>t&&(e.key=0),this._interpolator(this._keys,t,e)}},osgAnimation.StackedTranslate=function(t,e){osg.Object.call(this),e||(e=[0,0,0]),this._translate=e,this._target=void 0,this.setName(t)},osgAnimation.StackedTranslate.prototype=osg.objectInehrit(osg.Object.prototype,{setTranslate:function(t){osg.Vec3.copy(t,this._translate)},setTarget:function(t){this._target=t},getTarget:function(){return this._target},update:function(){void 0!==this._target&&osg.Vec3.copy(this._target.getValue(),this._translate)},getOrCreateTarget:function(){return this._target||(this._target=new osgAnimation.Vec3Target(this._translate)),this._target},applyToMatrix:function(t){osg.Matrix.preMultTranslate(t,this._translate)}}),osgAnimation.StackedRotateAxis=function(t,e,r){osg.Object.call(this),e||(e=[1,0,0]),r||(r=0),this._axis=e,this._angle=r,this._target=void 0,this.setName(t),this._matrixTmp=[],osg.Matrix.makeIdentity(this._matrixTmp),this._quatTmp=[],osg.Quat.makeIdentity(this._quatTmp)},osgAnimation.StackedRotateAxis.prototype=osg.objectInehrit(osg.Object.prototype,{setAxis:function(t){osg.Vec3.copy(t,this._axis)},setAngle:function(t){this._angle=t},setTarget:function(t){this._target=t},getTarget:function(){return this._target},update:function(){void 0!==this._target&&(this._angle=this._target.getValue())},getOrCreateTarget:function(){return this._target||(this._target=new osgAnimation.FloatTarget(this._angle)),this._target},applyToMatrix:function(t){var e=this._axis,r=this._quatTmp,i=this._matrixTmp;osg.Quat.makeRotate(this._angle,e[0],e[1],e[2],r),osg.Matrix.setRotateFromQuat(i,r),osg.Matrix.preMult(t,i)}}),osgAnimation.StackedQuaternion=function(t,e){osg.Object.call(this),e||(e=[0,0,0,1]),this._quaternion=e,this._target=void 0,this._matrixTmp=[],osg.Matrix.makeIdentity(this._matrixTmp),this.setName(t)},osgAnimation.StackedQuaternion.prototype=osg.objectInehrit(osg.Object.prototype,{setQuaternion:function(t){osg.Quat.copy(t,this._quaternion)},setTarget:function(t){this._target=t},getTarget:function(){return this._target},update:function(){void 0!==this._target&&osg.Quat.copy(this._target.getValue(),this._quaternion)},getOrCreateTarget:function(){return this._target||(this._target=new osgAnimation.QuatTarget(this._quaternion)),this._target},applyToMatrix:function(t){var e=this._matrixTmp;osg.Matrix.setRotateFromQuat(e,this._quaternion),osg.Matrix.preMult(t,e)}}),osgAnimation.Target=function(){this._weight=0,this._priorityWeight=0,this._count=0,this._lastPriority=0,this._target=void 0},osgAnimation.Target.prototype={reset:function(){this._weight=0,this._priorityWeight=0},getValue:function(){return this._target}},osgAnimation.Vec3Target=function(){osgAnimation.Target.call(this),this._target=[0,0,0]},osgAnimation.Vec3Target.prototype=osg.objectInehrit(osgAnimation.Target.prototype,{update:function(e,r,i){this._weight||this._priorityWeight?(this._lastPriority!=i&&(this._weight+=this._priorityWeight*(1-this._weight),this._priorityWeight=0,this._lastPriority=i),this._priorityWeight+=e,t=(1-this._weight)*e/this._priorityWeight,osg.Vec3.lerp(t,this._target,r,this._target)):(this._priorityWeight=e,this._lastPriority=i,osg.Vec3.copy(r,this._target))}}),osgAnimation.FloatTarget=function(t){osgAnimation.Target.call(this),this._target=[t]},osgAnimation.FloatTarget.prototype=osg.objectInehrit(osgAnimation.Target.prototype,{update:function(e,r,i){this._weight||this._priorityWeight?(this._lastPriority!=i&&(this._weight+=this._priorityWeight*(1-this._weight),this._priorityWeight=0,this._lastPriority=i),this._priorityWeight+=e,t=(1-this._weight)*e/this._priorityWeight,this._target+=(r-this._target)*t):(this._priorityWeight=e,this._lastPriority=i,this._target=r)}}),osgAnimation.QuatTarget=function(){osgAnimation.Target.call(this),this._target=[],osg.Quat.makeIdentity(this._target)},osgAnimation.QuatTarget.prototype=osg.objectInehrit(osgAnimation.Target.prototype,{update:function(e,r,i){this._weight||this._priorityWeight?(this._lastPriority!=i&&(this._weight+=this._priorityWeight*(1-this._weight),this._priorityWeight=0,this._lastPriority=i),this._priorityWeight+=e,t=(1-this._weight)*e/this._priorityWeight,osg.Quat.lerp(t,this._target,r,this._target),osg.Quat.normalize(this._target,this._target)):(this._priorityWeight=e,this._lastPriority=i,osg.Quat.copy(r,this._target))}}),osgAnimation.AnimationUpdateCallback=function(){},osgAnimation.AnimationUpdateCallback.prototype=osg.objectInehrit(osg.Object.prototype,{linkChannel:function(){},linkAnimation:function(t){var e=this.getName();if(0===e.length)return osg.log("no name on an update callback, discard"),0;for(var r=0,i=t.getChannels(),o=0,n=i.length;n>o;o++){var a=i[o];a.getTargetName()===e&&(this.linkChannel(a),r++)}return r}}),osgAnimation.UpdateMatrixTransform=function(){osgAnimation.AnimationUpdateCallback.call(this),this._stackedTransforms=[]},osgAnimation.UpdateMatrixTransform.prototype=osg.objectInehrit(osgAnimation.AnimationUpdateCallback.prototype,{getStackedTransforms:function(){return this._stackedTransforms},update:function(t){var e=t.getMatrix();osg.Matrix.makeIdentity(e);for(var r=this._stackedTransforms,i=0,o=r.length;o>i;i++){var n=r[i];n.update(),n.applyToMatrix(e)}return!0},linkChannel:function(t){for(var e=t.getName(),r=this._stackedTransforms,i=0,o=r.length;o>i;i++){var n=r[i],a=n.getName();if(e.length>0&&a===e){var s=n.getOrCreateTarget();if(s)return t.setTarget(s),!0}}osg.log("can't link channel "+e+", does not contain a symbolic name that can be linked to TransformElements")}});var osgUtil=osgUtil||{};osgUtil.TriangleHit=function(t,e,r,i,o,n,a,s){this.index=t,this.normal=e,this.r1=r,this.v1=i,this.r2=o,this.v2=n,this.r3=a,this.v3=s},osgUtil.TriangleIntersect=function(){this.hits=[],this.nodePath=[]},osgUtil.TriangleIntersect.prototype={setNodePath:function(t){this.nodePath=t},set:function(t,e){this.start=t,this.end=e,this.dir=osg.Vec3.sub(e,t,[]),this.length=osg.Vec3.length(this.dir);var r=1/this.length;osg.Vec3.mult(this.dir,r,this.dir)},applyDrawElementsTriangles:function(t,e,r){for(var i,o,n,a=[],s=[],u=[],h=0;t>h;h+=3)i=3*r[h],a[0]=e[i],a[1]=e[i+1],a[2]=e[i+2],o=3*r[h+1],s[0]=e[o],s[1]=e[o+1],s[2]=e[o+2],n=3*r[h+2],u[0]=e[n],u[1]=e[n+1],u[2]=e[n+2],this.intersect(a,s,u)},applyDrawElementsTriangleStrip:function(t,e,r){for(var i,o,n,a=[],s=[],u=[],h=2,c=0;t>h;h++,c++)h%2?(i=3*r[c],o=3*r[c+2],n=3*r[c+1]):(i=3*r[c],o=3*r[c+1],n=3*r[c+2]),a[0]=e[i],a[1]=e[i+1],a[2]=e[i+2],s[0]=e[o],s[1]=e[o+1],s[2]=e[o+2],u[0]=e[n],u[1]=e[n+1],u[2]=e[n+2],this.intersect(a,s,u)},applyDrawElementsTriangleFan:function(t,e,r){var i=[],o=[],n=[],a=3*r[0];i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2];for(var s,u,h=2,c=1;t>h;h++,c++)s=3*r[c],u=3*r[c+1],o[0]=e[s],o[1]=e[s+1],o[2]=e[s+2],n[0]=e[u],n[1]=e[u+1],n[2]=e[u+2],this.intersect(i,o,n)},applyDrawArraysTriangles:function(t,e,r){for(var i=[],o=[],n=[],a=t;e>a;a+=9)i[0]=r[a],i[1]=r[a+1],i[2]=r[a+2],o[0]=r[a+3],o[1]=r[a+4],o[2]=r[a+5],n[0]=r[a+6],n[1]=r[a+7],n[2]=r[a+8],this.intersect(i,o,n)},applyDrawArraysTriangleStrip:function(t,e,r){for(var i,o,n,a=[],s=[],u=[],h=2,c=t;e>h;h++,c++)h%2?(i=3*c,o=3*(c+2),n=3*(c+1)):(i=3*c,o=3*(c+1),n=3*(c+2)),a[0]=r[i],a[1]=r[i+1],a[2]=r[i+2],s[0]=r[o],s[1]=r[o+1],s[2]=r[o+2],u[0]=r[n],u[1]=r[n+1],u[2]=r[n+2],this.intersect(a,s,u)},applyDrawArraysTriangleFan:function(t,e,r){var i=[],o=[],n=[],a=3*t;i[0]=r[a],i[1]=r[a+1],i[2]=r[a+2];for(var s,u,h=2,c=t+1;e>h;h++,c++)s=3*c,u=3*(c+1),o[0]=r[s],o[1]=r[s+1],o[2]=r[s+2],n[0]=r[u],n[1]=r[u+1],n[2]=r[u+2],this.intersect(i,o,n)},apply:function(t){if(t.getAttributes().Vertex){var e,r=t.getAttributes().Vertex.getElements();this.index=0;for(var i=0,o=t.primitives.length;o>i;i++)if(e=t.primitives[i],void 0!==e.getIndices){var n=e.indices.getElements();switch(e.getMode()){case gl.TRIANGLES:this.applyDrawElementsTriangles(e.getCount(),r,n);break;case gl.TRIANGLE_STRIP:this.applyDrawElementsTriangleStrip(e.getCount(),r,n);break;case gl.TRIANGLE_FAN:this.applyDrawElementsTriangleFan(e.getCount(),r,n)}}else switch(e.getMode()){case gl.TRIANGLES:this.applyDrawArraysTriangles(e.getFirst(),e.getCount(),r);break;case gl.TRIANGLE_STRIP:this.applyDrawArraysTriangleStrip(e.getFirst(),e.getCount(),r);break;case gl.TRIANGLE_FAN:this.applyDrawArraysTriangleFan(e.getFirst(),e.getCount(),r)}}},intersect:function(t,e,r){if(this.index++,t!=e&&e!=r&&t!=r){var i=osg.Vec3.sub(e,t,[]),o=osg.Vec3.cross(i,this.dir,[]),n=osg.Vec3.dot(osg.Vec3.sub(this.start,t,[]),o),a=osg.Vec3.dot(osg.Vec3.sub(r,t,[]),o);if(a>=0){if(0>n)return;if(n>a)return}else{if(n>0)return;if(a>n)return}var s=osg.Vec3.sub(r,e,[]),u=osg.Vec3.cross(s,this.dir,[]),h=osg.Vec3.dot(osg.Vec3.sub(this.start,e,[]),u),c=osg.Vec3.dot(osg.Vec3.sub(t,e,[]),u);if(c>=0){if(0>h)return;if(h>c)return}else{if(h>0)return;if(c>h)return}var g=osg.Vec3.sub(t,r,[]),l=osg.Vec3.cross(g,this.dir,[]),d=osg.Vec3.dot(osg.Vec3.sub(this.start,r,[]),l),f=osg.Vec3.dot(osg.Vec3.sub(e,r,[]),l);if(f>=0){if(0>d)return;if(d>f)return}else{if(d>0)return;if(f>d)return}var p;if(0===n)p=0;else{if(0===a)return;p=n/a}var m;if(0===h)m=0;else{if(0===c)return;m=h/c}var v;if(0===d)v=0;else{if(0===f)return;v=d/f}var _=m+v+p;if(1!==_){if(0===_)return;var S=1/_;m*=S,v*=S,p*=S}var y=[];if(osg.Vec3.add(osg.Vec3.mult(t,m,[]),osg.Vec3.mult(e,v,[]),y),osg.Vec3.add(osg.Vec3.mult(r,p,[]),y,y),!osg.Vec3.valid(y))return osg.log("Warning: TriangleIntersect "),osg.log("hit:     "+y),osg.log("         "+t),osg.log("         "+e),osg.log("         "+r),void 0;var b=osg.Vec3.dot(osg.Vec3.sub(y,this.start,[]),this.dir);if(!(0>b||b>this.length)){var T=osg.Vec3.cross(i,s,[]);osg.Vec3.normalize(T,T);var M=b/this.length,x=[];x[0]=this.start[0]*(1-M)+this.end[0]*M,x[1]=this.start[1]*(1-M)+this.end[1]*M,x[2]=this.start[2]*(1-M)+this.end[2]*M,this.hits.push({ratio:M,nodepath:this.nodePath.slice(0),triangleHit:new osgUtil.TriangleHit(this.index-1,T,m,t,v,e,p,r),point:x}),this.hit=!0}}}},osgUtil.IntersectVisitor=function(){osg.NodeVisitor.call(this),this.matrix=[],this.hits=[],this.nodePath=[]},osgUtil.IntersectVisitor.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{addLineSegment:function(t,e){this.start=t,this.end=e},intersectSegmentWithSphere:function(t,e,r){var i=osg.Vec3.sub(t,r.center),o=osg.Vec3.length2(i)-r.radius*r.radius;if(0>o)return!0;var n=osg.Vec3.sub(e,t),a=osg.Vec3.length2(n),s=2*osg.Vec3.dot(i,n),u=s*s-4*a*o;if(0>u)return!1;u=Math.sqrt(u);var h=.5*a,c=(-s-u)*h,g=(-s+u)*h;return 0>=c&&0>=g?!1:c>=1&&g>=1?!1:!0},pushModelMatrix:function(t){if(this.matrix.length>0){var e=osg.Matrix.copy(this.matrix[this.matrix.length-1]);osg.Matrix.preMult(e,t),this.matrix.push(e)}else this.matrix.push(t)},getModelMatrix:function(){return 0===this.matrix.length?osg.Matrix.makeIdentity([]):this.matrix[this.matrix.length-1]},popModelMatrix:function(){return this.matrix.pop()},getWindowMatrix:function(){return this.windowMatrix},getProjectionMatrix:function(){return this.projectionMatrix},getViewMatrix:function(){return this.viewMatrix},intersectSegmentWithGeometry:function(t,e,r){ti=new osgUtil.TriangleIntersect,ti.setNodePath(this.nodePath),ti.set(t,e),ti.apply(r);var i=ti.hits.length;if(i>0){for(var o=0;i>o;o++)this.hits.push(ti.hits[o]);return!0}return!1},pushCamera:function(t){this.projectionMatrix=t.getProjectionMatrix(),this.viewMatrix=t.getViewMatrix();var e=t.getViewport();void 0!==e&&(this.windowMatrix=e.computeWindowMatrix())},applyCamera:function(t){this.pushCamera(t),this.traverse(t)},applyNode:function(t){if(t.getMatrix&&this.pushModelMatrix(t.getMatrix()),t.primitives){var e=[];osg.Matrix.copy(this.getWindowMatrix(),e),osg.Matrix.preMult(e,this.getProjectionMatrix()),osg.Matrix.preMult(e,this.getViewMatrix()),osg.Matrix.preMult(e,this.getModelMatrix());var r=[],i=osg.Matrix.inverse(e,r);if(!i)return;var o=osg.Matrix.transformVec3(r,this.start,Array(3)),n=osg.Matrix.transformVec3(r,this.end,Array(3));this.intersectSegmentWithGeometry(o,n,t)}t.traverse&&this.traverse(t),t.getMatrix&&this.popModelMatrix()},apply:function(t){this.enterNode(t)!==!1&&(t.getViewMatrix?this.applyCamera(t):this.applyNode(t))},enterNode:function(t){var e=t.boundingSphere;return void 0===e||this.intersectSegmentWithSphere?!0:!1}}),function(){var t=function(t){void 0!==t&&(void 0!==t.object&&void 0!==t.field&&this.createInternalSlider(param),this._uniform=this.createInternalSliderUniform(param))};t.prototype={setTargetHTML:function(t){this.parent=t},addToDom:function(t){var e=document.createElement("div");e.innerHTML=t,this.parent.appendChild(e)},getValue:function(t){if(window.localStorage){var e=window.localStorage.getItem(t);return e}return null},setValue:function(t,e){window.localStorage&&window.localStorage.setItem(t,e)},createHTMLSlider:function(t,e,r,i){var o='<div>NAME [ MIN - MAX ] <input type="range" min="MIN" max="MAX" value="VALUE" step="STEP" onchange="ONCHANGE" /><span id="UPDATE"></span></div>',n=t.min,a=t.max,s=t.step,u=r,h=i,c=h+"(this.value)";return o=o.replace(/MIN/g,n),o=o.replace(/MAX/g,a+s),o=o.replace("STEP",s),o=o.replace("VALUE",e),o=o.replace(/NAME/g,u),o=o.replace(/UPDATE/g,h),o=o.replace("ONCHANGE",c)},createUniformFunction:function(t,e,r,i,o){return self=this,function(){var n=e,a=r,s=i,u=o,h=function(e){s.get()[a]=e,s.dirty(),osg.debug(n+" value "+e),document.getElementById(o).innerHTML=Number(e).toFixed(4),self.setValue(u,e),void 0!==t.onchange&&t.onchange(s.get())};return h}()},createFunction:function(t,e,r,i,o,n){return self=this,function(){var a=e,s=o,u=n,h=i,c=function(e){"string"==typeof e&&(e=parseFloat(e)),i[s]?"number"==typeof i[s]?h[s]=e:h[s][r]=e:e=0,osg.debug(a+" value "+e),document.getElementById(n).innerHTML=Number(e).toFixed(4),self.setValue(u,e),void 0!==t.onchange&&t.onchange(h[s])};return c}()},getCallbackName:function(t,e){return"change_"+e+"_"+t},copyDefaultValue:function(t){var e=t.value;return e=Array.isArray(t.value)?t.value.slice():[e]},createInternalSliderUniform:function(t){var e=t.value,r=t.uniform;if(void 0===r){var i=t.type;i=i.charAt(0).toUpperCase()+i.slice(1),r=osg.Uniform["create"+i](e,t.name)}for(var o=this.getCallbackName(t.name,t.id),n=e.length,a=0;n>a;a++){var s=""+a,u=t.name+s,h=o+s,c=e[a],g=this.getValue(h);null!==g?c=g:t.uniform&&void 0!==t.uniform.get()[a]&&(c=t.uniform.get()[a]);var l=this.createHTMLSlider(t,c,u,h);this.addToDom(l),window[h]=this.createUniformFunction(t,u,a,r,h),osg.log(u+" "+c),window[h](c)}return this.uniform=r,r},createInternalSlider:function(t){for(var e=t.value,r=t.name,i=t.id,o=e.length,n=this.getCallbackName(r,i),a=t.object,s=t.field,u=0;o>u;u++){var h=""+u,c=r+h,g=n+h,l=e[u],d=this.getValue(g);null!==d?l=d:a[s]&&(l="number"==typeof a[s]?a[s]:a[s][u]);var f=this.createHTMLSlider(t,l,c,g);this.addToDom(f),window[g]=this.createFunction(t,c,u,a,s,g),osg.log(c+" "+l),window[g](l)}},createSlider:function(t){return void 0!==t.html&&this.setTargetHTML(t.html),void 0===t.id&&(t.id=t.name),t.value=this.copyDefaultValue(t),void 0!==t.type?this.createInternalSliderUniform(t):(void 0===t.object&&(t.object={data:t.value},t.field="data"),this.createInternalSlider(t))}},osgUtil.ParameterVisitor=function(){osg.NodeVisitor.call(this),this.arraySlider=new t,this.setTargetHTML(document.body)},osgUtil.ParameterVisitor.createSlider=function(e){(new t).createSlider(e)},osgUtil.ParameterVisitor.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{setTargetHTML:function(t){this.targetHTML=t,this.arraySlider.setTargetHTML(this.targetHTML)},getUniformList:function(t,e){var r="(uniform)",i=".*?",o="((?:[a-z][a-z]+))",n=".*?",a="((?:[a-z][a-z]+))",s=".*?",u=".",h=".*?",c=".",g=".*?",l="(.)",d="(.)",f=".*?",p="(\\{.*?\\})",m=RegExp(r+i+o+n+a+s+u+h+c+g+l+d+f+p,["g"]),v=t.match(m),_=e;if(null!==v)for(var S=RegExp(r+i+o+n+a+s+u+h+c+g+l+d+f+p,["i"]),y=0,b=v.length;b>y;y++){var T=v[y].match(S);if(null!==T){T[1];var M=T[2],x=T[3];T[4],T[5];var C=T[6],A=JSON.parse(C);A.type=M,A.name=x;var w=A.value;A.value=function(){return w},_[x]=A}}return _},getUniformFromStateSet:function(t,e){var r=t.getUniformList();if(r)for(var i=Object.keys(e),o=0,n=i.length;n>o;o++){var a=i[o];void 0!==r[a]&&void 0===e[a].uniform&&(e[a].uniform=r[a].object)}},findExistingUniform:function(t,e){var r=function(){osg.NodeVisitor.call(this,osg.NodeVisitor.TRAVERSE_PARENTS)};r.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{setUniformMap:function(t){this.uniformMap=t},apply:function(t){var e=t.getStateSet();e&&osgUtil.ParameterVisitor.prototype.getUniformFromStateSet(e,this.uniformMap),this.traverse(t)}});var i=new r;i.setUniformMap(e),t.accept(i)},applyProgram:function(t,e){var r=e.getAttribute("Program"),i=r.getName();r.getVertexShader().getText();var o={};this.getUniformList(r.getVertexShader().getText(),o),this.getUniformList(r.getFragmentShader().getText(),o);var n=Object.keys(o);if(void 0===i){var a=function(t){var e=0,r=0;
if(0===t.length)return e;for(h=0;t.length>h;h++)r=t.charCodeAt(h),e=(e<<5)-e+r,e&=e;return 0>e&&(e=-e),e},s=n.join("");i=""+a(s)}this.findExistingUniform(t,o);for(var u=!1,h=0;n.length>h;h++){{var c=n[h],g=o[c];g.type,g.name}g.id=i;var l=this.arraySlider.createSlider(g);void 0===g.uniform&&l&&e.addUniform(l),u=!0}if(u){var d=document.createElement("div");d.innerHTML="<p> </p>",this.targetHTML.appendChild(d)}osg.log(o)},applyStateSet:function(t,e){void 0!==e.getAttribute("Program")&&this.applyProgram(t,e)},apply:function(t){var e=this.targetHTML;if(void 0!==e&&null!==e){var r=t.getStateSet();void 0!==r&&this.applyStateSet(t,r),this.traverse(t)}}})}(),function(){var t;osgUtil.addFrameBufferVisuals=function(e){if(osgUtil.ComposerdebugNode||(osgUtil.ComposerdebugNode=new osg.Node),osgUtil.ComposerdebugCamera||(osgUtil.ComposerdebugCamera=new osg.Camera),t||(t={x:0,y:100,w:100,h:80,horizontal:!0,screenW:1024,screenH:768,fullscreen:!1}),e&&osg.extend(t,e),osgUtil.ComposerdebugCamera.setProjectionMatrix(osg.Matrix.makeOrtho(0,t.screenW,0,t.screenH,-5,5)),osgUtil.ComposerdebugCamera.setViewMatrix(osg.Matrix.makeTranslate(0,0,0)),osgUtil.ComposerdebugCamera.setRenderOrder(osg.Camera.NESTED_RENDER,0),osgUtil.ComposerdebugCamera.setReferenceFrame(osg.Transform.ABSOLUTE_RF),osgUtil.ComposerdebugCamera.addChild(osgUtil.ComposerdebugNode),!osgUtil.ressourcesCache.frameBufferObjectTarget)return osgUtil.ComposerdebugCamera;var r,i=t.x,o=t.y;osgUtil.ComposerdebugNode.removeChildren();var n,a=[osgUtil.Composer.Filter.defaultFragmentShaderHeader,"void main (void)","{","  gl_FragColor = texture2D(Texture0,FragTexCoord0);","}",""].join("\n"),s=new osg.Program(new osg.Shader(gl.VERTEX_SHADER,osgUtil.Composer.Filter.defaultVertexShader),new osg.Shader(gl.FRAGMENT_SHADER,a));n=osgUtil.ComposerdebugNode.getOrCreateStateSet(),t.fullscreen||n.setAttributeAndModes(new osg.Depth("DISABLE")),n.setAttributeAndModes(s);for(var u=0,h=osgUtil.ressourcesCache.frameBufferObjectTarget.length;h>u;u++)r=osgUtil.ressourcesCache.frameBufferObjectTarget[u],r&&(quad=osg.createTexturedQuadGeometry(i,o,0,t.w,0,0,0,t.h,0),n=quad.getOrCreateStateSet(),n.setTextureAttributeAndMode(0,r),n.setAttributeAndModes(s),osgUtil.ComposerdebugNode.addChild(quad),t.horizontal?i+=t.w+2:o+=t.h+2);return osgUtil.ComposerdebugCamera},osgUtil.Composer=function(){osg.Node.call(this),this._stack=[],this._renderToScreen=!1,this._dirty=!1;var t=this,e=function(){};e.prototype={update:function(e,r){e.isDirty()&&e.build();for(var i=0,o=t._stack.length;o>i;i++)t._stack[i].filter.update(r)}},this.setUpdateCallback(new e)},osgUtil.Composer.prototype=osg.objectInehrit(osg.Node.prototype,{dirty:function(){for(var t=0,e=this._stack.length;e>t;t++)this._stack[t].filter.dirty()},addPass:function(t,e,r){e instanceof osg.Texture?this._stack.push({filter:t,texture:e}):void 0!==e&&void 0!==r?this._stack.push({filter:t,width:Math.floor(e),height:Math.floor(r)}):this._stack.push({filter:t})},removePass:function(t){var e=this._stack.indexOf(t);if(-1!==e){this._stack.splice(e,1);for(var r=0,i=this._stack.length;i>r;r++)this._stack[r].filter.dirty()}},hasPass:function(t){return-1!==this._stack.indexOf(t)},renderToScreen:function(t,e){this._renderToScreen=!0,this._renderToScreenWidth=t,this._renderToScreenHeight=e},isDirty:function(){for(var t=0,e=this._stack.length;e>t;t++)if(this._stack[t].filter.isDirty())return!0;return!1},removeDebugVisuals:function(){this.debugNode.removeChildren()},build:function(){var t,e,r,i,o,n=this,a=this,s=!1;this._stack.forEach(function(u,h,c){u.filter.isDirty()&&u.filter.build();var g,l,d=u.filter.getStateSet();if(h===c.length-1&&a._renderToScreen===!0)g=a._renderToScreenWidth,l=a._renderToScreenHeight,void 0!==u.filter.texture&&(u.filter.texture.releaseGLObjects(),u.filter.texture=void 0,u.texture=void 0),s=!0;else if(void 0!==u.texture)g=u.texture.getWidth(),l=u.texture.getHeight();else if(void 0!==u.filter.texture)u.texture=u.filter.texture,g=u.texture.getWidth(),l=u.texture.getHeight();else if(void 0!==u.width&&void 0!==u.height)g=u.width,l=u.height;else{var f=d.getTextureAttribute(0,"Texture");void 0===f&&osg.warn("osgComposer can't find any information to setup texture output size"),g=f.getWidth(),l=f.getHeight()}var p=h===c.length-1&&a._renderToScreen===!0;return p||void 0!==d.getAttribute("Program")?(u.filter.camera?(e=u.filter.camera,o=u.texture):(e=new osg.Camera,e.setClearMask(0),n.addChild(e)),s?e.setRenderOrder(osg.Camera.POST_RENDER,0):(e.setRenderOrder(osg.Camera.PRE_RENDER,0),void 0===o&&(o=new osg.Texture),(u.filter.w!==g||u.filter.h!==l||void 0===u.texture)&&(o.setTextureSize(g,l),e.attachTexture(osg.FrameBufferObject.COLOR_ATTACHMENT0,o,0),u.texture=o,u.filter.texture=o)),u.filter.w!==g&&u.filter.h!==l&&(r=new osg.Viewport(0,0,g,l),projection=osg.Matrix.makeOrtho(-g/2,g/2,-l/2,l/2,-5,5,[]),e.setReferenceFrame(osg.Transform.ABSOLUTE_RF),e.setViewport(r),e.setProjectionMatrix(projection),e.setStateSet(u.filter.getStateSet()),e.removeChildren(),i=osg.createTexturedQuadGeometry(-g/2,-l/2,0,g,0,0,0,l,0),void 0!==u.filter.buildGeometry&&(i=u.filter.buildGeometry(i)),i.setStateSet(u.filter.getStateSet()),i.setName("composer layer"),e.addChild(i),u.filter.camera=e,u.filter.w=g,u.filter.h=l,u.filter.getStateSet().addUniform(osg.Uniform.createFloat2([g,l],"RenderSize"))),u.filter.toScreen=s,t=o,c.length>h+1&&c[h+1].filter.getStateSet().setTextureAttributeAndModes(0,t),e.setName("Composer Pass"+h),void 0):(c[h+1].filter.getStateSet().setTextureAttributeAndModes(0,d.getTextureAttribute(0,"Texture")),void 0)}),this._resultTexture=t}}),osgUtil.Composer.Filter=function(){this._stateSet=new osg.StateSet,this._dirty=!0},osgUtil.Composer.Filter.prototype={getStateSet:function(){return this._stateSet},getOrCreateStateSet:function(){return this._stateSet},dirty:function(){this._dirty=!0},isDirty:function(){return this._dirty},update:function(){}},osgUtil.Composer.Filter.defaultVertexShader=["#ifdef GL_ES","precision highp float;","#endif","attribute vec3 Vertex;","attribute vec2 TexCoord0;","varying vec2 FragTexCoord0;","uniform mat4 ModelViewMatrix;","uniform mat4 ProjectionMatrix;","void main(void) {","  gl_Position = ProjectionMatrix * ModelViewMatrix * vec4(Vertex,1.0);","  FragTexCoord0 = TexCoord0;","}",""].join("\n"),osgUtil.Composer.Filter.defaultFragmentShaderHeader=["#ifdef GL_ES","precision highp float;","#endif","varying vec2 FragTexCoord0;","uniform vec2 RenderSize;","uniform sampler2D Texture0;",""].join("\n"),osgUtil.Composer.Filter.shaderUtils=["vec4 packFloatTo4x8(in float v) {","vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;","enc = fract(enc);","enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);","return enc;","}"," ","vec4 pack2FloatTo4x8(in vec2 val) {"," const vec2 bitSh = vec2(256.0, 1.0);"," const vec2 bitMsk = vec2(0.0, 1.0/256.0);"," vec2 res1 = fract(val.x * bitSh);"," res1 -= res1.xx * bitMsk;"," vec2 res2 = fract(val.y * bitSh);"," res2 -= res2.xx * bitMsk;"," return vec4(res1.x,res1.y,res2.x,res2.y);","}"," ","float unpack4x8ToFloat( vec4 rgba ) {"," return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );","}"," ","vec2 unpack4x8To2Float(in vec4 val) {"," const vec2 unshift = vec2(1.0/256.0, 1.0);"," return vec2(dot(val.xy, unshift), dot(val.zw, unshift));","}","vec2 encodeNormal (vec3 n)","{","    float f = sqrt(8.0*n.z+8.0);","    return n.xy / f + 0.5;","}","vec3 decodeNormal (vec2 enc)","{","    vec2 fenc = enc*4.0-2.0;","    float f = dot(fenc,fenc);","    float g = sqrt(1.0-f/4.0);","    vec3 n;","    n.xy = fenc*g;","    n.z = 1.0-f/2.0;","    return n;","}",""].join("\n"),osgUtil.Composer.Filter.Helper={getOrCreatePascalCoefficients:function(){var t=osgUtil.Composer.Filter.Helper.getOrCreatePascalCoefficients.cache;return void 0!==t?t:(t=function(t){for(var e=[[1]],r=0;t-1>r;r++){Math.pow(2,r);var i=e[r],o=i.length,n=o+1,a=Array(o);a[0]=1,a[n-1]=1;for(var s=1,u=0;o-1>u;u++){var h=i[u]+i[u+1];a[s++]=h}e.push(a)}return function(){for(var t=0;e.length>t;t++)for(var r=e[t],i=Math.pow(2,t),o=0;r.length>o;o++)r[o]=r[o]/i}(),e}(20),osgUtil.Composer.Filter.Helper.getOrCreatePascalCoefficients.cache=t,t)}},osgUtil.Composer.Filter.Custom=function(t,e){osgUtil.Composer.Filter.call(this),this._fragmentShader=t,this._uniforms=e,this._vertexShader=osgUtil.Composer.Filter.defaultVertexShader},osgUtil.Composer.Filter.Custom.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{build:function(){var t=new osg.Program(new osg.Shader("VERTEX_SHADER",this._vertexShader),new osg.Shader("FRAGMENT_SHADER",this._fragmentShader));if(this._uniforms){var e=0,r=this._fragmentShader.match(/uniform\s+\w+\s+\w+/g);if(null!==r)for(var i=0,o=r.length;o>i;i++){var n,a=r[i].match(/uniform\s+(\w+)\s+(\w+)/),s=a[1],u=a[2];void 0!==this._uniforms[u]&&(uniform_value=this._uniforms[u],-1!==s.search("sampler")?(this._stateSet.setTextureAttributeAndModes(e,uniform_value),n=osg.Uniform.createInt1(e,u),e++,this._stateSet.addUniform(n)):(n=osg.Uniform.isUniform(uniform_value)?uniform_value:osg.Uniform[s](this._uniforms[u],u),this._stateSet.addUniform(n)))}}this._stateSet.setAttributeAndModes(t),this._dirty=!1}}),osgUtil.Composer.Filter.Blur=function(t,e,r,i){osgUtil.Composer.Filter.call(this),this._BlurScale=osg.Uniform.createFloat(r,"BlurScale"),this._BlurAmount=osg.Uniform.createInt(e,"BlurAmount"),this._BlurStrength=osg.Uniform.createFloat(i,"BlurStrength"),this._Orientation=osg.Uniform.createInt1(t,"Orientation")},osgUtil.Composer.Filter.Blur.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{setBlurAmount:function(t){this._BlurAmount.set(t)},setBlurScale:function(t){this._BlurScale.set(t)},setBlurStrength:function(t){this._BlurStrength.set(t)},build:function(){var t=osgUtil.Composer.Filter.defaultVertexShader,e=[osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform int Orientation;uniform int BlurAmount;uniform float BlurScale;uniform float BlurStrength;float Gaussian(float x, float deviation){    return(1.0 / sqrt(2.0 * 3.141592 * deviation)) * exp(-((x * x) / (2.0 * deviation)));}void main(void){    float halfBlur = float(BlurAmount) * 0.5;    vec4 colour = vec4(0.0);    vec4 texColour = vec4(0.0);    /* Gaussian deviation*/    float deviation = halfBlur * 0.35;    deviation *= deviation;    float strength = 1.0 - BlurStrength;    if(Orientation == 0) {       /* Horizontal blur */        for(int i = 0; i < 50; ++i)        {            if(i >= BlurAmount)                break;            float offset = float(i) - halfBlur;            vec2 texCoord = FragTexCoord0.xy + vec2(offset * (1.0 / RenderSize.x) * BlurScale, 0.0);            texColour = texture2D(Texture0, texCoord);           /* texColour.rgb += texColour.rgb / texColour.a; */           colour += texColour * Gaussian(offset * strength, deviation);        }    }    else    {        /*Vertical blur*/        for(int i = 0; i < 50; ++i)        {            if(i >= BlurAmount) break;            float offset = float(i) - halfBlur;            vec2 texCoord = FragTexCoord0.xy + vec2(0.0, offset * (1.0 / RenderSize.y) * BlurScale);            texColour = texture2D(Texture0, texCoord);          /*  texColour.rgb += texColour.rgb / texColour.a;*/           colour += texColour * Gaussian(offset * strength, deviation);        }    }    /* Apply colour */    gl_FragColor = clamp(colour, 0.0, 1.0);  /*  gl_FragColor.rgb *= gl_FragColor.a;*/}",""].join("\n"),r=new osg.Program(new osg.Shader("VERTEX_SHADER",t),new osg.Shader("FRAGMENT_SHADER",e));void 0===this._stateSet.getUniform("Texture0")&&this._stateSet.addUniform(osg.Uniform.createInt1(0,"Texture0")),this._stateSet.addUniform(this._BlurStrength),this._stateSet.addUniform(this._BlurAmount),this._stateSet.addUniform(this._BlurScale),this._stateSet.addUniform(this._Orientation),this._stateSet.setAttributeAndModes(r),this._dirty=!1}}),osgUtil.Composer.Filter.AverageHBlur=function(t){osgUtil.Composer.Filter.call(this),void 0===t?this.setBlurSize(5):this.setBlurSize(t),this._pixelSize=1},osgUtil.Composer.Filter.AverageHBlur.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{setBlurSize:function(t){1!==t%2&&(t+=1),this._nbSamples=t,this.dirty()},setPixelSize:function(t){this._pixelSize=t,this.dirty()},getUVOffset:function(t){return"vec2(float("+t+"), 0.0)/RenderSize[0];"},getShaderBlurKernel:function(){var t=this._nbSamples,e=[];e.push(" pixel = texture2D(Texture0, FragTexCoord0 );"),e.push(" if (pixel.w == 0.0) { gl_FragColor = pixel; return; }"),e.push(" vec2 offset;");for(var r=1;Math.ceil(t/2)>r;r++)e.push(" offset = "+this.getUVOffset(r*this._pixelSize)),e.push(" pixel += texture2D(Texture0, FragTexCoord0 + offset);"),e.push(" pixel += texture2D(Texture0, FragTexCoord0 - offset);");return e.push(" pixel /= float("+t+");"),e},build:function(){this._nbSamples;var t=osgUtil.Composer.Filter.defaultVertexShader,e=[osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform float width;","void main (void)","{","  vec4 pixel;",this.getShaderBlurKernel().join("\n"),"  gl_FragColor = vec4(pixel);","}",""].join("\n"),r=new osg.Program(new osg.Shader("VERTEX_SHADER",t),new osg.Shader("FRAGMENT_SHADER",e));void 0===this._stateSet.getUniform("Texture0")&&this._stateSet.addUniform(osg.Uniform.createInt1(0,"Texture0")),this._stateSet.setAttributeAndModes(r),this._dirty=!1}}),osgUtil.Composer.Filter.AverageVBlur=function(t){osgUtil.Composer.Filter.AverageHBlur.call(this,t)},osgUtil.Composer.Filter.AverageVBlur.prototype=osg.objectInehrit(osgUtil.Composer.Filter.AverageHBlur.prototype,{getUVOffset:function(t){return"vec2(0.0, float("+t+"))/RenderSize[1];"}}),osgUtil.Composer.Filter.BilateralHBlur=function(t){osgUtil.Composer.Filter.call(this),void 0===t&&(t={});var e=t.nbSamples,r=t.depthTexture,i=t.radius;void 0===e?this.setBlurSize(5):this.setBlurSize(e),this._depthTexture=r,this._radius=osg.Uniform.createFloat(1,"radius"),this._pixelSize=osg.Uniform.createFloat(1,"pixelSize"),this.setRadius(i)},osgUtil.Composer.Filter.BilateralHBlur.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{setBlurSize:function(t){1!==t%2&&(t+=1),this._nbSamples=t,this.dirty()},setPixelSize:function(t){this._pixelSize.get()[0]=t,this._pixelSize.dirty()},setRadius:function(t){this._radius.get()[0]=t,this._radius.dirty()},getUVOffset:function(t){return"vec2(0.0, float("+t+") * pixelSize )/RenderSize[1];"},getShaderBlurKernel:function(){var t=this._nbSamples,e=[];e.push(" pixel = texture2D(Texture0, FragTexCoord0 );"),e.push(" if (pixel.w <= 0.0001) { gl_FragColor = vec4(1.0); return; }"),e.push(" vec2 offset, tmpUV;"),e.push(" depth = getDepthValue(texture2D(Texture1, FragTexCoord0 ));");for(var r=1;Math.ceil(t/2)>r;r++)e.push(" offset = "+this.getUVOffset(r)),e.push(" tmpUV =  FragTexCoord0 + offset;"),e.push(" tmpDepth = getDepthValue(texture2D(Texture1, tmpUV ));"),e.push(" if ( abs(depth-tmpDepth) < radius) {"),e.push("   pixel += texture2D(Texture0, tmpUV);"),e.push("   nbHits += 1.0;"),e.push(" }"),e.push(" tmpUV =  FragTexCoord0 - offset;"),e.push(" tmpDepth = getDepthValue(texture2D(Texture1, tmpUV ));"),e.push(" if ( abs(depth-tmpDepth) < radius) {"),e.push("   pixel += texture2D(Texture0, tmpUV);"),e.push("   nbHits += 1.0;"),e.push(" }");return e.push(" pixel /= nbHits;"),e},build:function(){this._nbSamples;var t=osgUtil.Composer.Filter.defaultVertexShader,e=[osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform sampler2D Texture1;","uniform float width;","uniform mat4 projection;","uniform float radius;","uniform float pixelSize;","float znear,zfar,zrange;","",osgUtil.Composer.Filter.shaderUtils,"","float getDepthValue(vec4 v) {","  float depth = unpack4x8ToFloat(v);","  depth = depth*zrange+znear;","  return -depth;","}","void main (void)","{","  vec4 pixel;","  float depth, tmpDepth;","  znear = projection[3][2] / (projection[2][2]-1.0);","  zfar = projection[3][2] / (projection[2][2]+1.0);","  zrange = zfar-znear;","  float nbHits = 1.0;",this.getShaderBlurKernel().join("\n"),"  gl_FragColor = vec4(pixel);","}",""].join("\n"),r=new osg.Program(new osg.Shader("VERTEX_SHADER",t),new osg.Shader("FRAGMENT_SHADER",e));void 0===this._stateSet.getUniform("Texture0")&&this._stateSet.addUniform(osg.Uniform.createInt1(0,"Texture0")),void 0===this._stateSet.getUniform("Texture1")&&this._stateSet.addUniform(osg.Uniform.createInt1(1,"Texture1")),this._stateSet.addUniform(this._radius),this._stateSet.addUniform(this._pixelSize),this._stateSet.setTextureAttributeAndModes(1,this._depthTexture),this._stateSet.setAttributeAndModes(r),this._dirty=!1}}),osgUtil.Composer.Filter.BilateralVBlur=function(t){osgUtil.Composer.Filter.BilateralHBlur.call(this,t)},osgUtil.Composer.Filter.BilateralVBlur.prototype=osg.objectInehrit(osgUtil.Composer.Filter.BilateralHBlur.prototype,{getUVOffset:function(t){return"vec2(float("+t+")*pixelSize,0.0)/RenderSize[0];"}}),osgUtil.Composer.Filter.InputTexture=function(t){osgUtil.Composer.Filter.call(this),this._stateSet.setTextureAttributeAndModes(0,t)},osgUtil.Composer.Filter.InputTexture.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{build:function(){this._dirty=!1}}),osgUtil.Composer.Filter.HBlur=function(t){osgUtil.Composer.Filter.call(this),void 0===t?this.setBlurSize(5):this.setBlurSize(t)},osgUtil.Composer.Filter.HBlur.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{setBlurSize:function(t){1!==t%2&&(t+=1),this._nbSamples=t,this.dirty()},getUVOffset:function(t){return"vec2(float("+t+"), 0.0)/RenderSize[0];"},build:function(){var t=this._nbSamples,e=osgUtil.Composer.Filter.defaultVertexShader,r=osgUtil.Composer.Filter.Helper.getOrCreatePascalCoefficients(),i=r[t-1],o=Math.floor(t/2),n=[];n.push(" pixel += float("+i[o]+")*texture2D(Texture0, FragTexCoord0 ).rgb;");var a=1;n.push(" vec2 offset;");for(var s=o+1;t>s;s++){var u=i[s];n.push(" offset = "+this.getUVOffset(s)),a++,n.push(" pixel += "+u+"*texture2D(Texture0, FragTexCoord0 + offset).rgb;"),n.push(" pixel += "+u+"*texture2D(Texture0, FragTexCoord0 - offset).rgb;")}var h=[osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform float width;","void main (void)","{","  vec3 pixel;",n.join("\n"),"  gl_FragColor = vec4(pixel,1.0);","}",""].join("\n"),c=new osg.Program(new osg.Shader("VERTEX_SHADER",e),new osg.Shader("FRAGMENT_SHADER",h));void 0===this._stateSet.getUniform("Texture0")&&this._stateSet.addUniform(osg.Uniform.createInt1(0,"Texture0")),this._stateSet.setAttributeAndModes(c),this._dirty=!1}}),osgUtil.Composer.Filter.VBlur=function(){osgUtil.Composer.Filter.HBlur.call(this)},osgUtil.Composer.Filter.VBlur.prototype=osg.objectInehrit(osgUtil.Composer.Filter.HBlur.prototype,{getUVOffset:function(t){return"vec2(0.0, float("+t+"))/RenderSize[1];"}}),osgUtil.Composer.Filter.SobelFilter=function(){osgUtil.Composer.Filter.call(this),this._color=osg.Uniform.createFloat3([1,1,1],"color"),this._factor=osg.Uniform.createFloat(1,"factor")},osgUtil.Composer.Filter.SobelFilter.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{setColor:function(t){this._color.get()[0]=t[0],this._color.get()[1]=t[1],this._color.get()[2]=t[2],this._color.dirty()},setFactor:function(t){this._factor.get()[0]=t,this._factor.dirty()},build:function(){var t=this._stateSet,e=osgUtil.Composer.Filter.defaultVertexShader,r=["",osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform vec3 color;","uniform float factor;","void main (void)","{","  float fac0 = 2.0;","  float fac1 = 1.0;","  float offsetx = 1.0/RenderSize[0];","  float offsety = 1.0/RenderSize[1];","  vec4 texel0 = texture2D(Texture0, FragTexCoord0 + vec2(offsetx, offsety));","  vec4 texel1 = texture2D(Texture0, FragTexCoord0 + vec2(offsetx, 0.0));","  vec4 texel2 = texture2D(Texture0, FragTexCoord0 + vec2(offsetx, -offsety));","  vec4 texel3 = texture2D(Texture0, FragTexCoord0 + vec2(0.0, -offsety));","  vec4 texel4 = texture2D(Texture0, FragTexCoord0 + vec2(-offsetx, -offsety));","  vec4 texel5 = texture2D(Texture0, FragTexCoord0 + vec2(-offsetx, 0.0));","  vec4 texel6 = texture2D(Texture0, FragTexCoord0 + vec2(-offsetx, offsety));","  vec4 texel7 = texture2D(Texture0, FragTexCoord0 + vec2(0.0, offsety));","  vec4 rowx = -fac0*texel5 + fac0*texel1 +  -fac1*texel6 + fac1*texel0 + -fac1*texel4 + fac1*texel2;","  vec4 rowy = -fac0*texel3 + fac0*texel7 +  -fac1*texel4 + fac1*texel6 + -fac1*texel2 + fac1*texel0;","  float mag = sqrt(dot(rowy,rowy)+dot(rowx,rowx));","  if (mag < 1.0/255.0) { discard; return; }","  mag *= factor;","  mag = min(1.0, mag);","  gl_FragColor = vec4(color*mag,mag);","}",""].join("\n"),i=new osg.Program(new osg.Shader("VERTEX_SHADER",e),new osg.Shader("FRAGMENT_SHADER",r));t.setAttributeAndModes(i),t.addUniform(this._color),t.addUniform(this._factor),t.addUniform(osg.Uniform.createInt1(0,"Texture0")),this._dirty=!1}}),osgUtil.Composer.Filter.AdditiveBlend=function(){osgUtil.Composer.Filter.call(this);var t,e,r=0,i=1,o=this._stateSet;3===arguments.length?(t=arguments[0],e=arguments[1],r=1,i=2,o.setTextureAttributeAndModes(r,t)):2===arguments.length?e=arguments[0]:1===arguments.length&&(e=arguments[0]),o.setTextureAttributeAndModes(i,e),o.addUniform(osg.Uniform.createInt1(r,"Texture0")),o.addUniform(osg.Uniform.createInt1(i,"Texture1"))},osgUtil.Composer.Filter.AdditiveBlend.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{build:function(){var t=this._stateSet,e=osgUtil.Composer.Filter.defaultVertexShader,r=["",osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform sampler2D Texture1;","void main (void)","{","  vec4 src = texture2D(Texture0,FragTexCoord0);","  vec4 dst = texture2D(Texture1,FragTexCoord0);","//src.rgba = src.rgba / src.a; ","//dst.rgba = dst.rgba / dst.a; ","gl_FragColor.rgb = min(dst.rgb + src.rgb, 1.0);"," gl_FragColor =clamp((src + dst) - (src * dst), 0.0, 1.0);","//  gl_FragColor = mix(dst, src, dst.a); "," //gl_FragColor.a = max(dst.a, src.a);"," //gl_FragColor.rgba =  gl_FragColor.rgba*gl_FragColor.a;","// gl_FragColor.a = 0.1;","// gl_FragColor = src;","return;","if (src.a == 0.0 && dst.a == 0.0)","gl_FragColor = vec4(0.0,0.0,0.0,0.0);","else if (dst.a == 0.0)","gl_FragColor = src;","else if (src.a == 0.0)","gl_FragColor = dst;","else","gl_FragColor = min(dst + src, 0.0);","}",""].join("\n"),i=new osg.Program(new osg.Shader("VERTEX_SHADER",e),new osg.Shader("FRAGMENT_SHADER",r));t.setAttributeAndModes(i),this._dirty=!1}}),osgUtil.Composer.Filter.BlendMix=function(){osgUtil.Composer.Filter.call(this);var t,e,r,i=0,o=1,n=this._stateSet;3===arguments.length?(t=arguments[0],e=arguments[1],r=arguments[2],i=1,o=2,n.setTextureAttributeAndModes(i,t)):2===arguments.length?(e=arguments[0],r=arguments[1]):1===arguments.length&&(e=arguments[0],r=.5),n.setTextureAttributeAndModes(o,e),n.addUniform(osg.Uniform.createInt1(i,"Texture0")),n.addUniform(osg.Uniform.createInt1(o,"Texture1")),this._mixValueUniform=osg.Uniform.createFloat1(r,"MixValue"),n.addUniform(mixValueUniform)},osgUtil.Composer.Filter.BlendMix.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{getBlendFactorUniform:function(){return this._mixValueUniform},build:function(){var t=this._stateSet,e=osgUtil.Composer.Filter.defaultVertexShader,r=["",osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform sampler2D Texture1;","uniform float MixValue;","void main (void)","{","  gl_FragColor = mix(texture2D(Texture0,FragTexCoord0), texture2D(Texture1,FragTexCoord0),MixValue);","}",""].join("\n"),i=new osg.Program(new osg.Shader("VERTEX_SHADER",e),new osg.Shader("FRAGMENT_SHADER",r));t.setAttributeAndModes(i),this._dirty=!1}}),osgUtil.Composer.Filter.BlendMultiply=function(){osgUtil.Composer.Filter.call(this);var t,e,r=this._stateSet,i=0,o=1;2===arguments.length?(t=arguments[0],e=arguments[1],i=1,i=2,r.setTextureAttributeAndModes(i,t)):1===arguments.length&&(e=arguments[0]),r.setTextureAttributeAndModes(o,e),r.addUniform(osg.Uniform.createInt1(i,"Texture0")),r.addUniform(osg.Uniform.createInt1(o,"Texture1"))},osgUtil.Composer.Filter.BlendMultiply.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{build:function(){var t=osgUtil.Composer.Filter.defaultVertexShader,e=["",osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform sampler2D Texture1;","uniform float MixValue;","void main (void)","{","  gl_FragColor = texture2D(Texture0,FragTexCoord0)*texture2D(Texture1,FragTexCoord0);","}",""].join("\n"),r=new osg.Program(new osg.Shader("VERTEX_SHADER",t),new osg.Shader("FRAGMENT_SHADER",e));this._stateSet.setAttributeAndModes(r),this._dirty=!1}}),osgUtil.Composer.Filter.SSAO=function(t){osgUtil.Composer.Filter.call(this);var e=this._stateSet,r=16,i=.05;void 0!==t&&(void 0!==t.nbSamples&&(r=t.nbSamples),void 0!==t.radius&&(i=t.radius));var o=t.normal,n=t.position;this._radius=i,this._nbSamples=r,this._noiseTextureSize=16,this._sceneRadius=2,e.addUniform(osg.Uniform.createFloat1(1,"Power")),e.addUniform(osg.Uniform.createFloat1(i,"Radius")),e.addUniform(osg.Uniform.createInt1(0,"Texture0")),e.addUniform(osg.Uniform.createInt1(1,"Texture1")),e.addUniform(osg.Uniform.createInt1(2,"Texture2")),e.addUniform(osg.Uniform.createFloat1(.1,"AngleLimit"));var a=o.getWidth(),s=o.getHeight();this._size=[a,s],e.setTextureAttributeAndModes(0,o),e.setTextureAttributeAndModes(1,n),this.initNoise()},osgUtil.Composer.Filter.SSAO.prototype=osg.objectInehrit(osgUtil.Composer.Filter.prototype,{initNoise:function(){var t=this._noiseTextureSize,e=Array(3*t*t);(function(e){for(var r=0;t*t>r;r++){var i,o,n;i=2*(Math.random()-.5),o=2*(Math.random()-.5),n=0;var a=osg.Vec3.normalize([i,o,n],[]);e[3*r+0]=255*(.5*a[0]+.5),e[3*r+1]=255*(.5*a[1]+.5),e[3*r+2]=255*(.5*a[2]+.5)}})(e);var r=new osg.Texture;r.setWrapS("REPEAT"),r.setWrapT("REPEAT"),r.setMinFilter("NEAREST"),r.setMagFilter("NEAREST"),r.setTextureSize(t,t),r.setImage(new Uint8Array(e),"RGB"),this._noiseTexture=r},setSceneRadius:function(t){this._sceneRadius=t,this.dirty()},setAngleLimit:function(t){var e=this._stateSet.getUniform("AngleLimit");e.get()[0]=t,e.dirty()},setNbSamples:function(t){t!==this._nbSamples&&(this._nbSamples=Math.floor(t),this.dirty())},setRadius:function(t){var e=this._stateSet.getUniform("Radius");e.get()[0]=t,e.dirty()},setPower:function(t){var e=this._stateSet.getUniform("Power");e.get()[0]=t,e.dirty()},build:function(){var t=this._stateSet,e=this._nbSamples,r=Array(4*e);(function(t){for(var r=0;e>r;r++){var i,o,n;i=2*(Math.random()-.5),o=2*(Math.random()-.5),n=Math.random();var a=osg.Vec3.normalize([i,o,n],[]),s=Math.max(r/e,.1);s=.1+.9*s*s,t[3*r+0]=a[0],t[3*r+1]=a[1],t[3*r+2]=a[2],t[3*r+3]=s}})(r),t.setTextureAttributeAndModes(2,this._noiseTexture);var i=t.getUniform("noiseSampling");void 0===i?(i=osg.Uniform.createFloat2([this._size[0]/this._noiseTextureSize,this._size[1]/this._noiseTextureSize],"noiseSampling"),t.addUniform(i)):(i.set([this._size[0]/this._noiseTextureSize,this._size[1]/this._noiseTextureSize]),i.dirty());for(var o=["","#ifdef GL_ES","precision highp float;","#endif","attribute vec3 Vertex;","attribute vec2 TexCoord0;","varying vec2 FragTexCoord0;","uniform mat4 ModelViewMatrix;","uniform mat4 ProjectionMatrix;","void main(void) {","  gl_Position = ProjectionMatrix * ModelViewMatrix * vec4(Vertex,1.0);","  FragTexCoord0 = TexCoord0;","}",""].join("\n"),n=[],a=0;e>a;a++)n.push("kernel["+a+"] = vec4("+r[3*a]+","+r[3*a+1]+", "+r[3*a+2]+", "+r[3*a+3]+");");n=n.join("\n"),.002*this._sceneRadius,.05*this._sceneRadius;var s=["",osgUtil.Composer.Filter.defaultFragmentShaderHeader,"uniform sampler2D Texture1;","uniform sampler2D Texture2;","uniform mat4 projection;","uniform vec2 noiseSampling;","uniform float Power;","uniform float Radius;","uniform float AngleLimit;","#define NB_SAMPLES "+this._nbSamples,"float depth;","vec3 normal;","vec4 position;","vec4 kernel["+e+"];","mat3 computeBasis()","{","  vec2 uvrand = FragTexCoord0*noiseSampling;","  vec3 rvec = texture2D(Texture2, uvrand*2.0).xyz*2.0-vec3(1.0);","  vec3 tangent = normalize(rvec - normal * dot(rvec, normal));","  vec3 bitangent = cross(normal, tangent);","  mat3 tbn = mat3(tangent, bitangent, normal);","  return tbn;","}","void main (void)","{",n,"  position = texture2D(Texture1, FragTexCoord0);","  vec4 p = texture2D(Texture0, FragTexCoord0);","  depth = p.w;","  normal = vec3(p);","  if ( position.w == 0.0) {","     gl_FragColor = vec4(1.0,1.0,1.0,0.0);","     return;","  }",""," mat3 tbn = computeBasis();"," float occlusion = 0.0;"," for (int i = 0; i < NB_SAMPLES; i++) {","    vec3 vecKernel = vec3(kernel[i]);","    vecKernel[2] = max(AngleLimit,vecKernel[2]);","    vec3 sample = tbn * vecKernel;","    vec3 dir = sample;","    float w = dot(dir, normal);","    float dist = 1.0-kernel[i].w;","    w *= dist*dist*Power;","    sample = dir * float(Radius) + position.xyz;","    vec4 offset = projection * vec4(sample,1.0);","    offset.xy /= offset.w;","    offset.xy = offset.xy * 0.5 + 0.5;","    float sample_depth = texture2D(Texture1, offset.xy).z;","    float range_check = abs(sample.z - sample_depth) < float(Radius) ? 1.0 : 0.0;","    occlusion += (sample_depth > sample.z ? 1.0 : 0.0) * range_check*w;"," }"," occlusion = 1.0 - (occlusion / float(NB_SAMPLES));"," gl_FragColor = vec4(vec3(occlusion),1.0);","}",""].join("\n"),u=new osg.Program(new osg.Shader("VERTEX_SHADER",o),new osg.Shader("FRAGMENT_SHADER",s));t.setAttributeAndModes(u),this._dirty=!1}}),osgUtil.Composer.Filter.SSAO8=function(t){osgUtil.Composer.Filter.SSAO.call(this,t)},osgUtil.Composer.Filter.SSAO8.prototype=osg.objectInehrit(osgUtil.Composer.Filter.SSAO.prototype,{buildGeometry:function(t){return t.getAttributes().TexCoord1=this._texCoord1,t},build:function(){var t=this._stateSet,e=this._nbSamples,r=Array(4*e);this._angleLimit,function(t){for(var r=0;e>r;r++){var i,o,n;i=2*(Math.random()-.5),o=2*(Math.random()-.5),n=Math.random();var a=osg.Vec3.normalize([i,o,n],[]),s=Math.max(r/e,.1);s=.1+.9*s*s,t[3*r+0]=a[0],t[3*r+1]=a[1],t[3*r+2]=a[2],t[3*r+3]=s}}(r),this._noiseTextureSize,t.setTextureAttributeAndModes(2,this._noiseTexture);var i=t.getUniform("noiseSampling");void 0===i?(i=osg.Uniform.createFloat2([this._size[0]/this._noiseTextureSize,this._size[1]/this._noiseTextureSize],"noiseSampling"),t.addUniform(i)):(i.set([this._size[0]/this._noiseTextureSize,this._size[1]/this._noiseTextureSize]),i.dirty());for(var o=["","#ifdef GL_ES","precision highp float;","#endif","attribute vec3 Vertex;","attribute vec2 TexCoord0;","attribute vec3 TexCoord1;","varying vec2 FragTexCoord0;","varying vec3 FragTexCoord1;","uniform mat4 ModelViewMatrix;","uniform mat4 ProjectionMatrix;","void main(void) {","  gl_Position = ProjectionMatrix * ModelViewMatrix * vec4(Vertex,1.0);","  FragTexCoord0 = TexCoord0;","  FragTexCoord1 = TexCoord1;","}",""].join("\n"),n=[],a=0;e>a;a++)n.push("kernel["+a+"] = vec4("+r[3*a]+","+r[3*a+1]+", "+r[3*a+2]+", "+r[3*a+3]+");");n=n.join("\n"),.002*this._sceneRadius,.05*this._sceneRadius;var s=["",osgUtil.Composer.Filter.defaultFragmentShaderHeader,"varying vec3 FragTexCoord1;","uniform sampler2D Texture1;","uniform sampler2D Texture2;","uniform mat4 projection;","uniform vec2 noiseSampling;","uniform float Power;","uniform float Radius;","uniform float AngleLimit;","#define NB_SAMPLES "+this._nbSamples,"float depth;","float znear, zfar, zrange;","vec3 normal;","vec3 position;","vec4 kernel["+e+"];",osgUtil.Composer.Filter.shaderUtils,"mat3 computeBasis()","{","  vec2 uvrand = FragTexCoord0*noiseSampling;","  //uvrand = rand(gl_FragCoord.xy);","  vec3 rvec = texture2D(Texture2, uvrand*2.0).xyz*2.0-vec3(1.0);","  //vec3 rvec = normalize(vec3(uvrand,0.0));","  vec3 tangent = normalize(rvec - normal * dot(rvec, normal));","  vec3 bitangent = cross(normal, tangent);","  mat3 tbn = mat3(tangent, bitangent, normal);","  return tbn;","}","float getDepthValue(vec4 v) {","  float depth = unpack4x8ToFloat(v);","  depth = depth*zrange+znear;","  //depth = depth*zrange;","  return -depth;","}","void main (void)","{",n,"  vec4 p = texture2D(Texture0, FragTexCoord0);","  if (dot(p,p) < 0.001) { ","     gl_FragColor = vec4(1.0,1.0,1.0,0.0);","     return;","  }","  znear = projection[3][2] / (projection[2][2]-1.0);","  zfar = projection[3][2] / (projection[2][2]+1.0);","  zrange = zfar-znear;","  depth = getDepthValue(texture2D(Texture1, FragTexCoord0));","  if ( -depth < znear) {","     gl_FragColor = vec4(1.0,1.0,1.0,0.0);","     return;","  }","  normal = decodeNormal(unpack4x8To2Float(p));","  position = -FragTexCoord1*depth;","  position.z = -position.z;",""," mat3 tbn = computeBasis();"," float occlusion = 0.0;"," for (int i = 0; i < NB_SAMPLES; i++) {","    vec3 vecKernel = vec3(kernel[i]);","    vecKernel[2] = max(AngleLimit,vecKernel[2]);","    vec3 sample = tbn * vec3(vecKernel);","    vec3 dir = sample;","    float w = dot(dir, normal);","    float dist = 1.0-kernel[i].w;","    w *= dist*dist*Power;","    sample = dir * float(Radius) + position.xyz;","    vec4 offset = projection * vec4(sample,1.0);","    offset.xy /= offset.w;","    offset.xy = offset.xy * 0.5 + 0.5;","    float sample_depth = getDepthValue(texture2D(Texture1, offset.xy));","    float range_check = abs(sample.z - sample_depth) < float(Radius) ? 1.0 : 0.0;","    occlusion += (sample_depth > sample.z ? 1.0 : 0.0) * range_check*w;"," }"," occlusion = 1.0 - (occlusion / float(NB_SAMPLES));"," gl_FragColor = vec4(vec3(occlusion),1.0);","}",""].join("\n"),u=new osg.Program(new osg.Shader("VERTEX_SHADER",o),new osg.Shader("FRAGMENT_SHADER",s));
t.setAttributeAndModes(u),this._dirty=!1}})}();var osg=osg||{};osg.ObjectMemoryPool=function(t){return{_memPool:[],reset:function(){return this._memPool=[],this},put:function(t){this._memPool.push(t)},get:function(){return this._memPool.length>0?this._memPool.pop():(this.grow(),this.get())},grow:function(e){void 0===e&&(e=this._memPool.length>0?2*this._memPool.length:20);for(var r=this._memPool.length;e>r++;)this._memPool.push(new t);return this}}},osg.ArrayMemoryPool=function(){return{_mempoolofPools:[],reset:function(){return this._memPoolofPools={},this},put:function(t){this._memPoolofPools[t.length]||(this._memPoolofPools[t.length]=[]),this._memPoolofPools[t.length].push(t)},get:function(t){if(this._memPoolofPools[t]){if(this._memPoolofPools.length>0)return this._memPool.pop()}else this._memPoolofPools[t]=[];return this.grow(t),this.get()},grow:function(t,e){void 0===e&&(e=this._memPool.length>0?2*this._memPool.length:20);for(var r=this._memPool.length;e>r++;)this._memPool.push(Array(t));return this}}},osg.ShaderLoader=function(t){this.init(t)},osg.ShaderLoader.prototype=osg.objectLibraryClass({_shadersText:{},_shadersObject:{},_shadersList:{},_shaderLoaded:{},_loaded:!1,_callbackSingle:!1,_callbackAll:!1,_async:!0,_numtoLoad:0,_globalDefaultDefines:"",_globalDefaultprecision:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp float;\n #else\n precision mediump float;\n#endif",_debugLines:!1,_includeR:/#pragma include "([^"]+)"/g,_uniformR:/uniform\s+([a-z]+\s+)?([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[\s*(.+)\s*\])?/,_structR:/struct\s+\w+\s*{[^}]+}\s*;/g,_structExtractR:/struct\s+(\w+)\s*{([^}]+)}\s*;/,_structFieldsR:/[^;]+;/g,_structFieldR:/\s*([a-z]+\s+)?([A-Za-z0-9]+)\s+([a-zA-Z_0-9]+)\s*(\[\s*(.+)\s*\])?\s*;/,_defineR:/#define\s+([a-zA-Z_0-9]+)\s+(.*)/,_precisionR:/precision\s+(high|low|medium)p\s+float/,init:function(t){this._callbackAll=t.callbackAll,this._callbackSingle=t.callbackSingle,this._async=t.async,this._numtoLoad=0,t.loadprefix||(t.loadprefix="");var e;for(e in t.shaders)this._numtoLoad++;if(t.inline){for(e in t.shaders)this._shadersList[e]=e,this._shadersText[e]=t.shaders[e],this._callbackSingle&&this._callbackSingle(e),this._numtoLoad--;this._loaded=!0,this._callbackAll&&this._callbackAll()}else{for(e in t.shaders)this._shadersList[e]=t.loadprefix+e;this._loaded=!1}return this},loadCallBack:function(t){200===t.target.status&&(this._shadersText[t.target.shaderName]=t.target.responseText,this._callbackSingle&&this._callbackSingle(),this._numtoLoad--,0===this._numtoLoad&&this._callbackAll&&this._callbackAll())},load:function(t,e,r){return this._shadersList[e]||(this._shadersList[e]=t),req=new XMLHttpRequest,req.shaderName=e,req.open("GET",t,this._async),req.addEventListener("load",this.loadCallBack.bind(this),!1),r&&(this._callbackSingle=r),req.send(null),this},loadAll:function(t){if(this._numtoLoad>0){t&&t.callbackAll&&(this._callbackAll=t.callbackAll);for(var e in this._shadersList)this.load(this._shadersList[e],e,t&&t.callbackSingle)}return this},reloadAll:function(t){this._shaderLoaded={},this._loaded=!1,this._numtoLoad=0;for(var e in this._shadersList)this._numtoLoad++;return this.loadAll(t),this},reload:function(t){return this._shaderLoaded[t.shaderName]=void 0,this._loaded=!1,this._numtoLoad=1,this.load(this._shaders[t.shaderName],t&&t.shaderName,t&&t.callbackSingle),this},instrumentShaderlines:function(t,e){return"\n#line 0 "+e+"\n"+t},getShaderTextPure:function(t){if(t in this._shadersText)preShader=this._shadersText[t];else{for(var e in this._shadersText)if(-1!==e.indexOf(t)){preShader=this._shadersText[e];break}if(!preShader)return""}return preShader},preprocess:function(t,e){return t.replace(this._includeR,function(t,r){var i=this.getShaderTextPure(r);return this._debugLines&&(i=this.instrumentShaderlines(i,e),e++),i=this.preprocess(i,e)}.bind(this))},getShaderText:function(t,e){var r=this.getShaderTextPure(t),i=0;this._debugLines&&(r=this.instrumentShaderlines(r,i),i++);var o=this.preprocess(r,i),n="";return this._globalDefaultprecision&&(this._precisionR.test(o)||(n+=this._globalDefaultprecision+"\n")),e||(e=[]),e.push(this._globalDefaultDefines),n+=e.join("\n")+"\n",o=n+o},getShaderObject:function(t,e,r){if(!(t in this._shadersObject)){e||(e=[]);var i=e.slice(0,e.length);r==osg.Shader.VERTEX_SHADER?e.splice(0,0,"#define FRAGMENT_SHADER\n"):e.splice(0,0,"#define VERTEX_SHADER\n");var o=new osg.Shader(r,this.getShaderText(t,e));o.defines=i,this._shadersObject[t]=o}return this._shadersObject[t]}},"osg","MatrixTransform");var osgDB=osgDB||{};osgDB.ObjectWrapper={},osgDB.ObjectWrapper.serializers={},osgDB.readImage=function(t,e){return osgDB.registry().readImageURL(t,e)},osgDB.readImageURL=osgDB.readImage,osgDB.readNodeURL=function(t,e){return osgDB.registry().readNodeURL(t,e)},osgDB.registry=function(){return void 0===osgDB.registry._input&&(osgDB.registry._input=new osgDB.Input),osgDB.registry._input},osgDB.parseSceneGraph=function(t,e){if(!(void 0!==t.Version&&t.Version>0))return osgDB.parseSceneGraph_deprecated(t);var r=function(t){for(var e=Object.keys(t),r=0,i=e.length;i>r;r++)if("Generator"!==e[r]&&"Version"!==e[r])return e[r];return void 0},i=r(t);if(i){var o={};o[i]=t[i];var n=new osgDB.Input(o);return n.setImageLoadingOptions(osgDB.registry().getImageLoadingOptions()),void 0!==e&&(n.setProgressXHRCallback(e.progressXHRCallback),n.setPrefixURL(e.prefixURL)),n.readObject()}osg.log("can't parse scenegraph "+t)},osgDB.parseSceneGraph_deprecated=function(t){var e,r=function(t,e){var r=e[t];return void 0===r&&(r=e[t.toLowerCase()]),r},i=function(t,e){var i=r("Name",e);i&&void 0!==t.setName&&t.setName(i)},o=function(t,e){i(t,e),t.setAmbient(r("Ambient",e)),t.setDiffuse(r("Diffuse",e)),t.setEmission(r("Emission",e)),t.setSpecular(r("Specular",e)),t.setShininess(r("Shininess",e))},n=function(t,e){i(t,e),t.setSourceRGB(e.SourceRGB),t.setSourceAlpha(e.SourceAlpha),t.setDestinationRGB(e.DestinationRGB),t.setDestinationAlpha(e.DestinationAlpha)},a=function(t,e){var i=e.MagFilter||e.mag_filter||void 0;i&&t.setMagFilter(i);var o=e.MinFilter||e.min_filter||void 0;o&&t.setMinFilter(o);var n=e.WrapT||e.wrap_t||void 0;n&&t.setWrapT(n);var a=e.WrapS||e.wrap_s||void 0;a&&t.setWrapS(a);var s=r("File",e);osgDB.Promise.when(osgDB.readImage(s)).then(function(e){t.setImage(e)})},s=function(t,e){i(t,e);var s=r("Textures",e)||r("TextureAttributeList",e)||void 0;if(s)for(var u=0,h=s.length;h>u;u++){var c=r("File",s[u]);if(c){var g=new osg.Texture;a(g,s[u]),t.setTextureAttributeAndMode(u,g),t.addUniform(osg.Uniform.createInt1(u,"Texture"+u))}else osg.log("no texture on unit "+u+" skip it")}var l=r("BlendFunc",e);if(l){var d=new osg.BlendFunc;n(d,l),t.setAttributeAndMode(d)}var f=r("Material",e);if(f){var p=new osg.Material;o(p,f),t.setAttributeAndMode(p)}},u=t.children,h=t.primitives||t.Primitives||void 0,c=t.attributes||t.Attributes||void 0;if(h||c){e=new osg.Geometry,i(e,t),osg.extend(e,t),t=e,t.primitives=h,t.attributes=c;for(var g=0,l=h.length;l>g;g++){var d=h[g].mode;if(h[g].indices){var f=h[g].indices;f=new osg.BufferArray(osg.BufferArray[f.type],f.elements,f.itemSize),d=d?osg.PrimitiveSet[d]:gl.TRIANGLES,h[g]=new osg.DrawElements(d,f)}else{d=gl[d];var p=h[g].first,m=h[g].count;h[g]=new osg.DrawArrays(d,p,m)}}for(var v in c)if(c.hasOwnProperty(v)){var _=c[v];c[v]=new osg.BufferArray(gl[_.type],_.elements,_.itemSize)}}var S=r("StateSet",t);if(S){var y=new osg.StateSet;s(y,S),t.stateset=y}var b=t.matrix||t.Matrix||void 0;b&&(e=new osg.MatrixTransform,i(e,t),osg.extend(e,t),e.setMatrix(osg.Matrix.copy(b)),t=e);var T=t.projection||t.Projection||void 0;if(T&&(e=new osg.Projection,i(e,t),osg.extend(e,t),e.setProjectionMatrix(osg.Matrix.copy(T)),t=e),void 0===t.objectType&&(e=new osg.Node,i(e,t),osg.extend(e,t),t=e),u){t.children=[];for(var M=0,x=u.length;x>M;M++)t.addChild(osgDB.parseSceneGraph_deprecated(u[M]))}return t},osgDB.Input=function(t,e){this._json=t;var r=e;void 0===r&&(r={}),this._identifierMap=r,this._objectRegistry={},this._progressXHRCallback=void 0,this._prefixURL="",this.setImageLoadingOptions({promise:!0,onload:void 0})},osgDB.Input.prototype={setImageLoadingOptions:function(t){this._defaultImageOptions=t},getImageLoadingOptions:function(){return this._defaultImageOptions},setProgressXHRCallback:function(t){this._progressXHRCallback=t},registerObject:function(t,e){this._objectRegistry[t]=e},getJSON:function(){return this._json},setJSON:function(t){return this._json=t,this},setPrefixURL:function(t){this._prefixURL=t},getPrefixURL:function(){return this._prefixURL},computeURL:function(t){return void 0===this._prefixURL?t:this._prefixURL+t},getObjectWrapper:function(t){if(void 0!==this._objectRegistry[t])return new this._objectRegistry[t];for(var e=window,r=t.split("."),i=0,o=r.length;o>i;i++){var n=e[r[i]];if(void 0===n)return void 0;e=n}return new e},readImageURL:function(t,e){"data:image"!==t.substr(0,10)&&(t=this.computeURL(t)),void 0===e&&(e=this._defaultImageOptions);var r=new Image;if(r.onerror=function(){osg.warn("warning use white texture as fallback instead of "+t),r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2P8DwQACgAD/il4QJ8AAAAASUVORK5CYII="},e.promise!==!0)return void 0!==e.onload&&(r.onload=e.onload),r.src=t,r;var i=osgDB.Promise.defer();return r.onload=function(){void 0!==e.onload&&e.onload.call(this),i.resolve(r)},r.src=t,i.promise},readNodeURL:function(t,e){t=this.computeURL(t);var r=osgDB.Promise,i=r.defer();e=e||{};var o={progressXHRCallback:e.progressXHRCallback,prefixURL:e.prefixURL,defaultImageOptions:e.defaultImageOptions};if(void 0===o.prefixURL){var n=this.getPrefixURL(),a=t.lastIndexOf("/");-1!==a&&(n=t.substring(0,a+1)),o.prefixURL=n}var s=new XMLHttpRequest;return s.open("GET",t,!0),s.onreadystatechange=function(){4==s.readyState&&(200==s.status?r.when(osgDB.parseSceneGraph(JSON.parse(s.responseText),o),function(e){i.resolve(e),osg.log("loaded "+t)}).fail(function(t){i.reject(t)}):i.reject(s.status))},s.send(null),i.promise},readBinaryArrayURL:function(t){if(t=this.computeURL(t),void 0!==this._identifierMap[t])return this._identifierMap[t];var e=osgDB.Promise.defer(),r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",this._progressXHRCallback&&r.addEventListener("progress",this._progressXHRCallback,!1),r.addEventListener("error",function(){e.reject()},!1);var i=this;return r.addEventListener("load",function(){var o=r.response;o?(i._identifierMap[t]=o,e.resolve(o)):e.reject()},!1),r.send(null),this._identifierMap[t]=e.promise,e.promise},readBufferArray:function(){var t,e=this.getJSON(),r=e.UniqueID;if(void 0!==r&&(t=this._identifierMap[r],void 0!==t))return t;var i=function(t){return void 0===t.Elements&&void 0===t.Array||void 0===t.ItemSize||!t.Type?!1:!0};if(i(e)){var n,a;if(void 0!==e.Elements)n=new osg.BufferArray(osg.BufferArray[e.Type],e.Elements,e.ItemSize);else if(void 0!==e.Array){var s=new osg.BufferArray(osg.BufferArray[e.Type]);s.setItemSize(e.ItemSize);var u,h;if(void 0!==e.Array.Float32Array?(u=e.Array.Float32Array,h="Float32Array"):void 0!==e.Array.Uint16Array?(u=e.Array.Uint16Array,h="Uint16Array"):(osg.warn("Typed Array "+Object.keys(o.Array)[0]),h="Float32Array"),void 0!==u)if(void 0!==u.File){var c=u.File;a=osgDB.Promise.defer(),osgDB.Promise.when(this.readBinaryArrayURL(c)).then(function(t){var e,r;(function(){var t=new Uint8Array([18,52]),e=new Uint16Array(t.buffer);r="1234"===e[0].toString(16)})();var i=0;void 0!==u.Offset&&(i=u.Offset);var o=osg[h].BYTES_PER_ELEMENT,n=u.Size,c=s.getItemSize(),l=n*o*c;if(r){osg.log("big endian detected");var d=osg[h],f=new d(n*c),p=new DataView(t,i,l),m=0,v=f.length;if("Uint16Array"===h)for(;v>m;m++)tempArray[m]=p.getUint16(m*o,!0);else if("Float32Array"===h)for(;v>m;m++)tempArray[m]=p.getFloat32(m*o,!0);e=tempArray,p=null}else e=new osg[h](t,i,c*n);g=b=null,s.setElements(e),a.resolve(s)})}else if(void 0!==u.Elements){var g=new osg[h](u.Elements);s.setElements(g)}n=s}return void 0!==r&&(this._identifierMap[r]=n),void 0!==a?a.promise:n}},readUserDataContainer:function(){var t,e=this.getJSON(),r=e.UniqueID;return void 0!==r&&(t=this._identifierMap[r],void 0!==t)?t.Values:(this._identifierMap[r]=e,e.Values)},readPrimitiveSet:function(){var t,e,r,i,o=this.getJSON(),n=o.DrawElementUShort||o.DrawElementUByte||o.DrawElementUInt||o.DrawElementsUShort||o.DrawElementsUByte||o.DrawElementsUInt||void 0;if(n){if(t=n.UniqueID,void 0!==t&&(e=this._identifierMap[t],void 0!==e))return e;i=osgDB.Promise.defer();var a=n.Indices,s=o;mode=n.Mode,mode=mode?osg.PrimitiveSet[mode]:osg.PrimitiveSet.TRIANGLES,r=new osg.DrawElements(mode),this.setJSON(a),osgDB.Promise.when(this.readBufferArray()).then(function(t){r.setIndices(t),i.resolve(r)}),this.setJSON(s)}var u=o.DrawArray||o.DrawArrays;if(u){if(t=u.UniqueID,void 0!==t&&(e=this._identifierMap[t],void 0!==e))return e;mode=u.Mode||u.mode,first=void 0!==u.First?u.First:u.first,count=void 0!==u.Count?u.Count:u.count;var h=new osg.DrawArrays(osg.PrimitiveSet[mode],first,count);r=h}var c=o.DrawArrayLengths||void 0;if(c){if(t=c.UniqueID,void 0!==t&&(e=this._identifierMap[t],void 0!==e))return e;mode=c.Mode,first=c.First;var g=c.ArrayLengths,l=new osg.DrawArrayLengths(osg.PrimitiveSet[mode],first,g);r=l}return void 0!==t&&(this._identifierMap[t]=r),i?i.promise:r},readObject:function(){var t=this.getJSON(),e=Object.keys(t)[0];if(!e)return osg.warn("can't find property for object "+t),void 0;var r,i=t[e].UniqueID;if(void 0!==i&&(r=this._identifierMap[i],void 0!==r))return r;var o=this.getObjectWrapper(e);if(!o)return osg.warn("can't instanciate object "+e),void 0;for(var n=osgDB.ObjectWrapper.serializers,a=e.split("."),s=0,u=a.length;u>s;s++){var h=n[a[s]];if(void 0===h)return osg.warn("can't find function to read object "+e+" - undefined"),void 0;n=h}var c=n(this.setJSON(t[e]),o);return void 0!==i&&(this._identifierMap[i]=o,o._uniqueID=i),c}},osgDB.Promise={},function(){var t=osgDB.Promise;(function(e){if("function"==typeof define)define(e);else if("object"==typeof t)e(void 0,t);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=function(){var t={};return e(void 0,t)}}else e(void 0,Q={})})(function(t,e){"use strict";function r(t){return"[object StopIteration]"===ne(t)||t instanceof Z}function i(t,e){var r=[];try{r.push(""+t)}catch(i){try{r.push("<error: "+i+">")}catch(n){r.push("<error>")}}for(var a=0;e.length>a;a++){var s,u=e[a];if("string"==typeof u)r.push(u);else{try{s=o(u)}catch(i){try{s="<error: "+i+">"}catch(n){s="<error>"}}r.push("    at "+s)}}return r.join("\n")}function o(t){var e="";if(t.isNative())e="native";else if(t.isEval())e="eval at "+t.getEvalOrigin();else{var r=t.getFileName();if(r){e+=r;var i=t.getLineNumber();if(null!==i){e+=":"+i;var o=t.getColumnNumber();o&&(e+=":"+o)}}}e||(e="unknown source");var n="",a=t.getFunction().name,s=!0,u=t.isConstructor(),h=!(t.isToplevel()||u);if(h){var c=t.getMethodName();n+=t.getTypeName()+".",a?(n+=a,c&&c!==a&&(n+=" [as "+c+"]")):n+=c||"<anonymous>"}else u?n+="new "+(a||"<anonymous>"):a?n+=a:(n+=e,s=!1);return s&&(n+=" ("+e+")"),n}function n(t){var e=Error.prepareStackTrace;Error.prepareStackTrace=function(t,e){return e.filter(function(t){var e=t.getFileName();return"module.js"!==e&&"node.js"!==e&&e!==ae})};var r=t.stack;return Error.prepareStackTrace=e,r}function a(t){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn,t.apply(t,arguments)}}function s(){function t(t){return r?(e=m(t),te(r,function(t,r){W(function(){e.promiseSend.apply(e,r)})},void 0),r=void 0,e):void 0}var e,r=[],i=ie(s.prototype),o=ie(h.prototype);return o.promiseSend=function(){var t=$(arguments);r?r.push(t):W(function(){e.promiseSend.apply(e,t)})},o.valueOf=function(){return r?o:e.valueOf()},Error.captureStackTrace&&Error.captureStackTrace(o,s),H(o),i.promise=o,i.resolve=t,i.reject=function(e){return t(p(e))},i}function u(t){var e=s();return E(t,void 0,e.resolve,e.reject).fail(e.reject),e.promise}function h(t,e,r,i){void 0===e&&(e=function(t){return p(Error("Promise does not support operation: "+t))});var o=ie(h.prototype);return o.promiseSend=function(r,i){var n,a=$(arguments,2);try{n=t[r]?t[r].apply(o,a):e.apply(o,[r].concat(a))}catch(s){n=p(s)}i(n)},r&&(o.valueOf=r),i&&(o.exception=i),H(o),o}function c(t){return Object(t)!==t?t:t.valueOf()}function g(t){return t&&"function"==typeof t.promiseSend}function l(t){return d(t)||f(t)}function d(t){return!g(c(t))}function f(t){return t=c(t),g(t)&&"exception"in t}function p(t){t=t||Error();var e=h({when:function(e){if(e){var r=ee(se,this);-1!==r&&(ue.splice(r,1),se.splice(r,1))}return e?e(t):p(t)}},function(){return p(t)},function(){return this},t);return se.push(e),ue.push(t),e}function m(t){if(g(t))return t;if(t&&"function"==typeof t.then){var e=s();return t.then(e.resolve,e.reject),e.promise}return h({when:function(){return t},get:function(e){return t[e]},put:function(e,r){return t[e]=r},del:function(e){return delete t[e]},post:function(e,r){return t[e].apply(t,r)},apply:function(e,r){return t.apply(e,r)},fapply:function(e){return t.apply(void 0,e)},viewInfo:function(){function e(t){i[t]||(i[t]=typeof r[t])}for(var r=t,i={};r;)Object.getOwnPropertyNames(r).forEach(e),r=Object.getPrototypeOf(r);return{type:typeof t,properties:i}},keys:function(){return oe(t)}},void 0,function(){return t})}function v(t){return h({isDef:function(){}},function(){var e=$(arguments);return C.apply(void 0,[t].concat(e))},function(){return c(t)})}function _(t,e){return t=m(t),e?h({viewInfo:function(){return e}},function(){var e=$(arguments);return C.apply(void 0,[t].concat(e))},function(){return c(t)}):C(t,"viewInfo")}function S(t){return _(t).when(function(e){var r;r="function"===e.type?function(){return ce(t,void 0,arguments)}:{};var i=e.properties||{};return oe(i).forEach(function(e){"function"===i[e]&&(r[e]=function(){return he(t,e,arguments)})}),m(r)})}function y(t,e,r){function i(t){if(osg.DebugPromise)return e?e(t):t;try{return e?e(t):t}catch(r){return p(r)}}function o(t){if(osg.DebugPromise)return r?r(t):p(t);try{return r?r(t):p(t)}catch(e){return p(e)}}var n=s(),a=!1;return W(function(){m(t).promiseSend("when",function(t){a||(a=!0,m(t).promiseSend("when",function(t){n.resolve(i(t))},function(t){n.resolve(o(t))}))},function(t){a||(a=!0,n.resolve(o(t)))})}),n.promise}function b(t,e,r){return y(t,function(t){return e.apply(void 0,t)},r)}function T(t){return function(){function e(t,e){var a;try{a=i[t](e)}catch(s){return r(s)?s.value:p(s)}return y(a,o,n)}var i=t.apply(this,arguments),o=e.bind(e,"send"),n=e.bind(e,"throw");return o()}}function M(t){throw new Z(t)}function x(t){return function(e){var r=$(arguments,1);return C.apply(void 0,[e,t].concat(r))}}function C(t,e){var r=s(),i=$(arguments,2);return t=m(t),W(function(){t.promiseSend.apply(t,[e,r.resolve].concat(i))}),r.promise}function A(t,e,r){var i=s();return t=m(t),W(function(){t.promiseSend.apply(t,[e,i.resolve].concat(r))}),i.promise}function w(t){return function(e){var r=$(arguments,1);return A(e,t,r)}}function E(t,e){var r=$(arguments,2);return ce(t,e,r)}function F(t){var e=$(arguments,1);return ge(t,e)}function V(t,e){var r=$(arguments,2);return function(){var i=r.concat($(arguments));return ce(t,e,i)}}function R(t){var e=$(arguments,1);return function(){var r=e.concat($(arguments));return ge(t,r)}}function U(t){return y(t,function(t){var e=t.length;if(0===e)return m(t);var r=s();return te(t,function(i,o,n){y(o,function(i){t[n]=i,0===--e&&r.resolve(t)}).fail(r.reject)},void 0),r.promise})}function P(t){return y(t,function(t){return y(U(re(t,function(t){return y(t,z,z)})),function(){return re(t,m)})})}function N(t,e){return y(t,void 0,e)}function D(t,e){return y(t,function(t){return y(e(),function(){return t})},function(t){return y(e(),function(){return p(t)})})}function L(t){y(t,void 0,function(e){W(function(){if(Error.captureStackTrace&&"stack"in e){var r=n(e),o=n(t),a=r.concat("From previous event:",o);e.stack=i(e,a)}throw e})})}function B(t,e){var r=s(),i=setTimeout(function(){r.reject(Error("Timed out after "+e+" ms"))},e);return y(t,function(t){clearTimeout(i),r.resolve(t)},r.reject),r.promise}function O(t,e){void 0===e&&(e=t,t=void 0);var r=s();return setTimeout(function(){r.resolve(t)},e),r.promise}function k(t,e,r){return j(t,e).apply(void 0,r)}function I(t,e){var r=$(arguments,2);return k(t,e,r)}function j(t){if(arguments.length>1){var e=arguments[1],r=$(arguments,2),i=t;t=function(){var t=r.concat($(arguments));return i.apply(e,t)}}return function(){var e=s(),r=$(arguments);return r.push(e.makeNodeResolver()),ge(t,r).fail(e.reject),e.promise}}function q(t,e,r){return k(t[e],t,r)}function G(t,e){var r=$(arguments,2);return k(t[e],t,r)}var z=function(){},H=Object.freeze||z;"undefined"!=typeof cajaVM&&(H=cajaVM.def);var W;if("undefined"!=typeof process)W=process.nextTick;else if("function"==typeof msSetImmediate)W=msSetImmediate.bind(window);else if("function"==typeof setImmediate)W=setImmediate;else if("undefined"!=typeof MessageChannel){var K=new MessageChannel,X={},Q=X;K.port1.onmessage=function(){X=X.next;var t=X.task;delete X.task,t()},W=function(t){Q=Q.next={task:t},K.port2.postMessage(0)}}else W=function(t){setTimeout(t,0)};var Y;if(Function.prototype.bind){var J=Function.prototype.bind;Y=J.bind(J.call)}else Y=function(t){return function(){return t.call.apply(t,arguments)}};var Z,$=Y(Array.prototype.slice),te=Y(Array.prototype.reduce||function(t,e){var r=0,i=this.length;if(1===arguments.length)for(;;){if(r in this){e=this[r++];break}if(++r>=i)throw new TypeError}for(;i>r;r++)r in this&&(e=t(e,this[r],r));return e}),ee=Y(Array.prototype.indexOf||function(t){for(var e=0;this.length>e;e++)if(this[e]===t)return e;return-1}),re=Y(Array.prototype.map||function(t,e){var r=this,i=[];return te(r,function(o,n,a){i.push(t.call(e,n,a,r))},void 0),i}),ie=Object.create||function(t){function e(){}return e.prototype=t,new e},oe=Object.keys||function(t){var e=[];for(var r in t)e.push(r);return e},ne=Object.prototype.toString;Z="undefined"!=typeof ReturnValue?ReturnValue:function(t){this.value=t};var ae;Error.captureStackTrace&&(ae=function(){var t,e=Error.prepareStackTrace;return Error.prepareStackTrace=function(e,r){t=r[0].getFileName()},Error().stack,Error.prepareStackTrace=e,t}()),e.nextTick=W,e.defer=s,s.prototype.makeNodeResolver=function(){var t=this;return function(e,r){e?t.reject(e):arguments.length>2?t.resolve($(arguments,1)):t.resolve(r)}},s.prototype.node=a(s.prototype.makeNodeResolver,"node","makeNodeResolver"),e.promise=u,e.makePromise=h,h.prototype.then=function(t,e){return y(this,t,e)},te(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","end"],function(t,r){h.prototype[r]=function(){return e[r].apply(e,[this].concat($(arguments)))}},void 0),h.prototype.toSource=function(){return""+this},h.prototype.toString=function(){return"[object Promise]"},H(h.prototype),e.nearer=c,e.isPromise=g,e.isResolved=l,e.isFulfilled=d,e.isRejected=f;var se=[],ue=[];"undefined"!=typeof window&&window.console,e.reject=p,e.begin=m,e.resolve=m,e.ref=a(m,"ref","resolve"),e.master=v,e.viewInfo=_,e.view=S,e.when=y,e.spread=b,e.async=T,e["return"]=M,e.sender=a(x,"sender","dispatcher"),e.Method=a(x,"Method","dispatcher"),e.send=a(C,"send","dispatch"),e.dispatch=A,e.dispatcher=w,e.get=w("get"),e.put=w("put"),e["delete"]=e.del=w("del");var he=e.post=w("post");e.invoke=function(t,e){var r=$(arguments,2);return he(t,e,r)};var ce=e.apply=a(w("apply"),"apply","fapply"),ge=e.fapply=w("fapply");e.call=a(E,"call","fcall"),e["try"]=F,e.fcall=F,e.bind=a(V,"bind","fbind"),e.fbind=R,e.keys=w("keys"),e.all=U,e.allResolved=P,e["catch"]=e.fail=N,e["finally"]=e.fin=D,e.end=L,e.timeout=B,e.delay=O,e.napply=k,e.ncall=I,e.nbind=j,e.npost=q,e.ninvoke=G,H(e)})}();var osgViewer=osgViewer||{};WebGLUtils=function(){var t=function(t){return'<div style="margin: auto; width:500px;z-index:10000;margin-top:20em;text-align:center;">'+t+"</div>"},e='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',r='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org">Click here for more information.</a>',i=function(i,n,a){function s(i){var o=document.getElementsByTagName("body")[0];if(o){var n=window.WebGLRenderingContext?r:e;i&&(n+="<br/><br/>Status: "+i),o.innerHTML=t(n)}}a=a||s,i.addEventListener&&i.addEventListener("webglcontextcreationerror",function(t){a(t.statusMessage)},!1);var u=o(i,n);return u||(window.WebGLRenderingContext?a(""):a("")),u},o=function(t,e){for(var r=["webgl","experimental-webgl","webkit-3d","moz-webgl"],i=null,o=0;r.length>o;++o){try{i=t.getContext(r[o],e)}catch(n){}if(i)break}var a=i;if(a){var s=["WEBKIT_","MOZ_"];osg.profile={},osg.profile.extensions={},osg.profile.textureFormat={};var u,h,c,g,l,d=a.getSupportedExtensions(),f="";for(c in d){for(l=d[c],osg.profile.extensions[l]=a.getExtension(l),g=l,h=0;s.length>h;h++)-1!==l.indexOf(s[h])&&(g=l.substr(s[h].length,l.length),osg.profile.extensions[g]=osg.profile.extensions[l],f+="("+s[h]+")");if(f+=g+" ",f+=" http://www.khronos.org/registry/webgl/extensions/"+g+" ",-1!==l.toLowerCase().indexOf("s3tc")){osg.profile.textureFormat=a.getParameter(a.COMPRESSED_TEXTURE_FORMATS),f+="\n	",f+="Texture Support: ( ";for(u in osg.profile.textureFormat)osg.profile.textureFormat[u]==osg.profile.extensions[l].COMPRESSED_RGBA_S3TC_DXT5_EXT&&(osg.profile.dxt5Supported=!0,f+="dxt5 "),osg.profile.textureFormat[u]==osg.profile.extensions[l].COMPRESSED_RGBA_S3TC_DXT3_EXT&&(osg.profile.dxt3Supported=!0,f+="dxt3 "),osg.profile.textureFormat[u]==osg.profile.extensions[l].COMPRESSED_RGBA_S3TC_DXT1_EXT&&(osg.profile.dxt1Supported=!0,f+="dxt1 ");f+=" )"}f+="\n"}return osg.log("webgl profile: "+f),i}};return{create3DContext:o,setupWebGL:i}}(),window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}()),window.cancelRequestAnimFrame||(window.cancelRequestAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}()),Date.now||(Date.now=function(){return(new Date).getTime()}),window.performance=window.performance||{},performance.now=function(){return window.performance.now||window.performance.mozNow||window.performance.msNow||window.performance.oNow||window.performance.webkitNow||function(){return Date.now()}}(),WebGLDebugUtils=function(){function t(t){if(null===g){g={};for(var e in t)"number"==typeof t[e]&&(g[t[e]]=e)}}function e(){if(null===g)throw"WebGLDebugUtils.init(ctx) not called"}function r(t){return e(),void 0!==g[t]}function i(t){e();var r=g[t];return void 0!==r?r:"*UNKNOWN WebGL ENUM (0x"+t.toString(16)+")"}function o(t,e,r){var o=c[t];return void 0!==o&&o[e]?i(r):""+r}function n(t,e,r){t.__defineGetter__(r,function(){return e[r]}),t.__defineSetter__(r,function(t){e[r]=t})}function a(e,r){function a(t,e){return function(){var i=t[e].apply(t,arguments),o=t.getError();return 0!==o&&(s[o]=!0,r(o,e,arguments)),i}}t(e),r=r||function(t,e,r){for(var n="",a=0;r.length>a;++a)n+=(0===a?"":", ")+o(e,a,r[a]);h("WebGL error "+i(t)+" in "+e+"("+n+")")};var s={},u={};for(var c in e)"function"==typeof e[c]?u[c]=a(e,c):n(u,e,c);return u.getError=function(){for(var t in s)if(s[t])return s[t]=!1,t;return e.NO_ERROR},u}function s(t){var e=t.getParameter(t.MAX_VERTEX_ATTRIBS),r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r);var i;for(i=0;e>i;++i)t.disableVertexAttribArray(i),t.vertexAttribPointer(i,4,t.FLOAT,!1,0,0),t.vertexAttrib1f(i,0);t.deleteBuffer(r);var o=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);for(i=0;o>i;++i)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_CUBE_MAP,null),t.bindTexture(t.TEXTURE_2D,null);for(t.activeTexture(t.TEXTURE0),t.useProgram(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.DITHER),t.disable(t.SCISSOR_TEST),t.blendColor(0,0,0,0),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.clearColor(0,0,0,0),t.clearDepth(1),t.clearStencil(-1),t.colorMask(!0,!0,!0,!0),t.cullFace(t.BACK),t.depthFunc(t.LESS),t.depthMask(!0),t.depthRange(0,1),t.frontFace(t.CCW),t.hint(t.GENERATE_MIPMAP_HINT,t.DONT_CARE),t.lineWidth(1),t.pixelStorei(t.PACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_ALIGNMENT,4),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.UNPACK_COLORSPACE_CONVERSION_WEBGL&&t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.BROWSER_DEFAULT_WEBGL),t.polygonOffset(0,0),t.sampleCoverage(1,!1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilMask(4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT);t.getError(););}function u(t){function e(t){return"function"==typeof t?t:function(e){t.handleEvent(e)}}function r(t){var e=t.addEventListener;t.addEventListener=function(r,i){switch(r){case"webglcontextlost":M(i);break;case"webglcontextrestored":x(i);break;default:e.apply(t,arguments)}}}function i(){for(var t=Object.keys(T),e=0;t.length>e;++e)delete T[t]}function o(){++S,m||_==S&&t.loseContext()}function a(t,e){var r=t[e];return function(){if(o(),!m){var e=r.apply(t,arguments);return e}}}function u(){for(var t=0;v.length>t;++t){var e=v[t];e instanceof WebGLBuffer?g.deleteBuffer(e):e instanceof WebGLFramebuffer?g.deleteFramebuffer(e):e instanceof WebGLProgram?g.deleteProgram(e):e instanceof WebGLRenderbuffer?g.deleteRenderbuffer(e):e instanceof WebGLShader?g.deleteShader(e):e instanceof WebGLTexture&&g.deleteTexture(e)}}function h(t){return{statusMessage:t,preventDefault:function(){y=!0}}}function c(t){for(var e in t)"function"==typeof t[e]?f[e]=a(t,e):n(f,t,e);f.getError=function(){o();var t;if(!m)for(;t=g.getError();)T[t]=!0;for(t in T)if(T[t])return delete T[t],t;return f.NO_ERROR};var r,i,s=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"];for(i=0;s.length>i;++i)r=s[i],f[r]=function(e){return function(){if(o(),m)return null;var r=e.apply(t,arguments);return r.__webglDebugContextLostId__=p,v.push(r),r}}(t[r]);var u=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(i=0;u.length>i;++i)r=u[i],f[r]=function(e){return function(){return o(),m?null:e.apply(t,arguments)}}(f[r]);var h=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(i=0;h.length>i;++i)r=h[i],f[r]=function(e){return function(){return o(),m?!1:e.apply(t,arguments)}}(f[r]);return f.checkFramebufferStatus=function(e){return function(){return o(),m?f.FRAMEBUFFER_UNSUPPORTED:e.apply(t,arguments)}}(f.checkFramebufferStatus),f.getAttribLocation=function(e){return function(){return o(),m?-1:e.apply(t,arguments)}}(f.getAttribLocation),f.getVertexAttribOffset=function(e){return function(){return o(),m?0:e.apply(t,arguments)}}(f.getVertexAttribOffset),f.isContextLost=function(){return m},f}var g,l=[],d=[],f={},p=1,m=!1,v=[],_=0,S=0,y=!1,b=0,T={};t.getContext=function(e){return function(){var r=e.apply(t,arguments);if(r instanceof WebGLRenderingContext){if(r!=g){if(g)throw"got different context";
g=r,f=c(g)}return f}return r}}(t.getContext);var M=function(t){l.push(e(t))},x=function(t){d.push(e(t))};return r(t),t.loseContext=function(){if(!m){for(m=!0,_=0,++p;g.getError(););i(),T[g.CONTEXT_LOST_WEBGL]=!0;var e=h("context lost"),r=l.slice();setTimeout(function(){for(var i=0;r.length>i;++i)r[i](e);b>=0&&setTimeout(function(){t.restoreContext()},b)},0)}},t.restoreContext=function(){m&&d.length&&setTimeout(function(){if(!y)throw"can not restore. webglcontestlost listener did not call event.preventDefault";u(),s(g),m=!1,S=0,y=!1;for(var t=d.slice(),e=h("context restored"),r=0;t.length>r;++r)t[r](e)},0)},t.loseContextInNCalls=function(t){if(m)throw"You can not ask a lost contet to be lost";_=S+t},t.getNumCalls=function(){return S},t.setRestoreTimeout=function(t){b=t},t}var h=function(t){window.console&&window.console.log&&window.console.log(t)},c={enable:{0:!0},disable:{0:!0},getParameter:{0:!0},drawArrays:{0:!0},drawElements:{0:!0,2:!0},createShader:{0:!0},getShaderParameter:{1:!0},getProgramParameter:{1:!0},getVertexAttrib:{1:!0},vertexAttribPointer:{2:!0},bindTexture:{0:!0},activeTexture:{0:!0},getTexParameter:{0:!0,1:!0},texParameterf:{0:!0,1:!0},texParameteri:{0:!0,1:!0,2:!0},texImage2D:{0:!0,2:!0,6:!0,7:!0},texSubImage2D:{0:!0,6:!0,7:!0},copyTexImage2D:{0:!0,2:!0},copyTexSubImage2D:{0:!0},generateMipmap:{0:!0},bindBuffer:{0:!0},bufferData:{0:!0,2:!0},bufferSubData:{0:!0},getBufferParameter:{0:!0,1:!0},pixelStorei:{0:!0,1:!0},readPixels:{4:!0,5:!0},bindRenderbuffer:{0:!0},bindFramebuffer:{0:!0},checkFramebufferStatus:{0:!0},framebufferRenderbuffer:{0:!0,1:!0,2:!0},framebufferTexture2D:{0:!0,1:!0,2:!0},getFramebufferAttachmentParameter:{0:!0,1:!0,2:!0},getRenderbufferParameter:{0:!0,1:!0},renderbufferStorage:{0:!0,1:!0},clear:{0:!0},depthFunc:{0:!0},blendFunc:{0:!0,1:!0},blendFuncSeparate:{0:!0,1:!0,2:!0,3:!0},blendEquation:{0:!0},blendEquationSeparate:{0:!0,1:!0},stencilFunc:{0:!0},stencilFuncSeparate:{0:!0,1:!0},stencilMaskSeparate:{0:!0},stencilOp:{0:!0,1:!0,2:!0},stencilOpSeparate:{0:!0,1:!0,2:!0,3:!0},cullFace:{0:!0},frontFace:{0:!0}},g=null;return{init:t,mightBeEnum:r,glEnumToString:i,glFunctionArgToString:o,makeDebugContext:a,makeLostContextSimulatingCanvas:u,resetToInitialState:s}}();var Stats={};Stats.Stats=function(t,e){this.layers=[],this.last_update=void 0,this.canvas=t,this.text_canvas=e,this.numberUpdateGraph=0,this.numberUpdateText=0,this.deltaSum=0,this.deltas=[]},Stats.Stats.prototype={addLayer:function(t,e,r,i){void 0===t&&(t="rgb(255,255,255)"),this.layers.push({previous:0,color:t,getValue:r,getText:i,average:0,max:e,data:[]})},update:function(){var t,e,r,i,o,n,a,s,u,h,c=performance.now();if(void 0===this.last_update&&(this.last_update=c),e=.12,t=(c-this.last_update)*e,t>=1){for(this.numberUpdateGraph++,this.numberUpdateText++,c-=(t-Math.floor(t))/e,t=Math.floor(t),this.deltaSum+=t,this.deltas.push(t),e=0,i=this.layers.length;i>e;e++)o=this.layers[e],o.data.push(o.getValue(c));if(this.numberUpdateGraph>0&&(this.deltaSum>this.canvas.width||0===this.numberUpdateGraph%30)){if(this.numberUpdateText>0&&0===this.numberUpdateText%60){for(a=this.text_canvas,s=a.getContext("2d"),s.font="14px Sans",u=17,t=u,s.clearRect(0,0,a.width,a.height),e=0,i=this.layers.length;i>e;e++)o=this.layers[e],n=o.getText(o.average/this.numberUpdateText),o.average=0,s.fillStyle=o.color,s.fillText(n,0,t),t+=u;this.numberUpdateText=0}a=this.canvas,s=a.getContext("2d");var g=a.width-this.deltaSum;for(g>0?(h=s.getImageData(this.deltaSum,0,g,a.height),s.putImageData(h,0,0),s.clearRect(g,0,this.deltaSum,a.height)):(g=0,s.clearRect(0,0,a.width,a.height)),s.lineWidth=1,e=0,i=this.layers.length;i>e;e++){o=this.layers[e],o.average=o.data[0];var l=g;for(s.strokeStyle=o.color,s.beginPath(),s.moveTo(l,a.height-o.previous),r=1;o.data.length>r;r++)n=o.data[r],o.average+=n,n*=a.height/o.max,n>a.height&&(n=a.height),l+=this.deltas[r],s.lineTo(l,a.height-n);s.stroke(),o.previous=n}for(this.deltaSum=0,this.deltas=[0],a=this.text_canvas,s=a.getContext("2d"),s.font="14px Sans",u=17,t=u,s.clearRect(0,0,a.width,a.height),e=0,i=this.layers.length;i>e;e++)o=this.layers[e],n=o.getText(o.average/o.data.length),o.average=0,s.fillStyle=o.color,s.fillText(n,0,t),t+=u,o.data=[o.data[o.data.length-1]];this.numberUpdateGraph=0}this.last_update=c}}},osgViewer.View=function(){this._graphicContext=void 0,this._camera=new osg.Camera,this._scene=new osg.Node,this._sceneData=void 0,this._frameStamp=new osg.FrameStamp,this._lightingMode=void 0,this._manipulator=void 0,this.setLightingMode(osgViewer.View.LightingMode.HEADLIGHT),this._scene.getOrCreateStateSet().setAttributeAndMode(new osg.Material),this._scene.getOrCreateStateSet().setAttributeAndMode(new osg.Depth),this._scene.getOrCreateStateSet().setAttributeAndMode(new osg.BlendFunc),this._scene.getOrCreateStateSet().setAttributeAndMode(new osg.CullFace)},osgViewer.View.LightingMode={NO_LIGHT:0,HEADLIGHT:1,SKY_LIGHT:2},osgViewer.View.prototype={setGraphicContext:function(t){this._graphicContext=t},getGraphicContext:function(){return this._graphicContext},setUpView:function(t){var e=t.width/t.height;this._camera.setViewport(new osg.Viewport(0,0,t.width,t.height)),osg.Matrix.makeLookAt([0,0,-10],[0,0,0],[0,1,0],this._camera.getViewMatrix()),osg.Matrix.makePerspective(60,e,1,1e3,this._camera.getProjectionMatrix())},computeIntersections:function(t,e,r){void 0===r&&(r=-1);var i=new osgUtil.IntersectVisitor;return i.setTraversalMask(r),i.addLineSegment([t,e,0],[t,e,1]),i.pushCamera(this._camera),this._sceneData.accept(i),i.hits},setFrameStamp:function(t){this._frameStamp=t},getFrameStamp:function(){return this._frameStamp},setCamera:function(t){this._camera=t},getCamera:function(){return this._camera},setSceneData:function(t){this._scene.removeChildren(),this._scene.addChild(t),this._sceneData=t},getSceneData:function(){return this._sceneData},getScene:function(){return this._scene},getManipulator:function(){return this._manipulator},setManipulator:function(t){this._manipulator=t},getLight:function(){return this._light},setLight:function(t){this._light=t,this._lightingMode!==osgViewer.View.LightingMode.NO_LIGHT&&this._scene.getOrCreateStateSet().setAttributeAndMode(this._light)},getLightingMode:function(){return this._lightingMode},setLightingMode:function(t){this._lightingMode!==t&&(this._lightingMode=t,this._lightingMode!==osgViewer.View.LightingMode.NO_LIGHT?this._light||(this._light=new osg.Light,this._light.setAmbient([.2,.2,.2,1]),this._light.setDiffuse([.8,.8,.8,1]),this._light.setSpecular([.5,.5,.5,1])):this._light=void 0)}};var optionsURL=function(){for(var t,e=[],r=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),i=0;r.length>i;i++){t=r[i].split("=");var o=t[0].toLowerCase();e.push(o);var n=t[1];void 0===n&&(n="1"),e[o]=n.toLowerCase()}return e};(function(){var t=optionsURL();if("html"===t.log){var e=[],r=document.createElement("div"),i=document.createElement("pre");document.addEventListener("DOMContentLoaded",function(){document.body.appendChild(r),r.appendChild(i)});var o=function(t){e.unshift(t),i.innerHTML=e.join("\n")};r.style.overflow="hidden",r.style.position="absolute",r.style.zIndex="10000",r.style.height="100%",r.style.maxWidth="600px",i.style.overflow="scroll",i.style.width="105%",i.style.height="100%",i.style.fontSize="10px",["log","error","warn","info","debug"].forEach(function(t){window.console[t]=o})}})(),osgViewer.Viewer=function(t,e,r){osgViewer.View.call(this),void 0===e&&(e={antialias:!0}),osg.extend(e,optionsURL()),e.debugpromise&&(osg.DebugPromise=!0),(osg.SimulateWebGLLostContext||e.simulatewebgllostcontext)&&(t=WebGLDebugUtils.makeLostContextSimulatingCanvas(t),t.loseContextInNCalls(osg.SimulateWebGLLostContext)),gl=WebGLUtils.setupWebGL(t,e,r);var i=this;if(t.addEventListener("webglcontextlost",function(t){i.contextLost(),t.preventDefault()},!1),t.addEventListener("webglcontextrestored",function(){i.contextRestored()},!1),(osg.cacheState||e.cachestate&&WebGL_StateCache)&&(gl=new WebGL_StateCache(gl)),(osg.reportWebGLError||e.reportwebglerror)&&(gl=WebGLDebugUtils.makeDebugContext(gl)),!gl)throw"No WebGL implementation found";this.setGraphicContext(gl),osg.init(),this._canvas=t,this._frameRate=60,osgUtil.UpdateVisitor=osg.UpdateVisitor,osgUtil.CullVisitor=osg.CullVisitor,this._urlOptions=!0,this._mouseWheelEventNode=t,this._mouseEventNode=t,this._keyboardEventNode=document,this._gamepadEventNode=window,e&&(e.mouseWheelEventNode&&(this._mouseWheelEventNode=e.mouseWheelEventNode),e.mouseEventNode&&(this._mouseEventNode=e.mouseEventNode),e.keyboardEventNode&&(this._keyboardEventNode=e.keyboardEventNode),e.gamepadEventNode&&(this._gamepadEventNode=e.gamepadEventNode)),this.setUpView(t)},osgViewer.Viewer.prototype=osg.objectInehrit(osgViewer.View.prototype,{contextLost:function(){osg.log("webgl context lost"),window.cancelRequestAnimFrame(this._requestID)},contextRestored:function(){osg.log("webgl context restored, but not supported - reload the page")},init:function(){this._done=!1,this._state=new osg.State;var t=this.getGraphicContext();this._state.setGraphicContext(t),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),this._updateVisitor=new osgUtil.UpdateVisitor,this._cullVisitor=new osgUtil.CullVisitor,this._renderStage=new osg.RenderStage,this._stateGraph=new osg.StateGraph,this._gamepad=!1,this._gamepadPolling=!1,this._urlOptions&&this.parseOptions(),this.getCamera().setClearColor([0,0,0,0])},getState:function(){return this._state},parseOptions:function(){var t=optionsURL();t.stats&&this.initStats(t),"0"!==t.gamepad&&this.initGamepad();var e=this.getGraphicContext();"0"===t.depth_test&&this.getGraphicContext().disable(e.DEPTH_TEST),"0"===t.blend&&this.getGraphicContext().disable(e.BLEND),"0"===t.cull_face&&this.getGraphicContext().disable(e.CULL_FACE),"0"===t.light&&this.setLightingMode(osgViewer.View.LightingMode.NO_LIGHT)},initGamepad:function(){var t=!!navigator.webkitGetGamepads||!!navigator.webkitGamepads;t&&(navigator.webkitGamepads||navigator.webkitGetGamepads)&&this.webkitStartGamepadPolling()},webkitStartGamepadPolling:function(){var t=this;this._gamepadPolling=setInterval(function(){t.webkitGamepadPoll()},500)},webkitGamepadPoll:function(){var t=navigator.webkitGetGamepads&&navigator.webkitGetGamepads()||navigator.webkitGamepads;t[0]?(this._gamepad||this.onGamepadConnect({gamepad:t[0]}),this._gamepad=t[0]):this._gamepad&&this.onGamepadDisconnect({gamepad:this._gamepad})},onGamepadConnect:function(t){this._gamepad=t.gamepad,osg.log("Detected new gamepad!",this._gamepad)},onGamepadDisconnect:function(){this._gamepad=!1,osg.log("Gamepad disconnected",this._gamepad)},updateGamepad:function(){var t=this.getManipulator();if(t.gamepadaxes&&(this._gamepadPolling&&this._gamepad&&this.webkitGamepadPoll(),this._gamepad)){t.gamepadaxes(this._gamepad.axes);for(var e=function(){},r=0;this._gamepad.buttons.length>r;r++)this._gamepad.buttons[r]&&t.gamepadbuttondown({preventDefault:e,gamepad:this._gamepad,button:r},!!this._gamepad.buttons[r])}},initStats:function(t){var e=35,r=5;void 0!==t.statsMaxMS&&(e=parseInt(t.statsMaxMS,10)),void 0!==t.statsStepMS&&(r=parseInt(t.statsStepMS,10));var i=function(t){var i,o=["<div id='StatsDiv' style='top: 0; position: absolute; width: 300px; height: 150px; z-index: 10;'>","<div id='StatsCanvasDiv' style='position: relative;'>","<canvas id='StatsCanvasGrid' width='300' height='150' style='z-index:-1; position: absolute; background: rgba(14,14,14,0.8); ' ></canvas>","<canvas id='StatsCanvas' width='300' height='150' style='z-index:8; position: absolute;' ></canvas>","<canvas id='StatsCanvasText' width='300' height='150' style='z-index:9; position: absolute;' ></canvas>","</div>","</div>"].join("\n");i=void 0===t?document.body:document.getElementById(t);var n=document.createElement("div");n.innerHTML=o,i.appendChild(n);var a=document.getElementById("StatsCanvasGrid"),s=a.getContext("2d");s.clearRect(0,0,a.width,a.height);var u=Math.floor(e/r).toFixed(0),h=a.height/u;s.strokeStyle="rgb(70,70,70)";for(var c=0,g=u;g>c;c++)s.beginPath(),s.moveTo(0,c*h),s.lineTo(a.width,c*h),s.stroke();return{graph:document.getElementById("StatsCanvas"),text:document.getElementById("StatsCanvasText")}};if(void 0===this._canvasStats||null===this._canvasStats){var o=i();this._canvasStats=o.graph,this._canvasStatsText=o.text}this._stats=new Stats.Stats(this._canvasStats,this._canvasStatsText);var n=this;this._frameRate=1,this._frameTime=0,this._updateTime=0,this._cullTime=0,this._drawTime=0,this._stats.addLayer("#ff0fff",120,function(){return 1e3/n._frameRate},function(t){return"FrameRate: "+t.toFixed(0)+" fps"}),this._stats.addLayer("#ffff00",e,function(){return n._frameTime},function(t){return"FrameTime: "+t.toFixed(2)+" ms"}),this._stats.addLayer("#d07b1f",e,function(){return n._updateTime},function(t){return"UpdateTime: "+t.toFixed(2)+" ms"}),this._stats.addLayer("#73e0ff",e,function(){return n._cullTime},function(t){return"CullTime: "+t.toFixed(2)+" ms"}),this._stats.addLayer("#ff0000",e,function(){return n._drawTime},function(t){return"DrawTime: "+t.toFixed(2)+" ms"}),window.performance&&window.performance.memory&&window.performance.memory.totalJSHeapSize&&this._stats.addLayer("#00ff00",2*window.performance.memory.totalJSHeapSize,function(){return n._memSize},function(t){return"Memory : "+t.toFixed(0)+" b"})},update:function(){this.getScene().accept(this._updateVisitor)},cull:function(){this._stateGraph.clean(),this._renderStage.reset(),this._cullVisitor.reset(),this._cullVisitor.setStateGraph(this._stateGraph),this._cullVisitor.setRenderStage(this._renderStage);var t=this.getCamera();this._cullVisitor.pushStateSet(t.getStateSet()),this._cullVisitor.pushProjectionMatrix(t.getProjectionMatrix()),t.getBound();var e=osg.Matrix.makeIdentity([]);this._cullVisitor.pushModelviewMatrix(e),this._light&&this._cullVisitor.addPositionedAttribute(this._light),this._cullVisitor.pushModelviewMatrix(t.getViewMatrix()),this._cullVisitor.pushViewport(t.getViewport()),this._cullVisitor.setCullSettings(t),this._renderStage.setClearDepth(t.getClearDepth()),this._renderStage.setClearColor(t.getClearColor()),this._renderStage.setClearMask(t.getClearMask()),this._renderStage.setViewport(t.getViewport()),this.getScene().accept(this._cullVisitor),this._cullVisitor.popModelviewMatrix(),this._cullVisitor.popProjectionMatrix(),this._cullVisitor.popViewport(),this._cullVisitor.popStateSet(),this._renderStage.sort()},draw:function(){var t=this.getState();this._renderStage.draw(t),t.popAllStateSets(),t.applyWithoutProgram()},frame:function(){var t,e;t=performance.now(),void 0===this._lastFrameTime&&(this._lastFrameTime=0),this._frameRate=t-this._lastFrameTime,this._lastFrameTime=t,e=t;var r=this.getFrameStamp();0===r.getFrameNumber()&&(r.setReferenceTime(t/1e3),this._numberFrame=0),r.setSimulationTime(t/1e3-r.getReferenceTime()),this._updateVisitor.setFrameStamp(this.getFrameStamp()),this.getManipulator()&&(this.getManipulator().update(this._updateVisitor),osg.Matrix.copy(this.getManipulator().getInverseMatrix(),this.getCamera().getViewMatrix())),this._gamepad&&this.updateGamepad(),void 0===this._stats?(this.update(),this.cull(),this.draw(),r.setFrameNumber(r.getFrameNumber()+1),this._numberFrame++,this._frameTime=performance.now()-e):(this._updateTime=performance.now(),this.update(),this._updateTime=performance.now()-this._updateTime,this._cullTime=performance.now(),this.cull(),this._cullTime=performance.now()-this._cullTime,this._drawTime=performance.now(),this.draw(),this._drawTime=performance.now()-this._drawTime,r.setFrameNumber(r.getFrameNumber()+1),this._numberFrame++,this._frameTime=performance.now()-e,window.performance&&window.performance.memory&&window.performance.memory.usedJSHeapSize&&(this._memSize=window.performance.memory.usedJSHeapSize),this._stats.update())},setDone:function(t){this._done=t},done:function(){return this._done},run:function(){var t=this,e=function(){t.done()||(t._requestID=window.requestAnimationFrame(e,t.canvas),t.frame())};e()},setupManipulator:function(t,e){void 0===t&&(t=new osgGA.OrbitManipulator),void 0!==t.setNode?t.setNode(this.getSceneData()):t.view=this,this.setManipulator(t);var r=this;if(void 0===e||e===!1){var i=!1,o=function(t){return r.getManipulator().touchstart(t)},n=function(t){return r.getManipulator().touchend(t)},a=function(t){return r.getManipulator().touchmove(t)},s=function(t){return r.getManipulator().touchcancel(t)},u=function(t){return r.getManipulator().touchleave(t)},h=function(t){return r.getManipulator().gesturestart(t)},c=function(t){return r.getManipulator().gesturechange(t)},g=function(t){return r.getManipulator().gestureend(t)};this._canvas.addEventListener("touchstart",o,!1),this._canvas.addEventListener("touchend",n,!1),this._canvas.addEventListener("touchmove",a,!1),this._canvas.addEventListener("touchcancel",s,!1),this._canvas.addEventListener("touchleave",u,!1),this._canvas.addEventListener("gesturestart",h,!1),this._canvas.addEventListener("gesturechange",c,!1),this._canvas.addEventListener("gestureend",g,!1);var l=function(t){return i===!1?r.getManipulator().mousedown(t):void 0},d=function(t){return i===!1?r.getManipulator().mouseup(t):void 0},f=function(t){return i===!1?r.getManipulator().mousemove(t):void 0},p=function(t){return i===!1?r.getManipulator().dblclick(t):void 0},m=function(t){if(i===!1){var e=t||window.event,o=[].slice.call(arguments,1),n=0,a=0,s=0;t.type="mousewheel",t.wheelDelta&&(n=t.wheelDelta/120),t.detail&&(n=-t.detail/3),s=n,void 0!==e.axis&&e.axis===e.HORIZONTAL_AXIS&&(s=0,a=-1*n),void 0!==e.wheelDeltaY&&(s=e.wheelDeltaY/120),void 0!==e.wheelDeltaX&&(a=-1*e.wheelDeltaX/120),o.unshift(t,n,a,s);var u=r.getManipulator();return u.mousewheel.apply(u,o)}};r.getManipulator().mousedown&&this._mouseEventNode.addEventListener("mousedown",l,!1),r.getManipulator().mouseup&&this._mouseEventNode.addEventListener("mouseup",d,!1),r.getManipulator().mousemove&&this._mouseEventNode.addEventListener("mousemove",f,!1),r.getManipulator().dblclick&&this._mouseEventNode.addEventListener("dblclick",p,!1),r.getManipulator().mousewheel&&(this._mouseWheelEventNode.addEventListener("DOMMouseScroll",m,!1),this._mouseWheelEventNode.addEventListener("mousewheel",m,!1));var v=function(t){return r.getManipulator().keydown(t)},_=function(t){return r.getManipulator().keyup(t)};r.getManipulator().keydown&&this._keyboardEventNode.addEventListener("keydown",v,!1),r.getManipulator().keyup&&this._keyboardEventNode.addEventListener("keyup",_,!1);var S=this,y=function(){var t=window.innerWidth,e=window.innerHeight,r=S._canvas.width,i=S._canvas.height;S._canvas.width=t,S._canvas.height=e,S._canvas.style.width=t,S._canvas.style.height=e,osg.debug("window resize "+r+"x"+i+" to "+t+"x"+e);var o=S.getCamera(),n=o.getViewport(),a=t/n.width(),s=e/n.height(),u=a/s;n.setViewport(n.x()*a,n.y()*s,n.width()*a,n.height()*s),1!==u&&osg.Matrix.postMult(osg.Matrix.makeScale(1,u,1,[]),o.getProjectionMatrix())};window.onresize=y}}});var osgGA=osgGA||{};osgGA.Manipulator=function(){this._touches=[],this._inverseMatrix=Array(16),osg.Matrix.makeIdentity(this._inverseMatrix),this._mousePosition=[0,0]},osgGA.Manipulator.prototype={divGlobalOffset:function(t){var e=0,r=0;e=t.offsetLeft,r=t.offsetTop;for(var i=document.getElementsByTagName("body")[0];t.offsetParent&&t!=i;)e+=t.offsetParent.offsetLeft,r+=t.offsetParent.offsetTop,t=t.offsetParent;return this._mousePosition[0]=e,this._mousePosition[1]=r,this._mousePosition},getPositionRelativeToCanvas:function(t,e){var r,i,o=this.view&&this.view._canvas?this.view._canvas:t.target;t.pageX||t.pageY?(r=t.pageX,i=t.pageY):(t.clientX||t.clientY)&&(r=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=t.clientY+document.body.scrollTop+document.documentElement.scrollTop);var n=this.divGlobalOffset(o);return r-=n[0],i=o.height-(i-n[1]),isNaN(r)||isNaN(i),void 0===e&&(e=this._mousePosition),e[0]=r,e[1]=i,e},keydown:function(){},keyup:function(){},mouseup:function(){},mousedown:function(){},mousemove:function(){},dblclick:function(){},touchstart:function(t){t.preventDefault();for(var e=t.changedTouches,r=0,i=e.length;i>r;r++){var o=e[r],n=o.identifier;this._touches[n]=o;var a=this.getPositionRelativeToCanvas(o);osg.debug("touch "+n+" started at "+a[0]+" "+a[1])}},touchend:function(t){t.preventDefault();for(var e=t.changedTouches,r=0,i=e.length;i>r;r++){var o=e[r],n=o.identifier;this._touches[n]=void 0;var a=this.getPositionRelativeToCanvas(o);osg.debug("touch "+n+" stoped at "+a[0]+" "+a[1])}},touchmove:function(t){t.preventDefault();for(var e=t.changedTouches,r=0,i=e.length;i>r;r++){var o=e[r],n=o.identifier,a=this.getPositionRelativeToCanvas(o,[]),s=this.getPositionRelativeToCanvas(this._touches[n],[]),u=a[0]-s[0],h=a[1]-s[1];this._touches[n]=o,osg.debug("touch "+n+" moved "+u+" "+h)}},touchleave:function(t){return this.touchend(t)},touchcancel:function(t){t.preventDefault();for(var e=t.changedTouches,r=0,i=e.length;i>r;r++){var o=e[r],n=o.identifier;this._touches[n]=void 0;var a=this.getPositionRelativeToCanvas(o);osg.debug("touch "+n+" cancelled at "+a[0]+" "+a[1])}},gesturestart:function(t){t.preventDefault(),osg.debug("gesturestart  scale "+t.scale+" rotation "+t.rotation)},gestureend:function(t){t.preventDefault(),osg.debug("gestureend  scale "+t.scale+" rotation "+t.rotation)},gesturechange:function(t){t.preventDefault(),osg.debug("gesturechange scale "+t.scale+" rotation "+t.rotation)},gamepadaxes:!1,gamepadbuttondown:!1,mousewheel:function(t,e,r,i){t.preventDefault(),osg.debug("mousewheel "+e+" "+" "+r+" "+i)},update:function(){},getInverseMatrix:function(){return this._inverseMatrix}},osgGA.OrbitManipulator=function(){osgGA.Manipulator.call(this),this.init()},osgGA.OrbitManipulator.Rotate=0,osgGA.OrbitManipulator.Pan=1,osgGA.OrbitManipulator.Zoom=2,osgGA.OrbitManipulator.Interpolator=function(t,e){this._current=Array(t),this._target=Array(t),this._delta=Array(t),this._delay=e,void 0===this._delay&&(this._delay=.15),this._reset=!1,this.reset()},osgGA.OrbitManipulator.Interpolator.prototype={reset:function(){for(var t=0,e=this._current.length;e>t;t++)this._current[t]=this._target[t]=0;this._reset=!0},update:function(){for(var t=0,e=this._current.length;e>t;t++){var r=(this._target[t]-this._current[t])*this._delay;this._delta[t]=r,this._current[t]+=r}return this._delta},set:function(){for(var t=0,e=this._current.length;e>t;t++)this._current[t]=this._target[t]=arguments[t];this._reset=!1},isReset:function(){return this._reset},getCurrent:function(){return this._current},setTarget:function(){for(var t=0,e=this._target.length;e>t;t++)this._target[t]=this._reset?this._current[t]=arguments[t]:arguments[t];this._reset=!1},getTarget:function(){return this._target},getDelta:function(){return this._delta}},osgGA.OrbitManipulator.prototype=osg.objectInehrit(osgGA.Manipulator.prototype,{init:function(){this._distance=25,this._target=Array(3),osg.Vec3.init(this._target),this._rotation=osg.Matrix.mult(osg.Matrix.makeRotate(Math.PI,0,0,1,[]),osg.Matrix.makeRotate(-Math.PI/10,1,0,0,[]),[]),this._time=0,this._rotate=new osgGA.OrbitManipulator.Interpolator(2),this._pan=new osgGA.OrbitManipulator.Interpolator(2),this._zoom=new osgGA.OrbitManipulator.Interpolator(1),this._zoom.reset=function(){osgGA.OrbitManipulator.Interpolator.prototype.reset.call(this),this._start=0},this._buttonup=!0,this._scale=10,this._currentMode=void 0,this._maxDistance=0,this._minDistance=0,this._scaleMouseMotion=1,this._node=void 0,this._moveTouch=void 0,this._inverseMatrix=Array(16),this._rotateKey=65,this._zoomKey=83,this._panKey=68},reset:function(){this.init()},setNode:function(t){this._node=t},setTarget:function(t){osg.Vec3.copy(t,this._target);var e=Array(3);this.getEyePosition(e),this._distance=osg.Vec3.distance(e,t)},setEyePosition:function(t){var e=this._rotation,r=this._target,i=[0,0,1],o=osg.Vec3.sub(t,r,[]);osg.Vec3.normalize(o,o);var n=osg.Vec3.cross(o,i,[]);osg.Vec3.normalize(n,n);var a=osg.Vec3.cross(n,o,[]);osg.Vec3.normalize(a,a),e[0]=n[0],e[1]=o[0],e[2]=a[0],e[3]=0,e[4]=n[1],e[5]=o[1],e[6]=a[1],e[7]=0,e[8]=n[2],e[9]=o[2],e[10]=a[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this._distance=osg.Vec3.distance(t,r)},computeHomePosition:function(){if(void 0!==this._node){var t=this._node.getBound();this.setDistance(1.5*t.radius()),this.setTarget(t.center())}},keydown:function(t){32===t.keyCode?this.computeHomePosition():33===t.keyCode?this.distanceIncrease():34===t.keyCode?this.distanceDecrease():t.keyCode===this._panKey&&this._currentMode!==osgGA.OrbitManipulator.Pan?(this._currentMode=osgGA.OrbitManipulator.Pan,this._pan.reset(),this.pushButton(),t.preventDefault()):t.keyCode===this._zoomKey&&this._currentMode!==osgGA.OrbitManipulator.Zoom?(this._currentMode=osgGA.OrbitManipulator.Zoom,this._zoom.reset(),this.pushButton(),t.preventDefault()):t.keyCode===this._rotateKey&&this._currentMode!==osgGA.OrbitManipulator.Rotate&&(this._currentMode=osgGA.OrbitManipulator.Rotate,this._rotate.reset(),this.pushButton(),t.preventDefault())},keyup:function(t){t.keyCode===this._panKey?this.mouseup(t):t.keyCode===this._rotateKey?this.mouseup(t):t.keyCode===this._rotateKey&&this.mouseup(t),this._currentMode=void 0},touchstart:function(t){void 0===this._currentMode&&(this._currentMode=osgGA.OrbitManipulator.Rotate);var e=t.changedTouches;if(void 0===this._moveTouch&&(this._moveTouch=new osgGA.OrbitManipulator.TouchEvent),void 0===this._moveTouch.id){var r=e[0],i=r.identifier,o=this.getPositionRelativeToCanvas(r);this._rotate.set(o[0],o[1]),this._moveTouch.init(i,o[0],o[1]),this.pushButton(r)}t.preventDefault()},touchend:function(t){t.preventDefault(),this._currentMode=void 0,this._moveTouch=void 0,this.releaseButton(t)},touchmove:function(t){t.preventDefault();for(var e=t.changedTouches,r=0,i=e.length;i>r;r++){var o=e[r],n=o.identifier;if(n===this._moveTouch.id){var a=this.getPositionRelativeToCanvas(o);this._rotate.setTarget(a[0],a[1]),this._moveTouch.init(n,a[0],a[1])}}},touchleave:function(t){return this.touchend(t)},touchcancel:function(t){this.touchend(t)},gesturestart:function(t){t.preventDefault(),this._moveTouch&&(this._moveTouch.id=void 0),this._moveTouch.init(void 0,0,0,t.scale,t.rotation),this._zoom.reset()},gestureend:function(t){t.preventDefault(),this._moveTouch.init(void 0,0,0,t.scale,t.rotation),this._currentMode=void 0},gesturechange:function(t){t.preventDefault();var e=5*(t.scale-this._moveTouch.scale);this._moveTouch.init(void 0,0,0,t.scale,t.rotation),this._zoom.setTarget(this._zoom.getTarget()[0]-e)},gamepadaxes:function(t){var e,r,i=.005;4==t.length?((Math.abs(t[0])>i||Math.abs(t[1])>i)&&(e=this._rotate.getTarget(),this._rotate.setTarget(e[0]-5*t[0],e[1]+5*t[1])),Math.abs(t[3])>i&&this._zoom.setTarget(this._zoom.getTarget()[0]-t[3])):t.length>=5&&((Math.abs(t[0])>i||Math.abs(t[1])>i)&&(r=this._pan.getTarget(),this._pan.setTarget(r[0]-20*t[0],r[1]+20*t[1])),Math.abs(t[2])>i&&this._zoom.setTarget(this._zoom.getTarget()[0]-t[2]),(Math.abs(t[3])>i||Math.abs(t[4])>i)&&(e=this._rotate.getTarget(),this._rotate.setTarget(e[0]+10*t[4],e[1]+10*t[3])))},gamepadbuttondown:function(t){if(t.button>=12&&15>=t.button){var e=this._pan.getTarget(),r={12:[0,-1],13:[0,1],14:[-1,0],15:[1,0]}[t.button];this._pan.setTarget(e[0]-10*r[0],e[1]+10*r[1])}},mouseup:function(t){this.releaseButton(t),this._currentMode=void 0},mousedown:function(t){void 0===this._currentMode&&(this._currentMode=0===t.button?t.shiftKey?osgGA.OrbitManipulator.Pan:t.ctrlKey?osgGA.OrbitManipulator.Zoom:osgGA.OrbitManipulator.Rotate:osgGA.OrbitManipulator.Pan),this.pushButton(t);var e=this.getPositionRelativeToCanvas(t);this._currentMode===osgGA.OrbitManipulator.Rotate?(this._rotate.reset(e[0],e[1]),this._rotate.set(e[0],e[1])):this._currentMode===osgGA.OrbitManipulator.Pan?(this._pan.reset(e[0],e[1]),this._pan.set(e[0],e[1])):this._currentMode===osgGA.OrbitManipulator.Zoom&&(this._zoom._start=e[1],this._zoom.set(0)),t.preventDefault()},mousemove:function(t){if(this._buttonup!==!0){var e=this.getPositionRelativeToCanvas(t);if(isNaN(e[0])===!1&&isNaN(e[1])===!1)if(this._currentMode===osgGA.OrbitManipulator.Rotate)this._rotate.setTarget(e[0],e[1]);else if(this._currentMode===osgGA.OrbitManipulator.Pan)this._pan.setTarget(e[0],e[1]);else if(this._currentMode===osgGA.OrbitManipulator.Zoom){this._zoom.isReset()&&(this._zoom._start=e[1],this._zoom.set(0));var r=e[1]-this._zoom._start;this._zoom._start=e[1];var i=this._zoom.getTarget()[0];this._zoom.setTarget(i-r/20)}t.preventDefault()}},setMaxDistance:function(t){this._maxDistance=t},setMinDistance:function(t){this._minDistance=t},setDistance:function(t){this._distance=t},getDistance:function(){return this._distance},computePan:function(t,e){e*=this._distance,t*=this._distance;var r=Array(16),i=Array(3),o=Array(3);osg.Matrix.inverse(this._rotation,r),i[0]=osg.Matrix.get(r,0,0),i[1]=osg.Matrix.get(r,0,1),i[2]=osg.Matrix.get(r,0,2),osg.Vec3.normalize(i,i),o[0]=osg.Matrix.get(r,2,0),o[1]=osg.Matrix.get(r,2,1),o[2]=osg.Matrix.get(r,2,2),osg.Vec3.normalize(o,o),osg.Vec3.mult(i,-t,i),osg.Vec3.mult(o,e,o),osg.Vec3.add(this._target,i,this._target),osg.Vec3.add(this._target,o,this._target)},computeRotation:function(t,e){var r=osg.Matrix.makeRotate(t/10,0,0,1,[]),i=osg.Matrix.mult(this._rotation,r,[]);r=osg.Matrix.makeRotate(e/10,1,0,0,[]);var o=osg.Matrix.mult(r,i,[]),n=[];osg.Matrix.inverse(o,n);var a=osg.Matrix.transformVec3(n,[0,this._distance,0],Array(3)),s=osg.Vec3.neg(a,[]);osg.Vec3.normalize(s,s);var u=osg.Vec3.dot(s,[0,0,1]);return Math.abs(u)>.95?(this._rotation=i,void 0):(this._rotation=o,void 0)},releaseButton:function(){this._buttonup=!0},mousewheel:function(t,e){t.preventDefault(),this._zoom.setTarget(this._zoom.getTarget()[0]-e)},computeZoom:function(t){this.zoom(t)},zoom:function(t){var e=this._distance*t;this._minDistance>0&&this._minDistance>e&&(e=this._minDistance),this._maxDistance>0&&e>this._maxDistance&&(e=this._maxDistance),this._distance=e},pushButton:function(){this._buttonup=!1},getTarget:function(t){osg.Vec3.copy(this._target,t)},getEyePosition:function(t){var e=Array(16);osg.Matrix.inverse(this._rotation,e),osg.Matrix.transformVec3(e,[0,this._distance,0],t),osg.Vec3.add(this._target,t,t)},update:function(t){var e=t.getFrameStamp().getSimulationTime();void 0===this._lastUpdate&&(this._lastUpdate=e),e-this._lastUpdate,this._lastUpdate=e;var r,i=.1;r=this._rotate.update(),this.computeRotation(-r[0]*i*this._scaleMouseMotion,-r[1]*i*this._scaleMouseMotion);var o=.002;r=this._pan.update(),this.computePan(-r[0]*o,-r[1]*o),r=this._zoom.update(),this.computeZoom(1+r[0]/10);var n=this._target,a=this._distance,s=Array(3);osg.Matrix.inverse(this._rotation,this._inverseMatrix),osg.Matrix.transformVec3(this._inverseMatrix,[0,a,0],s),osg.Matrix.makeLookAt(osg.Vec3.add(n,s,s),n,[0,0,1],this._inverseMatrix)},getInverseMatrix:function(){return this._inverseMatrix}}),osgGA.OrbitManipulator.TouchEvent=function(){this.x=0,this.y=0,this.scale=1,this.rotation=0,this.id=void 0},osgGA.OrbitManipulator.TouchEvent.prototype={init:function(t,e,r,i,o){this.id=t,this.x=e,this.y=r,void 0!==i&&(this.scale=i),void 0!==o&&(this.rotation=o)}},osgGA.FirstPersonManipulator=function(){osgGA.Manipulator.call(this),this.init()},osgGA.FirstPersonManipulator.prototype=osg.objectInehrit(osgGA.Manipulator.prototype,{setNode:function(t){this._node=t,this.computeHomePosition()},computeHomePosition:function(){if(void 0!==this._node){var t=this._node.getBound();this._radius=t.radius(),this._eye=[0,1.5*-t.radius(),0],this._angleVertical=0,this._angleHorizontal=0}},init:function(){this._direction=[0,1,0],this._angleVertical=0,this._angleHorizontal=0,this._eye=[0,25,10],this._up=[0,0,1],this._buttonup=!0,this._radius=1,this._forward=new osgGA.OrbitManipulator.Interpolator(1),this._side=new osgGA.OrbitManipulator.Interpolator(1),this._lookPosition=new osgGA.OrbitManipulator.Interpolator(2),this._stepFactor=1,this._target=Array(3),osg.Vec3.init(this._target)},reset:function(){this.init()},getEyePosition:function(t){return t[0]=this._eye[0],t[1]=this._eye[1],t[2]=this._eye[2],t
},setEyePosition:function(t){this._eye[0]=t[0],this._eye[1]=t[1],this._eye[2]=t[2]},getTarget:function(t,e){void 0===e&&(e=25);var r=osg.Vec3.mult(this._direction,e,Array(3));osg.Vec3.add(this._eye,r,t)},setTarget:function(t){this._target[0]=t[0],this._target[1]=t[1],this._target[2]=t[2];var e=Array(3);osg.Vec3.sub(t,this._eye,e),e[2]=0,osg.Vec3.normalize(e,e),this._angleHorizontal=Math.acos(e[1]),0>e[0]&&(this._angleHorizontal=-this._angleHorizontal),osg.Vec3.sub(t,this._eye,e),osg.Vec3.normalize(e,e),this._angleVertical=-Math.asin(e[2]),osg.Vec3.copy(e,this._direction)},mousedown:function(t){var e=this.getPositionRelativeToCanvas(t);this._lookPosition.set(e[0],e[1]),this._buttonup=!1},mouseup:function(){this._buttonup=!0},mousemove:function(t){if(this._buttonup!==!0){var e=this.getPositionRelativeToCanvas(t);this._lookPosition.setTarget(e[0],e[1])}},computeRotation:function(t,e){this._angleVertical+=.01*e,this._angleHorizontal-=.01*t;var r=[],i=[],o=[];osg.Matrix.makeRotate(this._angleVertical,1,0,0,r),osg.Matrix.makeRotate(this._angleHorizontal,0,0,1,i),osg.Matrix.mult(i,r,o),this._direction=osg.Matrix.transformVec3(o,[0,1,0],[]),osg.Vec3.normalize(this._direction,this._direction),this._up=osg.Matrix.transformVec3(o,[0,0,1],[])},mousewheel:function(t,e){t.preventDefault(),this._stepFactor=Math.min(Math.max(.001,this._stepFactor+.01*e),4)},update:function(t){var e=t.getFrameStamp().getSimulationTime();void 0===this._lastUpdate&&(this._lastUpdate=e);var r=e-this._lastUpdate;this._lastUpdate=e,this._forward.update(),this._side.update();var i=this._lookPosition.update();this.computeRotation(.5*-i[0],.5*-i[1]);var o=Array(2);o[0]=this._forward.getCurrent()[0],o[1]=this._side.getCurrent()[0],osg.Vec2.length(o)>1&&osg.Vec2.normalize(o,o);var n=this._radius;.001>this._radius&&(n=1),this.moveForward(o[0]*n*this._stepFactor*r),this.strafe(o[1]*n*this._stepFactor*r);var a=osg.Vec3.add(this._eye,this._direction,[]);this._target=a,osg.Matrix.makeLookAt(this._eye,a,this._up,this._inverseMatrix)},getInverseMatrix:function(){return this._inverseMatrix},moveForward:function(t){var e=osg.Vec3.mult(osg.Vec3.normalize(this._direction,[]),t,[]);this._eye=osg.Vec3.add(this._eye,e,[])},strafe:function(t){var e=osg.Vec3.cross(this._direction,this._up,[]),r=osg.Vec3.mult(osg.Vec3.normalize(e,e),t,[]);this._eye=osg.Vec3.add(this._eye,r,[])},keydown:function(t){if(32===t.keyCode)this.computeHomePosition();else{if(87===t.keyCode||90===t.keyCode||38===t.keyCode)return this._forward.setTarget(1),!1;if(83===t.keyCode||40===t.keyCode)return this._forward.setTarget(-1),!1;if(68===t.keyCode||39===t.keyCode)return this._side.setTarget(1),!1;if(65===t.keyCode||81===t.keyCode||37===t.keyCode)return this._side.setTarget(-1),!1}},keyup:function(t){return 87===t.keyCode||90===t.keyCode||38===t.keyCode?(this._forward.setTarget(0),!1):83==t.keyCode||40===t.keyCode?(this._forward.setTarget(0),!1):68==t.keyCode||39===t.keyCode?(this._side.setTarget(0),!1):65===t.keyCode||81===t.keyCode||37===t.keyCode?(this._side.setTarget(0),!1):void 0}}),osgGA.SwitchManipulator=function(){osgGA.Manipulator.call(this),this._manipulatorList=[],this._currentManipulator=void 0},osgGA.SwitchManipulator.prototype=osg.objectInehrit(osgGA.Manipulator.prototype,{update:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.update(t):void 0},setNode:function(t){var e=this.getCurrentManipulator();return void 0===e.setNode?(osg.log("manipulator has not setNode method"),void 0):(e.setNode(t),void 0)},getNumManipulator:function(){return this._manipulatorList.length},addManipulator:function(t){this._manipulatorList.push(t),void 0===this._currentManipulator&&(this._currentManipulator=0)},getManipulatorList:function(){return this._manipulatorList},setManipulatorIndex:function(t){this._currentManipulator=t},getCurrentManipulatorIndex:function(){return this._currentManipulator},getCurrentManipulator:function(){var t=this._manipulatorList[this._currentManipulator];return t},reset:function(){this.getCurrentManipulator().reset()},computeHomePosition:function(){var t=this.getCurrentManipulator();void 0!==t&&t.computeHomePosition()},keydown:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.keydown(t):void 0},keyup:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.keyup(t):void 0},mouseup:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.mouseup(t):void 0},mousedown:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.mousedown(t):void 0},mousemove:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.mousemove(t):void 0},dblclick:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.dblclick(t):void 0},touchstart:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.touchstart(t):void 0},touchend:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.touchend(t):void 0},touchmove:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.touchmove(t):void 0},touchleave:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.touchleave(t):void 0},touchcancel:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.touchcancel(t):void 0},gesturestart:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.gesturestart(t):void 0},gestureend:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.gestureend(t):void 0},gesturechange:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.gesturechange(t):void 0},mousewheel:function(t,e,r,i){var o=this.getCurrentManipulator();return void 0!==o?o.mousewheel(t,e,r,i):void 0},gamepadaxes:function(t){var e=this.getCurrentManipulator();return void 0!==e?e.gamepadaxes(t):void 0},gamepadbuttondown:function(t,e){var r=this.getCurrentManipulator();return void 0!==r?r.gamepadbuttondown(t,e):void 0},getInverseMatrix:function(){var t=this.getCurrentManipulator();return void 0!==t?t.getInverseMatrix():void 0}}),osgDB.ObjectWrapper.serializers.osg={},osgDB.ObjectWrapper.serializers.osg.Object=function(t,e){var r=t.getJSON(),i=function(){return!0};if(i(r)){if(r.Name&&e.setName(r.Name),r.UserDataContainer){var o=t.setJSON(r.UserDataContainer).readUserDataContainer();void 0!==o&&e.setUserData(o)}return e}},osgDB.ObjectWrapper.serializers.osg.Node=function(t,e){var r=t.getJSON(),i=function(){return!0};if(i(r)){osgDB.ObjectWrapper.serializers.osg.Object(t,e);var o=[],n=function(r){var i=t.setJSON(r).readObject(),n=osgDB.Promise.defer();o.push(n.promise),osgDB.Promise.when(i).then(function(t){t&&e.addUpdateCallback(t),n.resolve()})};if(r.UpdateCallbacks)for(var a=0,s=r.UpdateCallbacks.length;s>a;a++)n(r.UpdateCallbacks[a]);if(r.StateSet){var u=t.setJSON(r.StateSet).readObject(),h=osgDB.Promise.defer();o.push(h.promise),osgDB.Promise.when(u).then(function(t){e.setStateSet(t),h.resolve()})}var c=function(r){var i=t.setJSON(r).readObject(),n=osgDB.Promise.defer();o.push(n.promise),osgDB.Promise.when(i).then(function(t){t&&e.addChild(t),n.resolve(t)})};if(r.Children)for(var g=0,l=r.Children.length;l>g;g++)c(r.Children[g]);var d=osgDB.Promise.defer();return osgDB.Promise.all(o).then(function(){d.resolve(e)}),d.promise}},osgDB.ObjectWrapper.serializers.osg.StateSet=function(t,e){var r=t.getJSON(),i=function(){return!0};if(i(r)){osgDB.ObjectWrapper.serializers.osg.Object(t,e),void 0!==r.RenderingHint&&e.setRenderingHint(r.RenderingHint);var o=function(r){var i=t.setJSON(r).readObject(),o=osgDB.Promise.defer();n.push(o.promise),osgDB.Promise.when(i).then(function(t){void 0!==t&&e.setAttributeAndMode(t),o.resolve()})},n=[];if(void 0!==r.AttributeList)for(var a=0,s=r.AttributeList.length;s>a;a++)o(r.AttributeList[a]);var u=function(r,i){var o=t.setJSON(i).readObject(),a=osgDB.Promise.defer();n.push(a.promise),osgDB.Promise.when(o).then(function(t){t&&e.setTextureAttributeAndMode(r,t),a.resolve()})};if(r.TextureAttributeList)for(var h=r.TextureAttributeList,c=0,g=h.length;g>c;c++)for(var l=h[c],d=0,f=l.length;f>d;d++)u(c,l[d]);var p=osgDB.Promise.defer();return osgDB.Promise.all(n).then(function(){p.resolve(e)}),p.promise}},osgDB.ObjectWrapper.serializers.osg.Material=function(t,e){var r=t.getJSON(),i=function(t){return void 0!==t.Diffuse&&void 0!==t.Emission&&void 0!==t.Specular&&void 0!==t.Shininess?!0:!1};return i(r)?(osgDB.ObjectWrapper.serializers.osg.Object(t,e),e.setAmbient(r.Ambient),e.setDiffuse(r.Diffuse),e.setEmission(r.Emission),e.setSpecular(r.Specular),e.setShininess(r.Shininess),e):void 0},osgDB.ObjectWrapper.serializers.osg.BlendFunc=function(t,e){var r=t.getJSON(),i=function(t){return t.SourceRGB&&t.SourceAlpha&&t.DestinationRGB&&t.DestinationAlpha?!0:!1};return i(r)?(osgDB.ObjectWrapper.serializers.osg.Object(t,e),e.setSourceRGB(r.SourceRGB),e.setSourceAlpha(r.SourceAlpha),e.setDestinationRGB(r.DestinationRGB),e.setDestinationAlpha(r.DestinationAlpha),e):void 0},osgDB.ObjectWrapper.serializers.osg.CullFace=function(t,e){var r=t.getJSON(),i=function(t){return void 0!==t.Mode?!0:!1};return i(r)?(osgDB.ObjectWrapper.serializers.osg.Object(t,e),e.setMode(r.Mode),e):void 0},osgDB.ObjectWrapper.serializers.osg.BlendColor=function(t,e){var r=t.getJSON(),i=function(t){return void 0!==t.ConstantColor?!0:!1};return i(r)?(osgDB.ObjectWrapper.serializers.osg.Object(t,e),e.setConstantColor(r.ConstantColor),e):void 0},osgDB.ObjectWrapper.serializers.osg.Light=function(t,e){var r=t.getJSON(),i=function(t){return void 0!==t.LightNum&&void 0!==t.Ambient&&void 0!==t.Diffuse&&void 0!==t.Direction&&void 0!==t.Position&&void 0!==t.Specular&&void 0!==t.SpotCutoff&&void 0!==t.LinearAttenuation&&void 0!==t.ConstantAttenuation&&void 0!==t.QuadraticAttenuation?!0:!1};return i(r)?(osgDB.ObjectWrapper.serializers.osg.Object(t,e),e.setAmbient(r.Ambient),e.setConstantAttenuation(r.ConstantAttenuation),e.setDiffuse(r.Diffuse),e.setDirection(r.Direction),e.setLightNumber(r.LightNum),e.setLinearAttenuation(r.LinearAttenuation),e.setPosition(r.Position),e.setQuadraticAttenuation(r.QuadraticAttenuation),e.setSpecular(r.Specular),e.setSpotCutoff(r.SpotCutoff),e.setSpotBlend(.01),void 0!==r.SpotExponent&&e.setSpotBlend(r.SpotExponent/128),e):void 0},osgDB.ObjectWrapper.serializers.osg.Texture=function(t,e){var r=t.getJSON(),i=function(){return!0};if(i(r)){osgDB.ObjectWrapper.serializers.osg.Object(t,e),void 0!==r.MinFilter&&e.setMinFilter(r.MinFilter),void 0!==r.MagFilter&&e.setMagFilter(r.MagFilter),void 0!==r.WrapT&&e.setWrapT(r.WrapT),void 0!==r.WrapS&&e.setWrapS(r.WrapS);var o=r.File;void 0===o&&(o="no-image-provided");var n=osgDB.Promise.defer();return osgDB.Promise.when(t.readImageURL(o)).then(function(t){e.setImage(t),n.resolve(e)}),n.promise}},osgDB.ObjectWrapper.serializers.osg.Projection=function(t,e){var r=t.getJSON(),i=function(t){return void 0!==t.Matrix?!0:!1};if(i(r)){var o=osgDB.ObjectWrapper.serializers.osg.Node(t,e);return void 0!==r.Matrix&&e.setMatrix(r.Matrix),o}},osgDB.ObjectWrapper.serializers.osg.MatrixTransform=function(t,e){var r=t.getJSON(),i=function(t){return t.Matrix?!0:!1};if(i(r)){var o=osgDB.ObjectWrapper.serializers.osg.Node(t,e);return void 0!==r.Matrix&&e.setMatrix(r.Matrix),o}},osgDB.ObjectWrapper.serializers.osg.LightSource=function(t,e){var r=t.getJSON(),i=function(t){return void 0!==t.Light?!0:!1};if(i(r)){var o=osgDB.Promise.defer(),n=osgDB.ObjectWrapper.serializers.osg.Node(t,e);return osgDB.Promise.all([t.setJSON(r.Light).readObject(),n]).then(function(t){var r=t[0];t[1],e.setLight(r),o.resolve(e)}),o.promise}},osgDB.ObjectWrapper.serializers.osg.Geometry=function(t,e){var r=t.getJSON(),i=function(t){return void 0!==t.PrimitiveSetList&&void 0!==t.VertexAttributeList?!0:!1};if(i(r)){var o=[];o.push(osgDB.ObjectWrapper.serializers.osg.Node(t,e));for(var n=function(r){var i=osgDB.Promise.defer();o.push(i.promise);var n=t.setJSON(r).readPrimitiveSet();osgDB.Promise.when(n).then(function(t){void 0!==t&&e.getPrimitives().push(t),i.resolve(t)})},a=0,s=r.PrimitiveSetList.length;s>a;a++){var u=r.PrimitiveSetList[a];n(u)}var h=function(r,i){var n=osgDB.Promise.defer();o.push(n.promise);var a=t.setJSON(i).readBufferArray();osgDB.Promise.when(a).then(function(t){void 0!==t&&(e.getVertexAttributeList()[r]=t),n.resolve(t)})};for(var c in r.VertexAttributeList)r.VertexAttributeList.hasOwnProperty(c)&&h(c,r.VertexAttributeList[c]);var g=osgDB.Promise.defer();return osgDB.Promise.all(o).then(function(){g.resolve(e)}),g.promise}},osgDB.ObjectWrapper.serializers.osgAnimation={},osgDB.ObjectWrapper.serializers.osgAnimation.Animation=function(t,e){var r=t.getJSON(),i=function(t){return t.Name&&t.Channels&&t.Channels.length>0?!0:t.Name?!1:(osg.log("animation has field Name, error"),!1)};if(i(r)&&osgDB.ObjectWrapper.serializers.osg.Object(t,e)){for(var o=0,n=r.Channels.length;n>o;o++)osgDB.Promise.when(t.setJSON(r.Channels[o]).readObject()).then(function(t){t&&e.getChannels().push(t)});return e}},osgDB.ObjectWrapper.serializers.osgAnimation.Vec3LerpChannel=function(t,e){var r=t.getJSON(),i=function(t){return t.KeyFrames&&t.TargetName&&t.Name?!0:!1};if(i(r)&&osgDB.ObjectWrapper.serializers.osg.Object(t,e)){e.setTargetName(r.TargetName);for(var o=e.getSampler().getKeyframes(),n=0,a=r.KeyFrames.length;a>n;n++){var s=r.KeyFrames[n],u=s.slice(1);u.t=s[0],o.push(u)}return e}},osgDB.ObjectWrapper.serializers.osgAnimation.QuatLerpChannel=function(t,e){return osgDB.ObjectWrapper.serializers.osgAnimation.Vec3LerpChannel(t,e)},osgDB.ObjectWrapper.serializers.osgAnimation.QuatSlerpChannel=function(t,e){return osgDB.ObjectWrapper.serializers.osgAnimation.Vec3LerpChannel(t,e)},osgDB.ObjectWrapper.serializers.osgAnimation.FloatLerpChannel=function(t,e){var r=t.getJSON(),i=function(t){return t.KeyFrames&&t.TargetName&&t.Name?!0:!1};if(i(r)&&osgDB.ObjectWrapper.serializers.osg.Object(t,e)){e.setTargetName(r.TargetName);for(var o=e.getSampler().getKeyframes(),n=0,a=r.KeyFrames.length;a>n;n++){var s=r.KeyFrames[n],u=s.slice(1);u.t=s[0],o.push(u)}return e}},osgDB.ObjectWrapper.serializers.osgAnimation.BasicAnimationManager=function(t,e){var r=t.getJSON(),i=function(t){return t.Animations?!0:!1};if(i(r)){for(var o=0,n=r.Animations.length;n>o;o++){var a=r.Animations[o],s=t.setJSON(a).readObject();s&&e.registerAnimation(s)}return e}},osgDB.ObjectWrapper.serializers.osgAnimation.UpdateMatrixTransform=function(t,e){var r=t.getJSON(),i=function(t){return t.Name&&t.StackedTransforms?!0:!1};if(i(r)&&void 0!==osgDB.ObjectWrapper.serializers.osg.Object(t,e)){for(var o=0,n=r.StackedTransforms.length;n>o;o++){var a=r.StackedTransforms[o],s=t.setJSON(a).readObject();s&&e.getStackedTransforms().push(s)}return e}},osgDB.ObjectWrapper.serializers.osgAnimation.StackedTranslate=function(t,e){var r=t.getJSON(),i=function(t){return t.Name?!0:!1};return i(r)&&osgDB.ObjectWrapper.serializers.osg.Object(t,e)?(r.Translate&&e.setTranslate(r.Translate),e):void 0},osgDB.ObjectWrapper.serializers.osgAnimation.StackedQuaternion=function(t,e){var r=t.getJSON(),i=function(t){return t.Name?!0:!1};return i(r)&&osgDB.ObjectWrapper.serializers.osg.Object(t,e)?(r.Quaternion&&e.setQuaternion(r.Quaternion),e):void 0},osgDB.ObjectWrapper.serializers.osgAnimation.StackedRotateAxis=function(t,e){var r=t.getJSON(),i=function(t){return t.Axis?!0:!1};return i(r)&&osgDB.ObjectWrapper.serializers.osg.Object(t,e)?(r.Angle&&e.setAngle(r.Angle),e.setAxis(r.Axis),e):void 0},osg.ShadowScene=function(t,e,r,i){osg.Transform.call(this),osg.CullSettings.call(this),this._camera=t,this._lightNode=lightNode0,this._technique=i,this._receivesShadowTraversalMask=r,this._shadowReceiverScene=new osg.Node,this._enabled=0},osg.ShadowScene.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.CullSettings.prototype,osg.objectInehrit(osg.Transform.prototype,{hasChild:function(t){return this._ShadowedScene.hasChild(t)},removeChildren:function(){this._ShadowedScene.removeChildren()},removeChild:function(t){this._ShadowedScene.removeChild(t)},addChild:function(t){return this._ShadowedScene.addChild(t)},getChildren:function(){return this._ShadowedScene.getChildren()},setLightSource:function(){this._lightSource=_lightSource},getLightSource:function(){return this._lightSource},setTechnique:function(t){this._technique=t},getTechnique:function(){return this._technique},setScene:function(){}})),"osg","Shadow"),osg.ShadowScene.prototype.objectType=osg.objectType.generate("ShadowScene"),osg.ShadowTechnique=function(t){osg.StateAttribute.call(this),void 0===t&&(t=0),this._position=[0,0,1,0],this._direction=[0,0,-1],this._ShadowTechniqueUnit=t,this._enabled=0,this._Textures=[];var e=256;this._TextureSize=[e,e,1/e,1/e],this._biasScale=0,this._fov=60,this._ratio=1,this._Camera=new osg.Camera,this._Camera.setName("light_perspective_camera"+t),this._projection=osg.Matrix.makePerspective(this._fov,this._ratio,this._depthRange.get()[0],this._depthRange.get()[0],this._projection),this._Camera.setProjectionMatrix(this._projection),this._Camera.setRenderOrder(osg.Camera.PRE_RENDER,0),this._Camera.setReferenceFrame(osg.Transform.ABSOLUTE_RF),this._Camera.setViewport(new osg.Viewport(0,0,this._TextureSize[0],this._TextureSize[1])),this._Camera.setClearColor([1,1,1,0]),this.shadowmapCasterVertex="shadowmap_cast.vert",this.shadowmapCasterFragment="shadowmap_cast.frag",this.shadowmapReceiverVertex="shadowmap_receive.vert",this.shadowmapReceiverFragment="shadowmap_receive.frag",this.textureType=osg.Texture.UNSIGNED_BYTE,this.textureFormat=osg.Texture.RGBA,this.dirty()},osg.ShadowTechnique.uniforms={},osg.ShadowTechnique.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Shadow",cloneType:function(){return new osg.ShadowTechnique(this._ShadowTechniqueUnit)},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType+this._ShadowTechniqueUnit},getOrCreateUniforms:function(){var t=osg.ShadowTechnique.uniforms,e=this.getTypeMember();if(void 0===t[e]){var r=osg.Uniform;t[e]={depthRange:r.createFloat2(this.depthRange,"DepthRange"),Projection:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("Projection")),ModelView:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("ModelView")),MapSize:r.createFloat4(this._TextureSize,this.getUniformName("MapSize"))},t[e].uniformKeys=Object.keys(t[e])}return t[e]},setPosition:function(t){osg.Vec4.copy(t,this._position)},getPosition:function(){return this._position},setDirection:function(t){this._direction=t,this.dirty()},getDirection:function(){return this._direction},setShadowTechniqueNumber:function(t){this._ShadowTechniqueUnit=t,this.dirty()},getShadowTechniqueNumber:function(){return this._ShadowTechniqueUnit},getPrefix:function(){return this.getType()+this._ShadowTechniqueUnit},getParameterName:function(t){return this.getPrefix()+"_"+t},getUniformName:function(t){return this.getPrefix()+"_uniform_"+t},applyPositionedUniform:function(t){var e=this.getOrCreateUniforms();osg.Matrix.copy(t,e.matrix.get()),e.matrix.dirty(),osg.Matrix.copy(t,e.invMatrix.get()),e.invMatrix.get()[12]=0,e.invMatrix.get()[13]=0,e.invMatrix.get()[14]=0,osg.Matrix.inverse(e.invMatrix.get(),e.invMatrix.get()),osg.Matrix.transpose(e.invMatrix.get(),e.invMatrix.get()),e.invMatrix.dirty()},apply:function(){this.getOrCreateUniforms(),this.setDirty(!1)},_replace:function(t,e,r,i){for(var o=0,n=e.length;n>o;o++){var a=RegExp(t+e[o],"g");r=r.replace(a,i.call(this,e[o]))}return r},_shader:{},_shaderCommon:{},generateShader:function(t){return this._shader[t]?this._shader[t].call(this):""},generateShaderCommon:function(t){return this._shaderCommon[t]?this._shaderCommon[t].call(this):""}}),"osg","ShadowTechnique"),osg.ShadowTechnique.prototype._shaderCommon[osg.ShaderGeneratorType.VertexInit]=function(){return["","varying vec4 ShadowVertexProjected0;","varying float ShadowZ;","",""].join("\n")},osg.ShadowTechnique.prototype._shaderCommon[osg.ShaderGeneratorType.VertexFunction]=function(){return["","",""].join("\n")},osg.ShadowTechnique.prototype._shaderCommon[osg.ShaderGeneratorType.VertexMain]=function(){return["",""].join("\n")},osg.ShadowTechnique.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentInit]=function(){return[""].join("\n")},osg.ShadowTechnique.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentFunction]=function(){return["",""].join("\n")},osg.ShadowTechnique.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentMain]=function(){return[""].join("\n")},osg.ShadowTechnique.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentEnd]=function(){return["",""].join("\n")},osg.ShadowTechnique.prototype._shader[osg.ShaderGeneratorType.FragmentInit]=function(){var t=["","uniform mat4 Shadow_Projection;","uniform mat4 Shadow_ModelView;","uniform vec4 Shadow_DepthRange;",""].join("\n");return uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("Shadow_",uniforms,t,this.getUniformName)},osg.ShadowTechnique.prototype._shader[osg.ShaderGeneratorType.FragmentMain]=function(){var t=["",""].join("\n"),e=["Shadow_VertexProjected","Shadow_Z","Shadow_MapSize"];return t=this._replace("",e,t,this.getParameterName),uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("Shadow_",uniforms,t,this.getUniformName)},osg.ShadowTechniquePCF=function(t){osg.StateAttribute.call(this),void 0===t&&(t=0),this._position=[0,0,1,0],this._direction=[0,0,-1],this._ShadowTechniquePCFUnit=t,this._enabled=0,this.dirty()},osg.ShadowTechniquePCF.uniforms={},osg.ShadowTechniquePCF.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"ShadowTechniquePCF",cloneType:function(){return new osg.ShadowTechniquePCF(this._ShadowTechniquePCFUnit)},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType+this._ShadowTechniquePCFUnit},getOrCreateUniforms:function(){var t=osg.ShadowTechniquePCF.uniforms,e=this.getTypeMember();if(void 0===t[e]){var r=osg.Uniform;t[e]={enable:r.createInt1(0,this.getUniformName("enable")),matrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("matrix")),invMatrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("invMatrix"))},t[e].uniformKeys=Object.keys(t[e])}return t[e]},setPosition:function(t){osg.Vec4.copy(t,this._position)},getPosition:function(){return this._position},setDirection:function(t){this._direction=t,this.dirty()},getDirection:function(){return this._direction},setShadowTechniquePCFNumber:function(t){this._ShadowTechniquePCFUnit=t,this.dirty()},getShadowTechniquePCFNumber:function(){return this._ShadowTechniquePCFUnit},getPrefix:function(){return this.getType()+this._ShadowTechniquePCFUnit},getParameterName:function(t){return this.getPrefix()+"_"+t},getUniformName:function(t){return this.getPrefix()+"_uniform_"+t},applyPositionedUniform:function(t){var e=this.getOrCreateUniforms();osg.Matrix.copy(t,e.matrix.get()),e.matrix.dirty(),osg.Matrix.copy(t,e.invMatrix.get()),e.invMatrix.get()[12]=0,e.invMatrix.get()[13]=0,e.invMatrix.get()[14]=0,osg.Matrix.inverse(e.invMatrix.get(),e.invMatrix.get()),osg.Matrix.transpose(e.invMatrix.get(),e.invMatrix.get()),e.invMatrix.dirty()},apply:function(){this.getOrCreateUniforms(),this.setDirty(!1)},_replace:function(t,e,r,i){for(var o=0,n=e.length;n>o;o++){var a=RegExp(t+e[o],"g");r=r.replace(a,i.call(this,e[o]))}return r},_shader:{},_shaderCommon:{},generateShader:function(t){return this._shader[t]?this._shader[t].call(this):""},generateShaderCommon:function(t){return this._shaderCommon[t]?this._shaderCommon[t].call(this):""}}),"osg","ShadowTechniquePCF"),osg.ShadowTechniquePCF.prototype._shaderCommon[osg.ShaderGeneratorType.VertexInit]=function(){return["","varying vec3 FragNormal;","varying vec3 FragEyeVector;","",""].join("\n")},osg.ShadowTechniquePCF.prototype._shaderCommon[osg.ShaderGeneratorType.VertexFunction]=function(){return["","vec3 computeNormal() {","   return vec3(NormalMatrix * vec4(Normal, 0.0));","}","","vec3 computeEyeVertex() {","   return vec3(ModelViewMatrix * vec4(Vertex,1.0));","}","",""].join("\n")},osg.ShadowTechniquePCF.prototype._shaderCommon[osg.ShaderGeneratorType.VertexMain]=function(){return["","  FragEyeVector = computeEyeVertex();","  FragNormal = computeNormal();",""].join("\n")},osg.ShadowTechniquePCF.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentInit]=function(){return["varying vec3 FragNormal;","varying vec3 FragEyeVector;",""].join("\n")},osg.ShadowTechniquePCF.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentFunction]=function(){return["","float getShadowTechniquePCFAttenuation(vec3 ShadowTechniquePCFDir, float constant, float linear, float quadratic) {","    ","    float d = length(ShadowTechniquePCFDir);","    float att = 1.0 / ( constant + linear*d + quadratic*d*d);","    return att;","}","vec4 computeShadowTechniquePCFContribution(vec4 materialAmbient,","                              vec4 materialDiffuse,","                              vec4 materialSpecular,","                              float materialShininess,","                              vec4 ShadowTechniquePCFAmbient,","                              vec4 ShadowTechniquePCFDiffuse,","                              vec4 ShadowTechniquePCFSpecular,","                              vec3 normal,","                              vec3 eye,","                              vec3 ShadowTechniquePCFDirection,","                              vec3 ShadowTechniquePCFSpotDirection,","                              float ShadowTechniquePCFCosSpotCutoff,","                              float ShadowTechniquePCFSpotBlend,","                              float ShadowTechniquePCFAttenuation)","{","    vec3 L = ShadowTechniquePCFDirection;","    vec3 N = normal;","    float NdotL = max(dot(L, N), 0.0);","    float halfTerm = NdotL;","    vec4 ambient = ShadowTechniquePCFAmbient;","    vec4 diffuse = vec4(0.0);","    vec4 specular = vec4(0.0);","    float spot = 0.0;","","    if (NdotL > 0.0) {","        vec3 E = eye;","        vec3 R = reflect(-L, N);","        float RdotE = max(dot(R, E), 0.0);","        if ( RdotE > 0.0) {","           RdotE = pow( RdotE, materialShininess );","        }","        vec3 D = ShadowTechniquePCFSpotDirection;","        spot = 1.0;","        if (ShadowTechniquePCFCosSpotCutoff > 0.0) {","          float cosCurAngle = dot(-L, D);","          if (cosCurAngle < ShadowTechniquePCFCosSpotCutoff) {","             spot = 0.0;","          } else {","             if (ShadowTechniquePCFSpotBlend > 0.0)","               spot = cosCurAngle * smoothstep(0.0, 1.0, (cosCurAngle-ShadowTechniquePCFCosSpotCutoff)/(ShadowTechniquePCFSpotBlend));","          }","        }","        diffuse = ShadowTechniquePCFDiffuse * ((halfTerm));","        specular = ShadowTechniquePCFSpecular * RdotE;","    }","","    return (materialAmbient*ambient + (materialDiffuse*diffuse + materialSpecular*specular) * spot) * ShadowTechniquePCFAttenuation;","}","float linearrgb_to_srgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.0031308) {","    if ( c > 0.0)","      v = c * 12.92;","  } else {","    v = 1.055 * pow(c, 1.0/2.4) - 0.055;","  }","  return v;","}","vec4 linearrgb_to_srgb(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = linearrgb_to_srgb1(col_from.r);","  col_to.g = linearrgb_to_srgb1(col_from.g);","  col_to.b = linearrgb_to_srgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}","float srgb_to_linearrgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.04045) {","    if (c >= 0.0)","      v = c * (1.0/12.92);","  } else {","    v = pow((c + 0.055)*(1.0/1.055), 2.4);","  }"," return v;","}","vec4 srgb2linear(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = srgb_to_linearrgb1(col_from.r);","  col_to.g = srgb_to_linearrgb1(col_from.g);","  col_to.b = srgb_to_linearrgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}",""].join("\n")},osg.ShadowTechniquePCF.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentMain]=function(){return["","  vec3 normal = normalize(FragNormal);","  vec3 eyeVector = normalize(-FragEyeVector);","  vec4 ShadowTechniquePCFColor = MaterialEmission;",""].join("\n")},osg.ShadowTechniquePCF.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentEnd]=function(){return["","  fragColor *= ShadowTechniquePCFColor;",""].join("\n")},osg.ShadowTechniquePCF.prototype._shader[osg.ShaderGeneratorType.FragmentInit]=function(){var t=["","uniform vec4 ShadowTechniquePCF_position;","uniform vec3 ShadowTechniquePCF_direction;","uniform mat4 ShadowTechniquePCF_matrix;","uniform mat4 ShadowTechniquePCF_invMatrix;","uniform float ShadowTechniquePCF_constantAttenuation;","uniform float ShadowTechniquePCF_linearAttenuation;","uniform float ShadowTechniquePCF_quadraticAttenuation;","uniform vec4 ShadowTechniquePCF_ambient;","uniform vec4 ShadowTechniquePCF_diffuse;","uniform vec4 ShadowTechniquePCF_specular;","uniform float ShadowTechniquePCF_spotCutoff;","uniform float ShadowTechniquePCF_spotBlend;",""].join("\n");return uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("ShadowTechniquePCF_",uniforms,t,this.getUniformName)},osg.ShadowTechniquePCF.prototype._shader[osg.ShaderGeneratorType.FragmentMain]=function(){var t=["","  vec3 ShadowTechniquePCFEye = vec3(ShadowTechniquePCF_matrix * ShadowTechniquePCF_position);","  vec3 ShadowTechniquePCFDir;","  if (ShadowTechniquePCF_position[3] == 1.0) {","    ShadowTechniquePCFDir = ShadowTechniquePCFEye - FragEyeVector;","  } else {","    ShadowTechniquePCFDir = ShadowTechniquePCFEye;","  }","  vec3 spotDirection = normalize(mat3(vec3(ShadowTechniquePCF_invMatrix[0]), vec3(ShadowTechniquePCF_invMatrix[1]), vec3(ShadowTechniquePCF_invMatrix[2]))*ShadowTechniquePCF_direction);","  float attenuation = getShadowTechniquePCFAttenuation(ShadowTechniquePCFDir, ShadowTechniquePCF_constantAttenuation, ShadowTechniquePCF_linearAttenuation, ShadowTechniquePCF_quadraticAttenuation);","  ShadowTechniquePCFDir = normalize(ShadowTechniquePCFDir);","  ShadowTechniquePCFColor += computeShadowTechniquePCFContribution(MaterialAmbient,","                                         MaterialDiffuse, ","                                         MaterialSpecular,","                                         MaterialShininess,","                                         ShadowTechniquePCF_ambient,","                                         ShadowTechniquePCF_diffuse,","                                         ShadowTechniquePCF_specular,","                                         normal,","                                         eyeVector,","                                         ShadowTechniquePCFDir,","                                         spotDirection,","                                         ShadowTechniquePCF_spotCutoff,","                                         ShadowTechniquePCF_spotBlend,","                                         attenuation);",""].join("\n"),e=["ShadowTechniquePCFEye","ShadowTechniquePCFDir","spotDirection","attenuation"];return t=this._replace("",e,t,this.getParameterName),uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("ShadowTechniquePCF_",uniforms,t,this.getUniformName)},osg.ShadowTechniqueVSM=function(t){osg.StateAttribute.call(this),void 0===t&&(t=0),this._position=[0,0,1,0],this._direction=[0,0,-1],this._ShadowTechniqueVSMUnit=t,this._enabled=0,this.dirty()},osg.ShadowTechniqueVSM.uniforms={},osg.ShadowTechniqueVSM.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"ShadowTechniqueVSM",cloneType:function(){return new osg.ShadowTechniqueVSM(this._ShadowTechniqueVSMUnit)},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType+this._ShadowTechniqueVSMUnit},getOrCreateUniforms:function(){var t=osg.ShadowTechniqueVSM.uniforms,e=this.getTypeMember();if(void 0===t[e]){var r=osg.Uniform;t[e]={enable:r.createInt1(0,this.getUniformName("enable")),matrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("matrix")),invMatrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("invMatrix"))},t[e].uniformKeys=Object.keys(t[e])
}return t[e]},setPosition:function(t){osg.Vec4.copy(t,this._position)},getPosition:function(){return this._position},setDirection:function(t){this._direction=t,this.dirty()},getDirection:function(){return this._direction},setShadowTechniqueVSMNumber:function(t){this._ShadowTechniqueVSMUnit=t,this.dirty()},getShadowTechniqueVSMNumber:function(){return this._ShadowTechniqueVSMUnit},getPrefix:function(){return this.getType()+this._ShadowTechniqueVSMUnit},getParameterName:function(t){return this.getPrefix()+"_"+t},getUniformName:function(t){return this.getPrefix()+"_uniform_"+t},applyPositionedUniform:function(t){var e=this.getOrCreateUniforms();osg.Matrix.copy(t,e.matrix.get()),e.matrix.dirty(),osg.Matrix.copy(t,e.invMatrix.get()),e.invMatrix.get()[12]=0,e.invMatrix.get()[13]=0,e.invMatrix.get()[14]=0,osg.Matrix.inverse(e.invMatrix.get(),e.invMatrix.get()),osg.Matrix.transpose(e.invMatrix.get(),e.invMatrix.get()),e.invMatrix.dirty()},apply:function(){this.getOrCreateUniforms(),this.setDirty(!1)},_replace:function(t,e,r,i){for(var o=0,n=e.length;n>o;o++){var a=RegExp(t+e[o],"g");r=r.replace(a,i.call(this,e[o]))}return r},_shader:{},_shaderCommon:{},generateShader:function(t){return this._shader[t]?this._shader[t].call(this):""},generateShaderCommon:function(t){return this._shaderCommon[t]?this._shaderCommon[t].call(this):""}}),"osg","ShadowTechniqueVSM"),osg.ShadowTechniqueVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexInit]=function(){return["","varying vec3 FragNormal;","varying vec3 FragEyeVector;","",""].join("\n")},osg.ShadowTechniqueVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexFunction]=function(){return["","vec3 computeNormal() {","   return vec3(NormalMatrix * vec4(Normal, 0.0));","}","","vec3 computeEyeVertex() {","   return vec3(ModelViewMatrix * vec4(Vertex,1.0));","}","",""].join("\n")},osg.ShadowTechniqueVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexMain]=function(){return["","  FragEyeVector = computeEyeVertex();","  FragNormal = computeNormal();",""].join("\n")},osg.ShadowTechniqueVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentInit]=function(){return["varying vec3 FragNormal;","varying vec3 FragEyeVector;",""].join("\n")},osg.ShadowTechniqueVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentFunction]=function(){return["","float getShadowTechniqueVSMAttenuation(vec3 ShadowTechniqueVSMDir, float constant, float linear, float quadratic) {","    ","    float d = length(ShadowTechniqueVSMDir);","    float att = 1.0 / ( constant + linear*d + quadratic*d*d);","    return att;","}","vec4 computeShadowTechniqueVSMContribution(vec4 materialAmbient,","                              vec4 materialDiffuse,","                              vec4 materialSpecular,","                              float materialShininess,","                              vec4 ShadowTechniqueVSMAmbient,","                              vec4 ShadowTechniqueVSMDiffuse,","                              vec4 ShadowTechniqueVSMSpecular,","                              vec3 normal,","                              vec3 eye,","                              vec3 ShadowTechniqueVSMDirection,","                              vec3 ShadowTechniqueVSMSpotDirection,","                              float ShadowTechniqueVSMCosSpotCutoff,","                              float ShadowTechniqueVSMSpotBlend,","                              float ShadowTechniqueVSMAttenuation)","{","    vec3 L = ShadowTechniqueVSMDirection;","    vec3 N = normal;","    float NdotL = max(dot(L, N), 0.0);","    float halfTerm = NdotL;","    vec4 ambient = ShadowTechniqueVSMAmbient;","    vec4 diffuse = vec4(0.0);","    vec4 specular = vec4(0.0);","    float spot = 0.0;","","    if (NdotL > 0.0) {","        vec3 E = eye;","        vec3 R = reflect(-L, N);","        float RdotE = max(dot(R, E), 0.0);","        if ( RdotE > 0.0) {","           RdotE = pow( RdotE, materialShininess );","        }","        vec3 D = ShadowTechniqueVSMSpotDirection;","        spot = 1.0;","        if (ShadowTechniqueVSMCosSpotCutoff > 0.0) {","          float cosCurAngle = dot(-L, D);","          if (cosCurAngle < ShadowTechniqueVSMCosSpotCutoff) {","             spot = 0.0;","          } else {","             if (ShadowTechniqueVSMSpotBlend > 0.0)","               spot = cosCurAngle * smoothstep(0.0, 1.0, (cosCurAngle-ShadowTechniqueVSMCosSpotCutoff)/(ShadowTechniqueVSMSpotBlend));","          }","        }","        diffuse = ShadowTechniqueVSMDiffuse * ((halfTerm));","        specular = ShadowTechniqueVSMSpecular * RdotE;","    }","","    return (materialAmbient*ambient + (materialDiffuse*diffuse + materialSpecular*specular) * spot) * ShadowTechniqueVSMAttenuation;","}","float linearrgb_to_srgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.0031308) {","    if ( c > 0.0)","      v = c * 12.92;","  } else {","    v = 1.055 * pow(c, 1.0/2.4) - 0.055;","  }","  return v;","}","vec4 linearrgb_to_srgb(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = linearrgb_to_srgb1(col_from.r);","  col_to.g = linearrgb_to_srgb1(col_from.g);","  col_to.b = linearrgb_to_srgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}","float srgb_to_linearrgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.04045) {","    if (c >= 0.0)","      v = c * (1.0/12.92);","  } else {","    v = pow((c + 0.055)*(1.0/1.055), 2.4);","  }"," return v;","}","vec4 srgb2linear(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = srgb_to_linearrgb1(col_from.r);","  col_to.g = srgb_to_linearrgb1(col_from.g);","  col_to.b = srgb_to_linearrgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}",""].join("\n")},osg.ShadowTechniqueVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentMain]=function(){return["","  vec3 normal = normalize(FragNormal);","  vec3 eyeVector = normalize(-FragEyeVector);","  vec4 ShadowTechniqueVSMColor = MaterialEmission;",""].join("\n")},osg.ShadowTechniqueVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentEnd]=function(){return["","  fragColor *= ShadowTechniqueVSMColor;",""].join("\n")},osg.ShadowTechniqueVSM.prototype._shader[osg.ShaderGeneratorType.FragmentInit]=function(){var t=["","uniform vec4 ShadowTechniqueVSM_position;","uniform vec3 ShadowTechniqueVSM_direction;","uniform mat4 ShadowTechniqueVSM_matrix;","uniform mat4 ShadowTechniqueVSM_invMatrix;","uniform float ShadowTechniqueVSM_constantAttenuation;","uniform float ShadowTechniqueVSM_linearAttenuation;","uniform float ShadowTechniqueVSM_quadraticAttenuation;","uniform vec4 ShadowTechniqueVSM_ambient;","uniform vec4 ShadowTechniqueVSM_diffuse;","uniform vec4 ShadowTechniqueVSM_specular;","uniform float ShadowTechniqueVSM_spotCutoff;","uniform float ShadowTechniqueVSM_spotBlend;",""].join("\n");return uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("ShadowTechniqueVSM_",uniforms,t,this.getUniformName)},osg.ShadowTechniqueVSM.prototype._shader[osg.ShaderGeneratorType.FragmentMain]=function(){var t=["","  vec3 ShadowTechniqueVSMEye = vec3(ShadowTechniqueVSM_matrix * ShadowTechniqueVSM_position);","  vec3 ShadowTechniqueVSMDir;","  if (ShadowTechniqueVSM_position[3] == 1.0) {","    ShadowTechniqueVSMDir = ShadowTechniqueVSMEye - FragEyeVector;","  } else {","    ShadowTechniqueVSMDir = ShadowTechniqueVSMEye;","  }","  vec3 spotDirection = normalize(mat3(vec3(ShadowTechniqueVSM_invMatrix[0]), vec3(ShadowTechniqueVSM_invMatrix[1]), vec3(ShadowTechniqueVSM_invMatrix[2]))*ShadowTechniqueVSM_direction);","  float attenuation = getShadowTechniqueVSMAttenuation(ShadowTechniqueVSMDir, ShadowTechniqueVSM_constantAttenuation, ShadowTechniqueVSM_linearAttenuation, ShadowTechniqueVSM_quadraticAttenuation);","  ShadowTechniqueVSMDir = normalize(ShadowTechniqueVSMDir);","  ShadowTechniqueVSMColor += computeShadowTechniqueVSMContribution(MaterialAmbient,","                                         MaterialDiffuse, ","                                         MaterialSpecular,","                                         MaterialShininess,","                                         ShadowTechniqueVSM_ambient,","                                         ShadowTechniqueVSM_diffuse,","                                         ShadowTechniqueVSM_specular,","                                         normal,","                                         eyeVector,","                                         ShadowTechniqueVSMDir,","                                         spotDirection,","                                         ShadowTechniqueVSM_spotCutoff,","                                         ShadowTechniqueVSM_spotBlend,","                                         attenuation);",""].join("\n"),e=["ShadowTechniqueVSMEye","ShadowTechniqueVSMDir","spotDirection","attenuation"];return t=this._replace("",e,t,this.getParameterName),uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("ShadowTechniqueVSM_",uniforms,t,this.getUniformName)},osg.ShadowTechniqueEVSM=function(t){osg.StateAttribute.call(this),void 0===t&&(t=0),this._position=[0,0,1,0],this._direction=[0,0,-1],this._ShadowTechniqueEVSMUnit=t,this._enabled=0,this.dirty()},osg.ShadowTechniqueEVSM.uniforms={},osg.ShadowTechniqueEVSM.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"ShadowTechniqueEVSM",cloneType:function(){return new osg.ShadowTechniqueEVSM(this._ShadowTechniqueEVSMUnit)},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType+this._ShadowTechniqueEVSMUnit},getOrCreateUniforms:function(){var t=osg.ShadowTechniqueEVSM.uniforms,e=this.getTypeMember();if(void 0===t[e]){var r=osg.Uniform;t[e]={enable:r.createInt1(0,this.getUniformName("enable")),matrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("matrix")),invMatrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("invMatrix"))},t[e].uniformKeys=Object.keys(t[e])}return t[e]},setPosition:function(t){osg.Vec4.copy(t,this._position)},getPosition:function(){return this._position},setDirection:function(t){this._direction=t,this.dirty()},getDirection:function(){return this._direction},setShadowTechniqueEVSMNumber:function(t){this._ShadowTechniqueEVSMUnit=t,this.dirty()},getShadowTechniqueEVSMNumber:function(){return this._ShadowTechniqueEVSMUnit},getPrefix:function(){return this.getType()+this._ShadowTechniqueEVSMUnit},getParameterName:function(t){return this.getPrefix()+"_"+t},getUniformName:function(t){return this.getPrefix()+"_uniform_"+t},applyPositionedUniform:function(t){var e=this.getOrCreateUniforms();osg.Matrix.copy(t,e.matrix.get()),e.matrix.dirty(),osg.Matrix.copy(t,e.invMatrix.get()),e.invMatrix.get()[12]=0,e.invMatrix.get()[13]=0,e.invMatrix.get()[14]=0,osg.Matrix.inverse(e.invMatrix.get(),e.invMatrix.get()),osg.Matrix.transpose(e.invMatrix.get(),e.invMatrix.get()),e.invMatrix.dirty()},apply:function(){this.getOrCreateUniforms(),this.setDirty(!1)},_replace:function(t,e,r,i){for(var o=0,n=e.length;n>o;o++){var a=RegExp(t+e[o],"g");r=r.replace(a,i.call(this,e[o]))}return r},_shader:{},_shaderCommon:{},generateShader:function(t){return this._shader[t]?this._shader[t].call(this):""},generateShaderCommon:function(t){return this._shaderCommon[t]?this._shaderCommon[t].call(this):""}}),"osg","ShadowTechniqueEVSM"),osg.ShadowTechniqueEVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexInit]=function(){return["","varying vec3 FragNormal;","varying vec3 FragEyeVector;","",""].join("\n")},osg.ShadowTechniqueEVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexFunction]=function(){return["","vec3 computeNormal() {","   return vec3(NormalMatrix * vec4(Normal, 0.0));","}","","vec3 computeEyeVertex() {","   return vec3(ModelViewMatrix * vec4(Vertex,1.0));","}","",""].join("\n")},osg.ShadowTechniqueEVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexMain]=function(){return["","  FragEyeVector = computeEyeVertex();","  FragNormal = computeNormal();",""].join("\n")},osg.ShadowTechniqueEVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentInit]=function(){return["varying vec3 FragNormal;","varying vec3 FragEyeVector;",""].join("\n")},osg.ShadowTechniqueEVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentFunction]=function(){return["","float getShadowTechniqueEVSMAttenuation(vec3 ShadowTechniqueEVSMDir, float constant, float linear, float quadratic) {","    ","    float d = length(ShadowTechniqueEVSMDir);","    float att = 1.0 / ( constant + linear*d + quadratic*d*d);","    return att;","}","vec4 computeShadowTechniqueEVSMContribution(vec4 materialAmbient,","                              vec4 materialDiffuse,","                              vec4 materialSpecular,","                              float materialShininess,","                              vec4 ShadowTechniqueEVSMAmbient,","                              vec4 ShadowTechniqueEVSMDiffuse,","                              vec4 ShadowTechniqueEVSMSpecular,","                              vec3 normal,","                              vec3 eye,","                              vec3 ShadowTechniqueEVSMDirection,","                              vec3 ShadowTechniqueEVSMSpotDirection,","                              float ShadowTechniqueEVSMCosSpotCutoff,","                              float ShadowTechniqueEVSMSpotBlend,","                              float ShadowTechniqueEVSMAttenuation)","{","    vec3 L = ShadowTechniqueEVSMDirection;","    vec3 N = normal;","    float NdotL = max(dot(L, N), 0.0);","    float halfTerm = NdotL;","    vec4 ambient = ShadowTechniqueEVSMAmbient;","    vec4 diffuse = vec4(0.0);","    vec4 specular = vec4(0.0);","    float spot = 0.0;","","    if (NdotL > 0.0) {","        vec3 E = eye;","        vec3 R = reflect(-L, N);","        float RdotE = max(dot(R, E), 0.0);","        if ( RdotE > 0.0) {","           RdotE = pow( RdotE, materialShininess );","        }","        vec3 D = ShadowTechniqueEVSMSpotDirection;","        spot = 1.0;","        if (ShadowTechniqueEVSMCosSpotCutoff > 0.0) {","          float cosCurAngle = dot(-L, D);","          if (cosCurAngle < ShadowTechniqueEVSMCosSpotCutoff) {","             spot = 0.0;","          } else {","             if (ShadowTechniqueEVSMSpotBlend > 0.0)","               spot = cosCurAngle * smoothstep(0.0, 1.0, (cosCurAngle-ShadowTechniqueEVSMCosSpotCutoff)/(ShadowTechniqueEVSMSpotBlend));","          }","        }","        diffuse = ShadowTechniqueEVSMDiffuse * ((halfTerm));","        specular = ShadowTechniqueEVSMSpecular * RdotE;","    }","","    return (materialAmbient*ambient + (materialDiffuse*diffuse + materialSpecular*specular) * spot) * ShadowTechniqueEVSMAttenuation;","}","float linearrgb_to_srgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.0031308) {","    if ( c > 0.0)","      v = c * 12.92;","  } else {","    v = 1.055 * pow(c, 1.0/2.4) - 0.055;","  }","  return v;","}","vec4 linearrgb_to_srgb(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = linearrgb_to_srgb1(col_from.r);","  col_to.g = linearrgb_to_srgb1(col_from.g);","  col_to.b = linearrgb_to_srgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}","float srgb_to_linearrgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.04045) {","    if (c >= 0.0)","      v = c * (1.0/12.92);","  } else {","    v = pow((c + 0.055)*(1.0/1.055), 2.4);","  }"," return v;","}","vec4 srgb2linear(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = srgb_to_linearrgb1(col_from.r);","  col_to.g = srgb_to_linearrgb1(col_from.g);","  col_to.b = srgb_to_linearrgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}",""].join("\n")},osg.ShadowTechniqueEVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentMain]=function(){return["","  vec3 normal = normalize(FragNormal);","  vec3 eyeVector = normalize(-FragEyeVector);","  vec4 ShadowTechniqueEVSMColor = MaterialEmission;",""].join("\n")},osg.ShadowTechniqueEVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentEnd]=function(){return["","  fragColor *= ShadowTechniqueEVSMColor;",""].join("\n")},osg.ShadowTechniqueEVSM.prototype._shader[osg.ShaderGeneratorType.FragmentInit]=function(){var t=["","uniform vec4 ShadowTechniqueEVSM_position;","uniform vec3 ShadowTechniqueEVSM_direction;","uniform mat4 ShadowTechniqueEVSM_matrix;","uniform mat4 ShadowTechniqueEVSM_invMatrix;","uniform float ShadowTechniqueEVSM_constantAttenuation;","uniform float ShadowTechniqueEVSM_linearAttenuation;","uniform float ShadowTechniqueEVSM_quadraticAttenuation;","uniform vec4 ShadowTechniqueEVSM_ambient;","uniform vec4 ShadowTechniqueEVSM_diffuse;","uniform vec4 ShadowTechniqueEVSM_specular;","uniform float ShadowTechniqueEVSM_spotCutoff;","uniform float ShadowTechniqueEVSM_spotBlend;",""].join("\n");return uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("ShadowTechniqueEVSM_",uniforms,t,this.getUniformName)},osg.ShadowTechniqueEVSM.prototype._shader[osg.ShaderGeneratorType.FragmentMain]=function(){var t=["","  vec3 ShadowTechniqueEVSMEye = vec3(ShadowTechniqueEVSM_matrix * ShadowTechniqueEVSM_position);","  vec3 ShadowTechniqueEVSMDir;","  if (ShadowTechniqueEVSM_position[3] == 1.0) {","    ShadowTechniqueEVSMDir = ShadowTechniqueEVSMEye - FragEyeVector;","  } else {","    ShadowTechniqueEVSMDir = ShadowTechniqueEVSMEye;","  }","  vec3 spotDirection = normalize(mat3(vec3(ShadowTechniqueEVSM_invMatrix[0]), vec3(ShadowTechniqueEVSM_invMatrix[1]), vec3(ShadowTechniqueEVSM_invMatrix[2]))*ShadowTechniqueEVSM_direction);","  float attenuation = getShadowTechniqueEVSMAttenuation(ShadowTechniqueEVSMDir, ShadowTechniqueEVSM_constantAttenuation, ShadowTechniqueEVSM_linearAttenuation, ShadowTechniqueEVSM_quadraticAttenuation);","  ShadowTechniqueEVSMDir = normalize(ShadowTechniqueEVSMDir);","  ShadowTechniqueEVSMColor += computeShadowTechniqueEVSMContribution(MaterialAmbient,","                                         MaterialDiffuse, ","                                         MaterialSpecular,","                                         MaterialShininess,","                                         ShadowTechniqueEVSM_ambient,","                                         ShadowTechniqueEVSM_diffuse,","                                         ShadowTechniqueEVSM_specular,","                                         normal,","                                         eyeVector,","                                         ShadowTechniqueEVSMDir,","                                         spotDirection,","                                         ShadowTechniqueEVSM_spotCutoff,","                                         ShadowTechniqueEVSM_spotBlend,","                                         attenuation);",""].join("\n"),e=["ShadowTechniqueEVSMEye","ShadowTechniqueEVSMDir","spotDirection","attenuation"];return t=this._replace("",e,t,this.getParameterName),uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("ShadowTechniqueEVSM_",uniforms,t,this.getUniformName)},osg.ShadowTechniqueCVSM=function(t){osg.StateAttribute.call(this),void 0===t&&(t=0),this._position=[0,0,1,0],this._direction=[0,0,-1],this._ShadowTechniqueCVSMUnit=t,this._enabled=0,this.dirty()},osg.ShadowTechniqueCVSM.uniforms={},osg.ShadowTechniqueCVSM.prototype=osg.objectLibraryClass(osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"ShadowTechniqueCVSM",cloneType:function(){return new osg.ShadowTechniqueCVSM(this._ShadowTechniqueCVSMUnit)},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType+this._ShadowTechniqueCVSMUnit},getOrCreateUniforms:function(){var t=osg.ShadowTechniqueCVSM.uniforms,e=this.getTypeMember();if(void 0===t[e]){var r=osg.Uniform;t[e]={enable:r.createInt1(0,this.getUniformName("enable")),matrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("matrix")),invMatrix:r.createMatrix4(osg.Matrix.makeIdentity([]),this.getUniformName("invMatrix"))},t[e].uniformKeys=Object.keys(t[e])}return t[e]},setPosition:function(t){osg.Vec4.copy(t,this._position)},getPosition:function(){return this._position},setDirection:function(t){this._direction=t,this.dirty()},getDirection:function(){return this._direction},setShadowTechniqueCVSMNumber:function(t){this._ShadowTechniqueCVSMUnit=t,this.dirty()},getShadowTechniqueCVSMNumber:function(){return this._ShadowTechniqueCVSMUnit},getPrefix:function(){return this.getType()+this._ShadowTechniqueCVSMUnit},getParameterName:function(t){return this.getPrefix()+"_"+t},getUniformName:function(t){return this.getPrefix()+"_uniform_"+t},applyPositionedUniform:function(t){var e=this.getOrCreateUniforms();osg.Matrix.copy(t,e.matrix.get()),e.matrix.dirty(),osg.Matrix.copy(t,e.invMatrix.get()),e.invMatrix.get()[12]=0,e.invMatrix.get()[13]=0,e.invMatrix.get()[14]=0,osg.Matrix.inverse(e.invMatrix.get(),e.invMatrix.get()),osg.Matrix.transpose(e.invMatrix.get(),e.invMatrix.get()),e.invMatrix.dirty()},apply:function(){this.getOrCreateUniforms(),this.setDirty(!1)},_replace:function(t,e,r,i){for(var o=0,n=e.length;n>o;o++){var a=RegExp(t+e[o],"g");r=r.replace(a,i.call(this,e[o]))}return r},_shader:{},_shaderCommon:{},generateShader:function(t){return this._shader[t]?this._shader[t].call(this):""},generateShaderCommon:function(t){return this._shaderCommon[t]?this._shaderCommon[t].call(this):""}}),"osg","ShadowTechniqueCVSM"),osg.ShadowTechniqueCVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexInit]=function(){return["","varying vec3 FragNormal;","varying vec3 FragEyeVector;","",""].join("\n")},osg.ShadowTechniqueCVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexFunction]=function(){return["","vec3 computeNormal() {","   return vec3(NormalMatrix * vec4(Normal, 0.0));","}","","vec3 computeEyeVertex() {","   return vec3(ModelViewMatrix * vec4(Vertex,1.0));","}","",""].join("\n")},osg.ShadowTechniqueCVSM.prototype._shaderCommon[osg.ShaderGeneratorType.VertexMain]=function(){return["","  FragEyeVector = computeEyeVertex();","  FragNormal = computeNormal();",""].join("\n")},osg.ShadowTechniqueCVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentInit]=function(){return["varying vec3 FragNormal;","varying vec3 FragEyeVector;",""].join("\n")},osg.ShadowTechniqueCVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentFunction]=function(){return["","float getShadowTechniqueCVSMAttenuation(vec3 ShadowTechniqueCVSMDir, float constant, float linear, float quadratic) {","    ","    float d = length(ShadowTechniqueCVSMDir);","    float att = 1.0 / ( constant + linear*d + quadratic*d*d);","    return att;","}","vec4 computeShadowTechniqueCVSMContribution(vec4 materialAmbient,","                              vec4 materialDiffuse,","                              vec4 materialSpecular,","                              float materialShininess,","                              vec4 ShadowTechniqueCVSMAmbient,","                              vec4 ShadowTechniqueCVSMDiffuse,","                              vec4 ShadowTechniqueCVSMSpecular,","                              vec3 normal,","                              vec3 eye,","                              vec3 ShadowTechniqueCVSMDirection,","                              vec3 ShadowTechniqueCVSMSpotDirection,","                              float ShadowTechniqueCVSMCosSpotCutoff,","                              float ShadowTechniqueCVSMSpotBlend,","                              float ShadowTechniqueCVSMAttenuation)","{","    vec3 L = ShadowTechniqueCVSMDirection;","    vec3 N = normal;","    float NdotL = max(dot(L, N), 0.0);","    float halfTerm = NdotL;","    vec4 ambient = ShadowTechniqueCVSMAmbient;","    vec4 diffuse = vec4(0.0);","    vec4 specular = vec4(0.0);","    float spot = 0.0;","","    if (NdotL > 0.0) {","        vec3 E = eye;","        vec3 R = reflect(-L, N);","        float RdotE = max(dot(R, E), 0.0);","        if ( RdotE > 0.0) {","           RdotE = pow( RdotE, materialShininess );","        }","        vec3 D = ShadowTechniqueCVSMSpotDirection;","        spot = 1.0;","        if (ShadowTechniqueCVSMCosSpotCutoff > 0.0) {","          float cosCurAngle = dot(-L, D);","          if (cosCurAngle < ShadowTechniqueCVSMCosSpotCutoff) {","             spot = 0.0;","          } else {","             if (ShadowTechniqueCVSMSpotBlend > 0.0)","               spot = cosCurAngle * smoothstep(0.0, 1.0, (cosCurAngle-ShadowTechniqueCVSMCosSpotCutoff)/(ShadowTechniqueCVSMSpotBlend));","          }","        }","        diffuse = ShadowTechniqueCVSMDiffuse * ((halfTerm));","        specular = ShadowTechniqueCVSMSpecular * RdotE;","    }","","    return (materialAmbient*ambient + (materialDiffuse*diffuse + materialSpecular*specular) * spot) * ShadowTechniqueCVSMAttenuation;","}","float linearrgb_to_srgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.0031308) {","    if ( c > 0.0)","      v = c * 12.92;","  } else {","    v = 1.055 * pow(c, 1.0/2.4) - 0.055;","  }","  return v;","}","vec4 linearrgb_to_srgb(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = linearrgb_to_srgb1(col_from.r);","  col_to.g = linearrgb_to_srgb1(col_from.g);","  col_to.b = linearrgb_to_srgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}","float srgb_to_linearrgb1(const in float c)","{","  float v = 0.0;","  if(c < 0.04045) {","    if (c >= 0.0)","      v = c * (1.0/12.92);","  } else {","    v = pow((c + 0.055)*(1.0/1.055), 2.4);","  }"," return v;","}","vec4 srgb2linear(const in vec4 col_from)","{","  vec4 col_to;","  col_to.r = srgb_to_linearrgb1(col_from.r);","  col_to.g = srgb_to_linearrgb1(col_from.g);","  col_to.b = srgb_to_linearrgb1(col_from.b);","  col_to.a = col_from.a;","  return col_to;","}",""].join("\n")},osg.ShadowTechniqueCVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentMain]=function(){return["","  vec3 normal = normalize(FragNormal);","  vec3 eyeVector = normalize(-FragEyeVector);","  vec4 ShadowTechniqueCVSMColor = MaterialEmission;",""].join("\n")},osg.ShadowTechniqueCVSM.prototype._shaderCommon[osg.ShaderGeneratorType.FragmentEnd]=function(){return["","  fragColor *= ShadowTechniqueCVSMColor;",""].join("\n")},osg.ShadowTechniqueCVSM.prototype._shader[osg.ShaderGeneratorType.FragmentInit]=function(){var t=["","uniform vec4 ShadowTechniqueCVSM_position;","uniform vec3 ShadowTechniqueCVSM_direction;","uniform mat4 ShadowTechniqueCVSM_matrix;","uniform mat4 ShadowTechniqueCVSM_invMatrix;","uniform float ShadowTechniqueCVSM_constantAttenuation;","uniform float ShadowTechniqueCVSM_linearAttenuation;","uniform float ShadowTechniqueCVSM_quadraticAttenuation;","uniform vec4 ShadowTechniqueCVSM_ambient;","uniform vec4 ShadowTechniqueCVSM_diffuse;","uniform vec4 ShadowTechniqueCVSM_specular;","uniform float ShadowTechniqueCVSM_spotCutoff;","uniform float ShadowTechniqueCVSM_spotBlend;",""].join("\n");return uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("ShadowTechniqueCVSM_",uniforms,t,this.getUniformName)},osg.ShadowTechniqueCVSM.prototype._shader[osg.ShaderGeneratorType.FragmentMain]=function(){var t=["","  vec3 ShadowTechniqueCVSMEye = vec3(ShadowTechniqueCVSM_matrix * ShadowTechniqueCVSM_position);","  vec3 ShadowTechniqueCVSMDir;","  if (ShadowTechniqueCVSM_position[3] == 1.0) {","    ShadowTechniqueCVSMDir = ShadowTechniqueCVSMEye - FragEyeVector;","  } else {","    ShadowTechniqueCVSMDir = ShadowTechniqueCVSMEye;","  }","  vec3 spotDirection = normalize(mat3(vec3(ShadowTechniqueCVSM_invMatrix[0]), vec3(ShadowTechniqueCVSM_invMatrix[1]), vec3(ShadowTechniqueCVSM_invMatrix[2]))*ShadowTechniqueCVSM_direction);","  float attenuation = getShadowTechniqueCVSMAttenuation(ShadowTechniqueCVSMDir, ShadowTechniqueCVSM_constantAttenuation, ShadowTechniqueCVSM_linearAttenuation, ShadowTechniqueCVSM_quadraticAttenuation);","  ShadowTechniqueCVSMDir = normalize(ShadowTechniqueCVSMDir);","  ShadowTechniqueCVSMColor += computeShadowTechniqueCVSMContribution(MaterialAmbient,","                                         MaterialDiffuse, ","                                         MaterialSpecular,","                                         MaterialShininess,","                                         ShadowTechniqueCVSM_ambient,","                                         ShadowTechniqueCVSM_diffuse,","                                         ShadowTechniqueCVSM_specular,","                                         normal,","                                         eyeVector,","                                         ShadowTechniqueCVSMDir,","                                         spotDirection,","                                         ShadowTechniqueCVSM_spotCutoff,","                                         ShadowTechniqueCVSM_spotBlend,","                                         attenuation);",""].join("\n"),e=["ShadowTechniqueCVSMEye","ShadowTechniqueCVSMDir","spotDirection","attenuation"];return t=this._replace("",e,t,this.getParameterName),uniforms=Object.keys(this.getOrCreateUniforms()),t=this._replace("ShadowTechniqueCVSM_",uniforms,t,this.getUniformName)};
//@ sourceMappingURL=build/source-map.js
return osg;});